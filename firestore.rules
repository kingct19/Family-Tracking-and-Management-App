rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isHubMember(hubId) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/hubs/$(hubId)/memberships/$(request.auth.uid));
    }
    
    function isHubAdmin(hubId) {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/hubs/$(hubId)/memberships/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isHubAdminOrMember(hubId) {
      let membership = get(/databases/$(database)/documents/hubs/$(hubId)/memberships/$(request.auth.uid)).data;
      return isAuthenticated() && 
        (membership.role == 'admin' || membership.role == 'member');
    }
    
    function isMembershipActive(hubId) {
      return get(/databases/$(database)/documents/hubs/$(hubId)/memberships/$(request.auth.uid)).data.status == 'active';
    }
    
    // Users collection
    match /users/{userId} {
      // Users can read their own profile
      allow read: if isUser(userId);
      
      // Users can update their own profile
      // Temporarily allow all updates to test - we'll add hubs restriction back later
      allow update: if isUser(userId);
      
      // User profiles are created during registration (system operation)
      allow create: if isUser(userId);
      
      // Private subcollection
      match /private/{document=**} {
        allow read, write: if isUser(userId);
      }
      
      // Settings subcollection (user preferences)
      match /settings/{settingId} {
        // Users can read and write their own settings
        allow read, write: if isUser(userId);
      }
    }
    
    // Hubs collection
    match /hubs/{hubId} {
      // Hub members can read hub details
      allow read: if isHubMember(hubId) && isMembershipActive(hubId);
      
      // Only admins can update hub details
      allow update: if isHubAdmin(hubId) && isMembershipActive(hubId);
      
      // Hub creation is allowed for authenticated users
      allow create: if isAuthenticated();
      
      // Only the hub creator (admin) can delete (if hub has no other members)
      allow delete: if isHubAdmin(hubId);
      
      // Memberships subcollection
      match /memberships/{memberUserId} {
        // Members can read all memberships in their hub
        allow read: if isHubMember(hubId) && isMembershipActive(hubId);
        
        // Allow creating membership if:
        // 1. User is creating their own membership AND they are the hub creator, OR
        // 2. User is already an admin of the hub
        allow create: if isAuthenticated() && (
          (isUser(memberUserId) && get(/databases/$(database)/documents/hubs/$(hubId)).data.createdBy == request.auth.uid) ||
          isHubAdmin(hubId)
        );
        
        // Admins can update memberships, users can update their own
        allow update: if isHubAdmin(hubId) || isUser(memberUserId);
        
        // Admins can delete memberships, users can delete their own
        allow delete: if isHubAdmin(hubId) || isUser(memberUserId);
      }
      
      // Tasks subcollection
      match /tasks/{taskId} {
        // All hub members can read tasks
        allow read: if isHubMember(hubId) && isMembershipActive(hubId);
        
        // Admins and members can create tasks
        allow create: if isHubAdminOrMember(hubId) && isMembershipActive(hubId);
        
        // Admins can update any task, members can only update tasks assigned to them
        allow update: if isMembershipActive(hubId) && (
          isHubAdmin(hubId) || 
          (isHubMember(hubId) && resource.data.assignedTo == request.auth.uid)
        );
        
        // Only admins can delete tasks
        allow delete: if isHubAdmin(hubId) && isMembershipActive(hubId);
      }
      
      // Messages subcollection
      match /messages/{messageId} {
        // All hub members can read messages
        allow read: if isHubMember(hubId) && isMembershipActive(hubId);
        
        // Members and admins can create messages
        allow create: if isHubAdminOrMember(hubId) && 
          isMembershipActive(hubId) &&
          request.resource.data.senderId == request.auth.uid;
        
        // Users can update their own messages (for read receipts)
        allow update: if isHubMember(hubId) && 
          isMembershipActive(hubId) &&
          resource.data.senderId == request.auth.uid;
        
        // Only admins and message owners can delete
        allow delete: if isMembershipActive(hubId) && (
          isHubAdmin(hubId) || 
          resource.data.senderId == request.auth.uid
        );
      }
      
      // Broadcasts subcollection
      match /broadcasts/{broadcastId} {
        // All hub members can read broadcasts
        allow read: if isHubMember(hubId) && isMembershipActive(hubId);
        
        // Only admins can create/update/delete broadcasts
        allow create, update, delete: if isHubAdmin(hubId) && isMembershipActive(hubId);
      }
      
      // Typing indicators subcollection
      match /typing/{userId} {
        // All hub members can read typing status
        allow read: if isHubMember(hubId) && isMembershipActive(hubId);
        
        // Users can only write their own typing status
        allow create, update, delete: if isUser(userId) && isHubMember(hubId) && isMembershipActive(hubId);
      }
      
      // Locations subcollection
      match /locations/{locationUserId} {
        // All hub members can read locations
        allow read: if isHubMember(hubId) && isMembershipActive(hubId);
        
        // Users can only write their own location
        allow create, update: if isUser(locationUserId) && 
          isHubMember(hubId) && 
          isMembershipActive(hubId);
        
        // Only admins can delete locations
        allow delete: if isHubAdmin(hubId);
      }
      
      // Location history subcollection (within user location)
      match /locations/{locationUserId}/history/{historyId} {
        // Users can read their own location history
        allow read: if isUser(locationUserId) && 
          isHubMember(hubId) && 
          isMembershipActive(hubId);
        
        // Users can create their own location history
        allow create: if isUser(locationUserId) && 
          isHubMember(hubId) && 
          isMembershipActive(hubId);
        
        // Location history cannot be updated (immutable)
        allow update: if false;
        
        // Only admins can delete location history (for cleanup)
        allow delete: if isHubAdmin(hubId);
      }
      
      // Check-ins subcollection
      match /checkIns/{checkInId} {
        // All hub members can read check-ins (for history)
        allow read: if isHubMember(hubId) && isMembershipActive(hubId);
        
        // Users can create their own check-ins
        allow create: if isHubAdminOrMember(hubId) && 
          isMembershipActive(hubId) &&
          request.resource.data.userId == request.auth.uid &&
          request.resource.data.hubId == hubId;
        
        // Users can update their own check-ins (e.g., to add notes)
        allow update: if isHubMember(hubId) && 
          isMembershipActive(hubId) &&
          resource.data.userId == request.auth.uid &&
          // Prevent changing userId or hubId
          request.resource.data.userId == resource.data.userId &&
          request.resource.data.hubId == resource.data.hubId;
        
        // Users can delete their own check-ins, admins can delete any
        allow delete: if isMembershipActive(hubId) && (
          (isHubMember(hubId) && resource.data.userId == request.auth.uid) ||
          isHubAdmin(hubId)
        );
      }
      
      // Geofences subcollection
      match /geofences/{geofenceId} {
        // All hub members can read geofences
        allow read: if isHubMember(hubId) && isMembershipActive(hubId);
        
        // Admins and members (parents) can create geofences
        allow create: if isHubAdminOrMember(hubId) && 
          isMembershipActive(hubId) &&
          request.resource.data.hubId == hubId &&
          request.resource.data.createdBy == request.auth.uid;
        
        // Admins can update/delete any geofence, members can update/delete their own
        allow update: if isMembershipActive(hubId) && (
          isHubAdmin(hubId) ||
          (isHubMember(hubId) && resource.data.createdBy == request.auth.uid)
        );
        
        allow delete: if isMembershipActive(hubId) && (
          isHubAdmin(hubId) ||
          (isHubMember(hubId) && resource.data.createdBy == request.auth.uid)
        );
      }
      
      // Geofence events subcollection
      match /geofenceEvents/{eventId} {
        // All hub members can read geofence events
        allow read: if isHubMember(hubId) && isMembershipActive(hubId);
        
        // System can create events (via Cloud Functions or client when user enters/exits)
        allow create: if isHubMember(hubId) && 
          isMembershipActive(hubId) &&
          request.resource.data.hubId == hubId;
        
        // Events are immutable (audit trail)
        allow update: if false;
        
        // Only admins can delete events (for cleanup)
        allow delete: if isHubAdmin(hubId);
      }
      
      // Geofence alerts subcollection
      match /geofenceAlerts/{alertId} {
        // All hub members can read alerts
        allow read: if isHubMember(hubId) && isMembershipActive(hubId);
        
        // System can create alerts (via Cloud Functions or client)
        allow create: if isHubMember(hubId) && 
          isMembershipActive(hubId) &&
          request.resource.data.hubId == hubId;
        
        // Users can update alerts to mark as read (only isRead and readAt fields)
        allow update: if isHubMember(hubId) && 
          isMembershipActive(hubId) &&
          // Ensure hubId doesn't change
          request.resource.data.hubId == resource.data.hubId &&
          // Ensure immutable fields don't change
          request.resource.data.userId == resource.data.userId &&
          request.resource.data.geofenceId == resource.data.geofenceId &&
          request.resource.data.eventType == resource.data.eventType &&
          request.resource.data.message == resource.data.message &&
          request.resource.data.geofenceName == resource.data.geofenceName &&
          request.resource.data.userName == resource.data.userName;
        
        // Only admins can delete alerts
        allow delete: if isHubAdmin(hubId);
      }
      
      // Policies subcollection
      match /policies/{policyId} {
        // All hub members can read policies
        allow read: if isHubMember(hubId) && isMembershipActive(hubId);
        
        // Only admins can update policies
        allow update: if isHubAdmin(hubId) && isMembershipActive(hubId);
      }
    }
    
    // XP Records collection
    match /xpRecords/{recordId} {
      // Users can read their own XP records
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // XP records are created by Cloud Functions (system)
      allow create: if false;
      
      // XP records cannot be modified or deleted
      allow update, delete: if false;
    }
    
    // Vault collection (user-specific, not hub-specific)
    match /vault/{userId} {
      // Only the owner can access their vault
      allow read, write: if isUser(userId);
      
      // Vault items subcollection
      match /items/{itemId} {
        // Only the owner can read/write their vault items
        allow read, write: if isUser(userId);
      }
    }
    
    // User tokens collection (for FCM push notifications)
    match /users/{userId}/tokens/{tokenId} {
      // Users can read/write their own FCM tokens
      allow read, write: if isUser(userId);
    }
    
    // Invites collection
    match /invites/{inviteCode} {
      // Anyone authenticated can read invites to validate them
      allow read: if isAuthenticated();
      
      // Only hub admins can create invites
      allow create: if isAuthenticated() && 
        isHubAdmin(request.resource.data.hubId);
      
      // Invites can be updated when used (to track usedBy)
      allow update: if isAuthenticated();
      
      // Only the creator or hub admin can delete invites
      allow delete: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        isHubAdmin(resource.data.hubId)
      );
    }
    
    // Event logs collection
    match /eventLogs/{eventId} {
      // Hub members can read event logs for their hub
      allow read: if isAuthenticated() && 
        isHubMember(resource.data.hubId) &&
        isMembershipActive(resource.data.hubId);
      
      // Event logs are created by the system/Cloud Functions
      allow create: if isAuthenticated();
      
      // Event logs cannot be modified or deleted (audit trail)
      allow update, delete: if false;
    }
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}




import{r as e,g as r,f as s,e as t,z as a}from"./vendor-Yz3niDpg.js";import{p as n,q as o,B as d,C as c,y as i,s as u,z as m,h as y,f as l,A as b,u as h,r as w,x as g,T as p}from"./firebase-BB8Fp3FL.js";import{d as f,u as I,b as E,i as x}from"./index-XwJoYhXH.js";const A=s=>{const[t,a]=e.useState([]),{isLoading:u,error:m}=r({queryKey:["messages",s],queryFn:async()=>{if(!s)throw new Error("Hub ID is required");const e=await async function(e,r=50){try{const s=n(f,"hubs",e,"messages"),t=o(s,d("timestamp","desc"),c(r)),a=await w(t),i=[];return a.forEach(r=>{const s=r.data();i.push({id:r.id,hubId:e,senderId:s.senderId,senderName:s.senderName,text:s.text,type:s.type||"text",mediaURL:s.mediaURL,timestamp:s.timestamp?.toDate()||new Date,readBy:s.readBy||[]})}),i.reverse(),{success:!0,data:i}}catch(m){return console.error("Get messages error:",m),{success:!1,error:m instanceof Error?m.message:"Failed to get messages",data:[]}}}(s);if(!e.success)throw new Error(e.error);return e.data||[]},enabled:!!s,staleTime:0});e.useEffect(()=>{if(!s)return;const e=function(e,r,s,t=50){try{const a=n(f,"hubs",e,"messages"),u=o(a,d("timestamp","desc"),c(t));return i(u,s=>{const t=[];s.forEach(r=>{const s=r.data();t.push({id:r.id,hubId:e,senderId:s.senderId,senderName:s.senderName,text:s.text,type:s.type||"text",mediaURL:s.mediaURL,timestamp:s.timestamp?.toDate()||new Date,readBy:s.readBy||[]})}),t.reverse(),r(t)},e=>{console.error("Message subscription error:",e),s&&s(e)})}catch(m){return console.error("Failed to subscribe to messages:",m),s&&s(m instanceof Error?m:new Error("Unknown error")),()=>{}}}(s,e=>{a(e)},e=>{console.error("Message subscription error:",e)});return e},[s]);return{messages:t.length>0?t:[],isLoading:u,error:m}},B=()=>{const{user:e}=I(),{currentHub:r}=E(),t=s({mutationFn:async s=>{if(!e||!r)throw new Error("User or hub not available");const t={hubId:r.id,senderId:e.id,senderName:e.email?.split("@")[0]||"User",text:s.trim(),type:"text"},a=await async function(e){try{const r=n(f,"hubs",e.hubId,"messages"),s={senderId:e.senderId,senderName:e.senderName,text:e.text,type:e.type||"text",mediaURL:e.mediaURL||null,readBy:[e.senderId],timestamp:u()},t=await m(r,s),a=(await y(t)).data();if(!a)throw new Error("Failed to create message");return{success:!0,data:{id:t.id,hubId:e.hubId,senderId:e.senderId,senderName:e.senderName,text:e.text,type:e.type||"text",mediaURL:e.mediaURL,timestamp:a.timestamp?.toDate()||new Date,readBy:a.readBy||[e.senderId]}}}catch(r){return console.error("Send message error:",r),{success:!1,error:r instanceof Error?r.message:"Failed to send message"}}}(t);if(!a.success)throw new Error(a.error);return a.data}});return{sendMessage:t.mutate,sendMessageAsync:t.mutateAsync,isSending:t.isPending,error:t.error}},F=()=>{const{user:e}=I(),{currentHub:r}=E(),t=s({mutationFn:async s=>{if(!e||!r)throw new Error("User or hub not available");const t=await async function(e,r,s){try{const t=l(f,"hubs",e,"messages",r),a=await y(t);if(!a.exists())return{success:!1,error:"Message not found"};const n=a.data()?.readBy||[];return n.includes(s)||await h(t,{readBy:[...n,s]}),{success:!0}}catch(t){return console.error("Mark message as read error:",t),{success:!1,error:t instanceof Error?t.message:"Failed to mark message as read"}}}(r.id,s,e.id);if(!t.success)throw new Error(t.error)}});return{markAsRead:t.mutate,markAsReadAsync:t.mutateAsync,isMarking:t.isPending,error:t.error}},D=()=>{const{user:e}=I(),{currentHub:r}=E(),t=s({mutationFn:async s=>{if(!e||!r)throw new Error("User or hub not available");const t=await async function(e,r,s){try{const t=l(f,"hubs",e,"messages",r),a=await y(t);if(!a.exists())return{success:!1,error:"Message not found"};const n=a.data();return n?.senderId!==s?{success:!1,error:"Unauthorized: Only message sender can delete"}:(await b(t),{success:!0})}catch(t){return console.error("Delete message error:",t),{success:!1,error:t instanceof Error?t.message:"Failed to delete message"}}}(r.id,s,e.id);if(!t.success)throw new Error(t.error)}});return{deleteMessage:t.mutate,deleteMessageAsync:t.mutateAsync,isDeleting:t.isPending,error:t.error}},N=()=>{const{currentHub:e}=E();return r({queryKey:["broadcasts",e?.id],queryFn:async()=>{if(!e)return[];const r=await(async(e,r=50)=>{try{const s=p.now(),t=o(n(f,"hubs",e,"broadcasts"),d("timestamp","desc")),a=await w(t),c=[];return a.forEach(e=>{const r=e.data();r.expiresAt&&r.expiresAt.toDate()<s.toDate()||c.push({id:e.id,hubId:r.hubId,senderId:r.senderId,senderName:r.senderName,title:r.title,message:r.message,priority:r.priority,type:r.type,timestamp:r.timestamp.toDate(),readBy:r.readBy||[],expiresAt:r.expiresAt?r.expiresAt.toDate():void 0})}),{success:!0,data:c.slice(0,r)}}catch(s){return console.error("Get hub broadcasts error:",s),{success:!1,error:s instanceof Error?s.message:"Failed to fetch broadcasts"}}})(e.id);return r.success&&r.data||[]},enabled:!!e,staleTime:3e4,refetchInterval:6e4})},U=()=>{const e=t(),{currentHub:r}=E(),{user:o}=x();return s({mutationFn:async e=>{if(!r||!o)throw new Error("Hub or user not found");const s=await(async e=>{try{const r={hubId:e.hubId,senderId:e.senderId,senderName:e.senderName,title:e.title,message:e.message,priority:e.priority,type:e.type,timestamp:p.now(),readBy:[e.senderId],expiresAt:e.expiresAt?p.fromDate(e.expiresAt):null};return{success:!0,data:{id:(await m(n(f,"hubs",e.hubId,"broadcasts"),r)).id,...e,timestamp:new Date,readBy:[e.senderId]}}}catch(r){return console.error("Create broadcast error:",r),{success:!1,error:r instanceof Error?r.message:"Failed to create broadcast"}}})({hubId:r.id,senderId:o.id,senderName:o.displayName||o.email,...e});if(!s.success)throw new Error(s.error);return s.data},onSuccess:s=>{e.invalidateQueries({queryKey:["broadcasts",r?.id]}),e.invalidateQueries({queryKey:["broadcasts","unread"]}),"urgent"===s?.priority?a.success("ðŸš¨ Emergency alert sent!",{duration:5e3}):a.success("Broadcast sent successfully")},onError:e=>{console.error("Create broadcast error:",e),a.error(e.message||"Failed to send broadcast")}})},v=()=>{const e=t(),{currentHub:r}=E(),{user:d}=x();return s({mutationFn:async e=>{if(!d||!r)throw new Error("User or hub not found");const s=await(async(e,r,s)=>{try{const t=l(f,"hubs",e,"broadcasts",r),a=await w(o(n(f,"hubs",e,"broadcasts"),g("__name__","==",r)));if(a.empty)return{success:!1,error:"Broadcast not found"};const d=a.docs[0].data().readBy||[];return d.includes(s)||await h(t,{readBy:[...d,s]}),{success:!0,data:void 0}}catch(t){return console.error("Acknowledge broadcast error:",t),{success:!1,error:t instanceof Error?t.message:"Failed to acknowledge broadcast"}}})(r.id,e,d.id);if(!s.success)throw new Error(s.error);return e},onSuccess:()=>{e.invalidateQueries({queryKey:["broadcasts",r?.id]}),e.invalidateQueries({queryKey:["broadcasts","unread"]})},onError:e=>{console.error("Acknowledge broadcast error:",e),a.error("Failed to acknowledge broadcast")}})};export{N as a,U as b,v as c,B as d,D as e,F as f,A as u};
//# sourceMappingURL=useBroadcasts-DUfu8DbO.js.map

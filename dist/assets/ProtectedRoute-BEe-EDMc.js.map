{"version":3,"file":"ProtectedRoute-BEe-EDMc.js","sources":["../../src/features/auth/utils/onboarding.ts","../../src/components/ProtectedRoute.tsx"],"sourcesContent":["/**\n * Onboarding Utilities\n * \n * Helps set up new users with a default hub\n */\n\nimport { createHub, getUserHubs } from '@/lib/api/hub-api';\nimport { useHubStore } from '@/lib/store/hub-store';\n\n/**\n * Check if user has hubs, if not create a default one\n */\nexport const ensureUserHasHub = async (userId: string, userName?: string): Promise<void> => {\n    try {\n        // Check if user already has hubs\n        const hubsResponse = await getUserHubs(userId);\n\n        if (hubsResponse.success && hubsResponse.data && hubsResponse.data.length > 0) {\n            // User has hubs, set the first one as current\n            const firstHub = hubsResponse.data[0];\n            const hubStore = useHubStore.getState();\n            hubStore.setCurrentHub(firstHub, 'admin'); // Assuming user is admin of their first hub\n            return;\n        }\n\n        // User has no hubs, create a default one\n        const displayName = userName || 'My Family';\n        const hubName = `${displayName}'s Hub`;\n\n        const createResponse = await createHub({\n            name: hubName,\n            description: 'My family hub for staying connected',\n            featureToggles: {\n                location: true,\n                tasks: true,\n                chat: true,\n                vault: true,\n                xp: true,\n                leaderboard: true,\n                geofencing: true,\n                deviceMonitoring: true,\n            },\n        }, userId);\n\n        if (createResponse.success && createResponse.data) {\n            // Set as current hub\n            const hubStore = useHubStore.getState();\n            hubStore.setCurrentHub(createResponse.data, 'admin');\n        } else {\n            console.error('Failed to create default hub:', createResponse.error);\n        }\n    } catch (error) {\n        console.error('Error in ensureUserHasHub:', error);\n        // Don't throw - let the app continue even if hub creation fails\n    }\n};\n\n","import { Navigate, useLocation } from 'react-router-dom';\nimport { useEffect, useState } from 'react';\nimport type { ReactNode } from 'react';\nimport { useAuth } from '@/features/auth/hooks/useAuth';\nimport { LoadingSpinner } from './LoadingSpinner';\nimport { ensureUserHasHub } from '@/features/auth/utils/onboarding';\n\ninterface ProtectedRouteProps {\n    children: ReactNode;\n}\n\nconst ProtectedRoute = ({ children }: ProtectedRouteProps) => {\n    const { isAuthenticated, isLoading, user } = useAuth();\n    const location = useLocation();\n    const [forceStopLoading, setForceStopLoading] = useState(false);\n\n    // Add timeout to prevent infinite loading\n    useEffect(() => {\n        const timeout = setTimeout(() => {\n            setForceStopLoading(true);\n        }, 5000); // 5 second timeout\n\n        return () => clearTimeout(timeout);\n    }, []);\n\n    // Ensure user has a hub after authentication (non-blocking)\n    useEffect(() => {\n        if (isAuthenticated && user) {\n            // Run hub check in background - don't block rendering\n            ensureUserHasHub(user.id, user.displayName || undefined)\n                .then(() => {\n                    console.log('Hub check completed');\n                })\n                .catch((error) => {\n                    console.error('ProtectedRoute: Hub check error:', error);\n                    // Continue anyway - hub creation is optional\n                });\n        }\n    }, [isAuthenticated, user]);\n\n    // Show loading only if auth is loading AND we haven't timed out\n    if (isLoading && !forceStopLoading) {\n        return (\n            <div className=\"min-h-screen flex items-center justify-center bg-background\">\n                <LoadingSpinner size=\"large\" />\n            </div>\n        );\n    }\n\n    // If not authenticated (or loading timed out), redirect to login\n    if (!isAuthenticated) {\n        return <Navigate to=\"/login\" state={{ from: location }} replace />;\n    }\n\n    // User is authenticated, show protected content immediately\n    // Don't wait for hub check - it runs in background\n    return <>{children}</>;\n};\n\nexport default ProtectedRoute;\n"],"names":["ProtectedRoute","children","isAuthenticated","isLoading","user","useAuth","location","useLocation","forceStopLoading","setForceStopLoading","useState","useEffect","timeout","setTimeout","clearTimeout","async","userId","userName","hubsResponse","getUserHubs","success","data","length","firstHub","useHubStore","getState","setCurrentHub","hubName","createResponse","createHub","name","description","featureToggles","tasks","chat","vault","xp","leaderboard","geofencing","deviceMonitoring","console","error","ensureUserHasHub","id","displayName","then","log","catch","jsx","className","LoadingSpinner","size","Navigate","to","state","from","replace"],"mappings":"0NAYO,MCDDA,EAAiB,EAAGC,eACtB,MAAMC,gBAAEA,EAAAC,UAAiBA,EAAAC,KAAWA,GAASC,IACvCC,EAAWC,KACVC,EAAkBC,GAAuBC,EAAAA,UAAS,GA2BzD,OAxBAC,EAAAA,UAAU,KACN,MAAMC,EAAUC,WAAW,KACvBJ,GAAoB,IACrB,KAEH,MAAO,IAAMK,aAAaF,IAC3B,IAGHD,EAAAA,UAAU,KACFT,GAAmBE,GDfCW,OAAOC,EAAgBC,KACnD,IAEI,MAAMC,QAAqBC,EAAYH,GAEvC,GAAIE,EAAaE,SAAWF,EAAaG,MAAQH,EAAaG,KAAKC,OAAS,EAAG,CAE3E,MAAMC,EAAWL,EAAaG,KAAK,GAGnC,YAFiBG,EAAYC,WACpBC,cAAcH,EAAU,QAErC,CAGA,MACMI,EAAU,GADIV,GAAY,oBAG1BW,QAAuBC,EAAU,CACnCC,KAAMH,EACNI,YAAa,sCACbC,eAAgB,CACZ1B,UAAU,EACV2B,OAAO,EACPC,MAAM,EACNC,OAAO,EACPC,IAAI,EACJC,aAAa,EACbC,YAAY,EACZC,kBAAkB,IAEvBvB,GAECY,EAAeR,SAAWQ,EAAeP,KAExBG,EAAYC,WACpBC,cAAcE,EAAeP,KAAM,SAE5CmB,QAAQC,MAAM,gCAAiCb,EAAea,MAEtE,OAASA,GACLD,QAAQC,MAAM,6BAA8BA,EAEhD,GCzBQC,CAAiBtC,EAAKuC,GAAIvC,EAAKwC,kBAAe,GACzCC,KAAK,KACFL,QAAQM,IAAI,yBAEfC,MAAON,IACJD,QAAQC,MAAM,mCAAoCA,MAI/D,CAACvC,EAAiBE,IAGjBD,IAAcK,EAEVwC,MAAC,OAAIC,UAAU,8DACXhD,eAACiD,EAAA,CAAeC,KAAK,YAM5BjD,oBAMKD,aALC+C,MAACI,EAAA,CAASC,GAAG,SAASC,MAAO,CAAEC,KAAMjD,GAAYkD,SAAO"}
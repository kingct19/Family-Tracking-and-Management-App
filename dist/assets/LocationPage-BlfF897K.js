import{r as e,g as t,f as s,z as n,e as r,j as a,q as o,U as i,V as l,W as c,X as d,G as u,S as g,Y as p,Z as m,$ as f,a0 as h,a1 as x,a2 as y,a3 as b,a4 as v,a5 as w,a6 as j,n as E,s as N,v as C,w as G,a7 as M,a8 as k,y as S,a9 as I,p as L,aa as F,D as A}from"./vendor-Yz3niDpg.js";import{L as z}from"./maps-EiNkSEVn.js";import{q as P,x as O,p as R,y as D,f as T,j as U,T as _,r as B,s as $,h as W,z as q,u as K,l as V}from"./firebase-BB8Fp3FL.js";import{d as H,u as Q,b as Y,L as J,a as X,e as Z}from"./index-XwJoYhXH.js";import{u as ee}from"./useHubMembers-BlHRT3SA.js";import{H as te}from"./HubSelector-DYcCpDOf.js";import"./query-C1EzXcVj.js";import"./state-CPa13AEy.js";import"./hub-schemas-CrELoLa9.js";import"./TextField-wgpo0Y90.js";import"./Button-D6lpmbx7.js";const se={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_APP_NAME:"FamilyTracker",VITE_FIREBASE_API_KEY:"AIzaSyCXrZoXYuNeoUPJgYgxV_vzcMcDJNQ4kEk",VITE_FIREBASE_APP_ID:"1:785745550773:web:575c4f934dbcbedfd80dfc",VITE_FIREBASE_AUTH_DOMAIN:"group-safety-app.firebaseapp.com",VITE_FIREBASE_MEASUREMENT_ID:"G-01BK5V4GJG",VITE_FIREBASE_MESSAGING_SENDER_ID:"785745550773",VITE_FIREBASE_PROJECT_ID:"group-safety-app",VITE_FIREBASE_STORAGE_BUCKET:"group-safety-app.firebasestorage.app",VITE_GOOGLE_MAPS_API_KEY:"AIzaSyA9lWu183h5xtuY8kJeU3ti306JuFqqlKU",VITE_USE_EMULATORS:"false",VITE_VERSION:"1.0.0"};async function ne(){return async function(e,t){try{const t=await fetch(`/api/secrets/${e}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(t.ok)return(await t.json()).value||null}catch(s){console.warn(`Failed to fetch secret ${e} from API:`,s)}{const s=se[t];if(s!==`your-${e.toLowerCase().replace(/_/g,"-")}`)return s}return null}("GOOGLE_API_KEY","VITE_GOOGLE_MAPS_API_KEY")}class re{static instance;loader=null;isLoaded=!1;loadPromise=null;apiKey=null;constructor(){}static getInstance(){return re.instance||(re.instance=new re),re.instance}async getApiKey(){if(this.apiKey)return this.apiKey;const e=await ne();if(e)return this.apiKey=e,e;const t="AIzaSyA9lWu183h5xtuY8kJeU3ti306JuFqqlKU";return this.apiKey=t,t}async load(e=["places","geometry","marker"]){if(this.isLoaded&&this.loadPromise)return this.loadPromise;if(this.loader&&!this.isLoaded&&this.loadPromise)return this.loadPromise;const t=await this.getApiKey();this.loader=new z({apiKey:t,version:"weekly",libraries:["places","geometry","marker"]}),this.loadPromise=this.loader.load();try{const e=await this.loadPromise;return this.isLoaded=!0,e}catch(s){throw console.error("Failed to load Google Maps:",s),s}}isGoogleMapsLoaded(){return this.isLoaded}getLoader(){return this.loader}}const ae=re.getInstance();const oe=new class{watchId=null;isWatching=!1;lastKnownPosition=null;isSupported(){return"geolocation"in navigator}async requestPermission(){if(!this.isSupported())throw new Error("Geolocation is not supported by this browser");try{return await this.getCurrentPosition(),!0}catch(e){return console.error("Location permission denied:",e),!1}}getCurrentPosition(){return new Promise((e,t)=>{this.isSupported()?navigator.geolocation.getCurrentPosition(t=>{e(this.mapPosition(t))},e=>{t(this.mapError(e))},{enableHighAccuracy:!0,timeout:15e3,maximumAge:6e4}):t(new Error("Geolocation is not supported"))})}startWatching(e,t){this.isSupported()?this.isWatching||(this.watchId=navigator.geolocation.watchPosition(t=>{const s=this.mapPosition(t);this.lastKnownPosition=s,e(s)},e=>{t?.(this.mapError(e))},{enableHighAccuracy:!1,timeout:15e3,maximumAge:3e4}),this.isWatching=!0):t?.({code:0,message:"Geolocation is not supported"})}stopWatching(){null!==this.watchId&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null,this.isWatching=!1)}getWatchingStatus(){return this.isWatching}getLastKnownPosition(){return this.lastKnownPosition}calculateDistance(e,t){const s=e.latitude*Math.PI/180,n=t.latitude*Math.PI/180,r=(t.latitude-e.latitude)*Math.PI/180,a=(t.longitude-e.longitude)*Math.PI/180,o=Math.sin(r/2)*Math.sin(r/2)+Math.cos(s)*Math.cos(n)*Math.sin(a/2)*Math.sin(a/2);return 6371e3*(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)))}mapPosition(e){return{latitude:e.coords.latitude,longitude:e.coords.longitude,accuracy:e.coords.accuracy,altitude:e.coords.altitude,altitudeAccuracy:e.coords.altitudeAccuracy,heading:e.coords.heading,speed:e.coords.speed,timestamp:e.timestamp}}mapError(e){return{code:e.code,message:{1:"Location permission denied",2:"Location position unavailable",3:"Location request timeout"}[e.code]||"Unknown location error"}}};const ie=async(e,t)=>{try{const s=T(H,"users",e,"settings","preferences");return await U(s,{...t,lastUpdated:new Date},{merge:!0}),{success:!0}}catch(s){return console.error("Error updating user preferences:",s),{success:!1,error:s instanceof Error?s.message:"Failed to update preferences"}}},le=async(e,t)=>ie(e,{locationPermissionGranted:t}),ce=()=>{const{user:t}=Q(),{currentHub:r}=Y(),[a,o]=e.useState(null),[i,l]=e.useState(!0),[c,d]=e.useState(null),[u,g]=e.useState(!1);e.useEffect(()=>{if(oe.getWatchingStatus()){g(!0);const e=oe.getLastKnownPosition();e&&o(e)}t&&(async e=>{try{const t=T(H,"users",e,"settings","preferences"),s=await W(t);if(!s.exists())return{success:!0,data:null};const n=s.data();return{success:!0,data:{locationPermissionGranted:n.locationPermissionGranted||!1,locationSharingEnabled:n.locationSharingEnabled||!1,notificationsEnabled:n.notificationsEnabled||!1,lastUpdated:n.lastUpdated?.toDate()||new Date}}}catch(c){return console.error("Error getting user preferences:",c),{success:!1,error:c instanceof Error?c.message:"Failed to get preferences"}}})(t.id).then(e=>{e.success&&e.data&&l(e.data.locationSharingEnabled??!0)})},[t]);const p=s({mutationFn:e=>{if(!t||!r)throw new Error("User or hub not available");return(async e=>{try{const{hubId:t,userId:s,coordinates:n,isSharing:r}=e,a=T(H,"hubs",t,"locations",s);await U(a,{userId:s,hubId:t,latitude:n.latitude,longitude:n.longitude,accuracy:n.accuracy,speed:n.speed,heading:n.heading,timestamp:_.fromMillis(n.timestamp),isSharing:r,updatedAt:_.now()});const o=T(R(H,"hubs",t,"locations",s,"history"));return await U(o,{latitude:n.latitude,longitude:n.longitude,accuracy:n.accuracy,speed:n.speed,heading:n.heading,timestamp:_.fromMillis(n.timestamp)}),{success:!0}}catch(c){return console.error("Error updating location:",c),{success:!1,error:c instanceof Error?c.message:"Failed to update location"}}})({hubId:r.id,userId:t.id,coordinates:e,isSharing:i})}}),m=e.useCallback(async()=>{if(!oe.isSupported())return d("Geolocation is not supported by your browser"),void n.error("Geolocation is not supported");if(oe.getWatchingStatus())return void g(!0);if(!(await oe.requestPermission()))return d("Location permission denied"),n.error("Please enable location permissions in your browser"),void(t&&await le(t.id,!1));t&&await le(t.id,!0),oe.startWatching(e=>{o(e),d(null),i&&t&&r&&p.mutate(e)},e=>{d(e.message),n.error(e.message)}),g(!0)},[i,t,r,p]),f=e.useCallback(()=>{oe.stopWatching(),g(!1)},[]),h=e.useCallback(async()=>{if(!t||!r)return;const e=!i;l(e);const s=await(async(e,t,s)=>{try{const n=T(H,"hubs",e,"locations",t);return await U(n,{isSharing:s,updatedAt:_.now()},{merge:!0}),{success:!0}}catch(c){return console.error("Error updating location sharing:",c),{success:!1,error:c instanceof Error?c.message:"Failed to update sharing preference"}}})(r.id,t.id,e);await(async(e,t)=>ie(e,{locationSharingEnabled:t}))(t.id,e),s.success?n.success(e?"Location sharing enabled":"Location sharing disabled"):(n.error("Failed to update sharing preference"),l(!e))},[i,t,r]);return e.useEffect(()=>()=>{u&&oe.stopWatching()},[u]),{currentLocation:a,isSharing:i,isWatching:u,error:c,startTracking:m,stopTracking:f,toggleSharing:h}},de=s=>{const[n,r]=e.useState([]),{data:a,isLoading:o,error:i}=t({queryKey:["locations",s],queryFn:async()=>{if(!s)throw new Error("Hub ID is required");const e=await(async e=>{try{const t=P(R(H,"hubs",e,"locations"),O("isSharing","==",!0)),s=await B(t),n=[];return s.forEach(e=>{const t=e.data();n.push({userId:t.userId,hubId:t.hubId,latitude:t.latitude,longitude:t.longitude,accuracy:t.accuracy,speed:t.speed,heading:t.heading,timestamp:t.timestamp?.toDate()||new Date,isSharing:t.isSharing})}),{success:!0,data:n}}catch(i){return console.error("Error getting hub locations:",i),{success:!1,error:i instanceof Error?i.message:"Failed to get locations"}}})(s);if(!e.success)throw new Error(e.error);return e.data||[]},enabled:!!s,staleTime:1e4});e.useEffect(()=>{if(!s)return;const e=((e,t,s)=>{const n=P(R(H,"hubs",e,"locations"),O("isSharing","==",!0));return D(n,e=>{const s=[];e.forEach(e=>{const t=e.data();s.push({userId:t.userId,hubId:t.hubId,latitude:t.latitude,longitude:t.longitude,accuracy:t.accuracy,speed:t.speed,heading:t.heading,timestamp:t.timestamp?.toDate()||new Date,isSharing:t.isSharing})}),t(s)},e=>{console.error("Error in location subscription:",e),s?.(e)})})(s,e=>{r(e)},e=>{console.error("Location subscription error:",e)});return e},[s]);return{locations:n.length>0?n:a||[],isLoading:o,error:i}},ue=t=>{const[s,n]=e.useState(new Map);e.useEffect(()=>{if(!t)return;const e=function(e,t,s){try{const n=R(H,"hubs",e,"deviceStatus"),r=P(n);return D(r,e=>{const s=new Map;e.forEach(e=>{const t=e.data();s.set(e.id,{...t,lastSeen:t.lastSeen?.toDate()||new Date,updatedAt:t.updatedAt?.toDate()||new Date})}),t(s)},e=>{e instanceof Error&&(e.message.includes("permission")||e.message.includes("Permission")),s&&s(e)})}catch(n){return n instanceof Error&&(n.message.includes("permission")||n.message.includes("Permission")),()=>{}}}(t,e=>{n(e)},e=>{});return e},[t]);const r=e.useCallback(e=>s.get(e)||null,[s]);return{deviceStatuses:s,getDeviceStatus:r}},ge=e=>R(H,"hubs",e,"geofences"),pe=e=>{const t=void 0===e.isActive||e.isActive;return{id:e.id,hubId:e.hubId,name:e.name,description:e.description,type:e.type,center:e.center,radius:e.radius,isActive:t,createdBy:e.createdBy,createdAt:e.createdAt?.toDate()||new Date,updatedAt:e.updatedAt?.toDate()||new Date,alertOnEntry:e.alertOnEntry,alertOnExit:e.alertOnExit,alertRecipients:e.alertRecipients||[]}},me=()=>{const{user:a}=Q(),{currentHub:o}=Y(),i=r(),{data:l=[],isLoading:c,error:d,refetch:u}=t({queryKey:["geofences",o?.id],queryFn:async()=>{if(!o?.id)throw console.log("[useGeofences] Query skipped - no hub selected"),new Error("No hub selected");console.log("[useGeofences] Fetching geofences for hub:",o.id);const e=await(async e=>{try{console.log("[geofence-api] Getting geofences for hub:",e);const t=P(ge(e)),s=await B(t);console.log("[geofence-api] Snapshot size:",s.docs.length),s.docs.forEach(e=>{const t=e.data();console.log("[geofence-api] Raw document:",{id:e.id,name:t.name,isActive:t.isActive,hubId:t.hubId,createdBy:t.createdBy})});const n=s.docs.map(e=>{const t=pe({id:e.id,...e.data()});return console.log("[geofence-api] Converted geofence:",{id:t.id,name:t.name,isActive:t.isActive}),t}).filter(e=>{const t=e.isActive;return console.log("[geofence-api] Filtering geofence:",{id:e.id,name:e.name,isActive:t,willInclude:t}),t}).sort((e,t)=>t.createdAt.getTime()-e.createdAt.getTime());return console.log("[geofence-api] Final geofences count:",n.length),{success:!0,data:n}}catch(d){return console.error("[geofence-api] Error getting geofences:",d),d instanceof Error&&(d.message.includes("permission")||d.message.includes("Permission")),{success:!1,error:d instanceof Error?d.message:"Failed to get geofences",data:[]}}})(o.id);return console.log("[useGeofences] Query result:",e),e.success&&e.data?console.log("[useGeofences] Geofences fetched:",e.data.length,"geofences"):console.error("[useGeofences] Query failed:",e.error),e},enabled:!!o?.id,select:e=>{const t=e.success&&e.data?e.data:[];return console.log("[useGeofences] Query select - geofences count:",t.length),t}}),g=s({mutationFn:async e=>{if(!o?.id||!a?.id)throw new Error("No hub or user selected");console.log("[useGeofences] Creating geofence:",{hubId:o.id,userId:a.id,data:e});const t=await(async(e,t,s)=>{try{console.log("[geofence-api] Creating geofence:",{hubId:e,userId:t,data:s});const n={...s,hubId:e,createdBy:t,isActive:!0,createdAt:$(),updatedAt:$()};console.log("[geofence-api] Geofence data to save:",n);const r=await q(ge(e),n);console.log("[geofence-api] Geofence created with ID:",r.id);const a=pe({id:r.id,...n,createdAt:_.now(),updatedAt:_.now()});return console.log("[geofence-api] Geofence created successfully:",a),{success:!0,data:a}}catch(d){return console.error("[geofence-api] Error creating geofence:",d),d instanceof Error&&(d.message.includes("permission")||d.message.includes("Permission")||d.message.includes("Missing or insufficient permissions"))&&console.error("[geofence-api] Permission denied - user may not be admin or member with create permission"),{success:!1,error:d instanceof Error?d.message:"Failed to create geofence"}}})(o.id,a.id,e);return console.log("[useGeofences] Create geofence result:",t),t},onSuccess:e=>{if(console.log("[useGeofences] Mutation onSuccess called:",{result:e,hubId:o?.id}),e.success){const e=["geofences",o?.id];console.log("[useGeofences] Invalidating queries with key:",e),i.invalidateQueries({queryKey:e}),i.refetchQueries({queryKey:e}).then(()=>{console.log("[useGeofences] Query refetched successfully")}).catch(e=>{console.error("[useGeofences] Error refetching query:",e)}),n.success("Geofence created successfully")}else console.error("[useGeofences] Failed to create geofence:",e.error),n.error(e.error||"Failed to create geofence")},onError:e=>{console.error("[useGeofences] Error creating geofence:",e),n.error("Failed to create geofence")}}),p=s({mutationFn:async e=>{if(!o?.id)throw new Error("No hub selected");console.log("[useGeofences] Updating geofence:",{hubId:o.id,data:e});const t=await(async(e,t,s)=>{try{const n=T(ge(e),t),r={...s,updatedAt:$()};await K(n,r);const a=await W(n);return a.exists()?{success:!0,data:pe(a.data())}:{success:!1,error:"Geofence not found"}}catch(d){return console.error("Error updating geofence:",d),{success:!1,error:d instanceof Error?d.message:"Failed to update geofence"}}})(o.id,e.id,e);return console.log("[useGeofences] Update geofence result:",t),t},onSuccess:e=>{if(console.log("[useGeofences] Update mutation onSuccess called:",{result:e,hubId:o?.id}),e.success){const e=["geofences",o?.id];console.log("[useGeofences] Invalidating queries with key:",e),i.invalidateQueries({queryKey:e}),i.refetchQueries({queryKey:e}).then(()=>{console.log("[useGeofences] Query refetched successfully")}).catch(e=>{console.error("[useGeofences] Error refetching query:",e)}),n.success("Geofence updated successfully")}else console.error("[useGeofences] Failed to update geofence:",e.error),n.error(e.error||"Failed to update geofence")},onError:e=>{console.error("[useGeofences] Error updating geofence:",e),n.error("Failed to update geofence")}}),m=s({mutationFn:async e=>{if(!o?.id)throw new Error("No hub selected");return(async(e,t)=>{try{const s=T(ge(e),t);return await K(s,{isActive:!1,updatedAt:$()}),{success:!0}}catch(d){return console.error("Error deleting geofence:",d),{success:!1,error:d instanceof Error?d.message:"Failed to delete geofence"}}})(o.id,e)},onSuccess:e=>{if(console.log("[useGeofences] Delete mutation onSuccess called:",{result:e,hubId:o?.id}),e.success){const e=["geofences",o?.id];console.log("[useGeofences] Invalidating queries with key:",e),i.invalidateQueries({queryKey:e}),i.refetchQueries({queryKey:e}).then(()=>{console.log("[useGeofences] Query refetched successfully")}).catch(e=>{console.error("[useGeofences] Error refetching query:",e)}),n.success("Geofence deleted successfully")}else n.error(e.error||"Failed to delete geofence")},onError:e=>{console.error("Error deleting geofence:",e),n.error("Failed to delete geofence")}});return{geofences:l,isLoading:c,error:d,refetch:u,createGeofence:e.useCallback(async e=>{try{const t=await g.mutateAsync(e);if(!t.success)throw new Error(t.error||"Failed to create geofence");return t}catch(t){throw console.error("[useGeofences] Error in createGeofenceHandler:",t),t}},[g]),updateGeofence:e.useCallback(async e=>{try{const t=await p.mutateAsync(e);if(!t.success)throw new Error(t.error||"Failed to update geofence");return t}catch(t){throw console.error("[useGeofences] Error in updateGeofenceHandler:",t),t}},[p]),deleteGeofence:e.useCallback(e=>{window.confirm("Are you sure you want to delete this geofence?")&&m.mutate(e)},[m]),isCreating:g.isPending,isUpdating:p.isPending,isDeleting:m.isPending}};const fe=new class{userStates=new Map;detectionCallbacks=[];isLocationInsideGeofence(e,t){return this.calculateDistance(e.latitude,e.longitude,t.center.latitude,t.center.longitude)<=t.radius}calculateDistance(e,t,s,n){const r=e*Math.PI/180,a=s*Math.PI/180,o=(s-e)*Math.PI/180,i=(n-t)*Math.PI/180,l=Math.sin(o/2)*Math.sin(o/2)+Math.cos(r)*Math.cos(a)*Math.sin(i/2)*Math.sin(i/2);return 6371e3*(2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)))}checkGeofenceState(e,t,s){const n=[],r=this.userStates.get(e)||new Map;this.userStates.set(e,r);for(const a of s){if(!a.isActive)continue;const e=this.isLocationInsideGeofence(t,a),s=r.get(a.id),o=s?.isInside||!1;if(r.set(a.id,{geofenceId:a.id,isInside:e,lastEvent:s?.lastEvent}),!o&&e){const e={geofenceId:a.id,geofenceName:a.name,eventType:"entry",distance:this.calculateDistance(t.latitude,t.longitude,a.center.latitude,a.center.longitude),accuracy:t.accuracy};n.push(e),this.notifyCallbacks(e)}if(o&&!e){const e={geofenceId:a.id,geofenceName:a.name,eventType:"exit",distance:this.calculateDistance(t.latitude,t.longitude,a.center.latitude,a.center.longitude),accuracy:t.accuracy};n.push(e),this.notifyCallbacks(e)}}return n}onDetection(e){return this.detectionCallbacks.push(e),()=>{const t=this.detectionCallbacks.indexOf(e);t>-1&&this.detectionCallbacks.splice(t,1)}}notifyCallbacks(e){this.detectionCallbacks.forEach(t=>{try{t(e)}catch(s){console.error("Error in geofence detection callback:",s)}})}getUserState(e){return this.userStates.get(e)||new Map}clearUserState(e){this.userStates.delete(e)}clearAllStates(){this.userStates.clear()}};const he=new class{notifications=[];audioContext=null;isNotificationPermissionGranted=!1;constructor(){this.initializeAudioContext();try{this.checkNotificationPermission()}catch(e){}}initializeAudioContext(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext)}catch(e){console.warn("Web Audio API not supported:",e)}}checkNotificationPermission(){"Notification"in window&&(this.isNotificationPermissionGranted="granted"===Notification.permission)}async requestNotificationPermission(){if(!("Notification"in window))return!1;if("granted"===Notification.permission)return this.isNotificationPermissionGranted=!0,!0;if("denied"===Notification.permission)return!1;try{const e=await Notification.requestPermission();return this.isNotificationPermissionGranted="granted"===e,this.isNotificationPermissionGranted}catch(e){return console.warn("Failed to request notification permission:",e),!1}}createAlert(e,t,s,n,r){const a={id:`alert_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,geofenceId:e,geofenceName:t,userId:s,type:n,timestamp:new Date,location:r,message:this.generateAlertMessage(t,n),isRead:!1};return this.notifications.unshift(a),this.showAlert(a),a}generateAlertMessage(e,t){return`Family member ${"entry"===t?"entered":"left"} ${e}`}async showAlert(e){this.isNotificationPermissionGranted&&new Notification("Geofence Alert",{body:e.message,icon:"/logo192.png",tag:e.id,requireInteraction:!0}),this.playAlertSound(),this.dispatchAlertEvent(e)}playAlertSound(){if(this.audioContext)try{const e=this.audioContext.createOscillator(),t=this.audioContext.createGain();e.connect(t),t.connect(this.audioContext.destination),e.frequency.setValueAtTime(800,this.audioContext.currentTime),e.frequency.setValueAtTime(600,this.audioContext.currentTime+.1),e.frequency.setValueAtTime(800,this.audioContext.currentTime+.2),t.gain.setValueAtTime(0,this.audioContext.currentTime),t.gain.linearRampToValueAtTime(.3,this.audioContext.currentTime+.01),t.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.5),e.start(this.audioContext.currentTime),e.stop(this.audioContext.currentTime+.5)}catch(e){console.warn("Failed to play alert sound:",e)}}dispatchAlertEvent(e){const t=new CustomEvent("geofenceAlert",{detail:e});window.dispatchEvent(t)}getAlerts(){return[...this.notifications]}getUnreadAlerts(){return this.notifications.filter(e=>!e.isRead)}markAsRead(e){const t=this.notifications.find(t=>t.id===e);t&&(t.isRead=!0)}markAllAsRead(){this.notifications.forEach(e=>{e.isRead=!0})}clearOldAlerts(){const e=new Date(Date.now()-864e5);this.notifications=this.notifications.filter(t=>t.timestamp>e)}getNotificationPermissionStatus(){return"Notification"in window?Notification.permission:"denied"}isNotificationSupported(){return"Notification"in window}},xe=e=>{switch(e){case"home":return"#3B82F6";case"school":return"#10B981";case"work":return"#8B5CF6";default:return"#6B7280"}},ye=({height:t="600px",zoom:s=13,showControls:n=!0,onGeofenceClick:r})=>{const{currentHub:o}=Y(),{user:i}=Q(),{currentLocation:l}=ce(),{locations:c}=de(o?.id),{geofences:d}=me(),{data:u=[]}=ee(),{getDeviceStatus:g}=ue(o?.id),p=e.useRef(null),m=e.useRef(null),f=e.useRef(new Map),h=e.useRef(new Map),x=e.useRef(null),y=e.useRef(new Map),[b,v]=e.useState(!1),[w,j]=e.useState(null);e.useEffect(()=>{const e=setTimeout(()=>{b||w||(console.error("MapView: Map loading timeout"),j("Map loading timed out. Please refresh the page."))},1e4);return()=>clearTimeout(e)},[b,w]),e.useEffect(()=>{b||m.current||p.current&&ae.load().then(e=>{if(!p.current)return;const t=l?{lat:l.latitude,lng:l.longitude}:{lat:40.7128,lng:-74.006};m.current=new e.maps.Map(p.current,{center:t,zoom:l?15:s,mapTypeControl:n,streetViewControl:n,fullscreenControl:n,zoomControl:n,styles:[{featureType:"poi",elementType:"labels",stylers:[{visibility:"off"}]}]}),v(!0)}).catch(e=>{console.error("Error loading Google Maps:",e);const t=e.message||"Failed to load map";t.includes("API key")||t.includes("key")?j("Invalid Google Maps API key. Please check your configuration."):j(`Failed to load map: ${t}`)})},[]),e.useEffect(()=>{if(m.current&&l&&b){const e=new google.maps.LatLng(l.latitude,l.longitude);m.current.setCenter(e),m.current.setZoom(15)}},[l,b]),e.useEffect(()=>{if(!l||!d.length||!o?.id)return;const e=fe.checkGeofenceState("current-user",l,d);e.length>0&&e.forEach(e=>{const t=d.find(t=>t.id===e.geofenceId);t&&he.createAlert(t.id,t.name,"current-user",e.eventType,{latitude:l.latitude,longitude:l.longitude})})},[l,d,o?.id]),e.useEffect(()=>{if(!m.current||!b||!l)return;const e=new google.maps.LatLng(l.latitude,l.longitude),t=i?.photoURL,s=u.find(e=>e.userId===i?.id),n=t||s?.photoURL,r=k(s,n,!0);x.current?(x.current.setPosition(e),r&&x.current.setIcon(r)):(x.current=new google.maps.Marker({position:e,map:m.current,title:"Your Location",icon:r||{path:google.maps.SymbolPath.CIRCLE,scale:10,fillColor:"#10B981",fillOpacity:1,strokeColor:"#FFFFFF",strokeWeight:3},zIndex:1e3}),!n||C.current.has(n)||G.current.has(n)||M(n).then(()=>{const e=k(s,n,!0);e&&x.current&&x.current.getMap()&&x.current.setIcon(e)}).catch(()=>{}),new google.maps.Circle({strokeColor:"#10B981",strokeOpacity:.3,strokeWeight:2,fillColor:"#10B981",fillOpacity:.1,map:m.current,center:e,radius:l.accuracy||50}))},[l,b,i?.id,i?.photoURL,u]),e.useEffect(()=>{if(!m.current||!b)return;const e=y.current;e.forEach((t,s)=>{d.find(e=>e.id===s)||(t.setMap(null),e.delete(s))}),d.forEach(t=>{if(!t.isActive)return;const s=new google.maps.LatLng(t.center.latitude,t.center.longitude),n=e.get(t.id);if(n)n.setCenter(s),n.setRadius(t.radius);else{const n=new google.maps.Circle({strokeColor:xe(t.type),strokeOpacity:.8,strokeWeight:2,fillColor:xe(t.type),fillOpacity:.2,map:m.current,center:s,radius:t.radius,clickable:!0});n.addListener("click",()=>{r&&r(t.id)}),e.set(t.id,n)}})},[d,b,r]);const E=e=>e.split(" ").map(e=>e[0]).join("").toUpperCase().slice(0,2),N=(e,t,s)=>{e.fillStyle=t?"#E8DEF8":"#D1D5DB",e.fill(),e.fillStyle=t?"#6750A4":"#6B7280",e.font=`bold ${s/3}px Arial`,e.textAlign="center",e.textBaseline="middle";const n=t?E(t.displayName):"?";e.fillText(n,s/2,s/2)},C=e.useRef(new Map),G=e.useRef(new Set),M=e=>C.current.has(e)?Promise.resolve(C.current.get(e)):G.current.has(e)?Promise.reject(new Error("Image previously failed to load")):new Promise((t,s)=>{const n=new Image;n.crossOrigin="anonymous";const r=setTimeout(()=>{n.onload=null,n.onerror=null,G.current.add(e),s(new Error("Image load timeout"))},5e3);n.onload=()=>{clearTimeout(r),C.current.set(e,n),t(n)},n.onerror=a=>{if(clearTimeout(r),G.current.add(e),console.warn("Failed to load image (CORS or network issue):",e),"anonymous"===n.crossOrigin){const n=new Image;n.onload=()=>{C.current.set(e,n),t(n)},n.onerror=()=>{s(a)},n.src=e}else s(a)},n.src=e});e.useEffect(()=>{u&&0!==u.length&&u.forEach(e=>{!e.photoURL||C.current.has(e.photoURL)||G.current.has(e.photoURL)||M(e.photoURL).catch(()=>{})})},[u]);const k=(e,t,s)=>{const n=s?48:40,r=s?4:3,a=s?"#10B981":"#6750A4",o=document.createElement("canvas");o.width=n,o.height=n;const i=o.getContext("2d");if(i){if(i.beginPath(),i.arc(n/2,n/2,n/2-r/2,0,2*Math.PI),i.fillStyle=a,i.fill(),i.beginPath(),i.arc(n/2,n/2,n/2-r,0,2*Math.PI),i.save(),i.clip(),t&&C.current.has(t)&&!G.current.has(t))try{const e=C.current.get(t),s=n-2*r;i.drawImage(e,r,r,s,s)}catch(l){console.warn("Failed to draw image on canvas:",l),N(i,e,n)}else N(i,e,n),t&&!G.current.has(t)&&M(t).then(()=>{}).catch(()=>{});return i.restore(),{url:o.toDataURL(),scaledSize:new google.maps.Size(n,n),anchor:new google.maps.Point(n/2,n/2)}}},S=e=>{if(!m.current)return;if(!e||!e.userId||"number"!=typeof e.latitude||"number"!=typeof e.longitude)return void console.warn("Invalid location data:",e);if(e.userId===i?.id)return;const t=(s=e.userId,u.find(e=>e.userId===s));var s;const n=g(e.userId),r=f.current.get(e.userId),a=new google.maps.LatLng(e.latitude,e.longitude),o=new Date(e.timestamp),l=Math.floor((Date.now()-o.getTime())/1e3/60),c=l<1?"Just now":l<60?`${l}m ago`:`${Math.floor(l/60)}h ago`,d=n?.batteryLevel??null,p=n?.isOnline??!0,x=t?.photoURL,y=`\n            <div style="padding: 12px; min-width: 200px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">\n                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">\n                    ${x?`<img src="${x}" alt="${t?.displayName||"User"}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />`:""}\n                    ${`<div style="width: 40px; height: 40px; border-radius: 50%; background: ${t?"#E8DEF8":"#D1D5DB"}; display: ${x?"none":"flex"}; align-items: center; justify-content: center; font-weight: bold; color: ${t?"#6750A4":"#6B7280"};">\n                        ${t?E(t.displayName):"?"}\n                    </div>`}\n                    <div style="flex: 1;">\n                        <h3 style="margin: 0; font-size: 14px; font-weight: 600; color: #1F2937;">\n                            ${t?.displayName||`User ${e.userId.slice(0,8)}`}\n                        </h3>\n                        <p style="margin: 2px 0 0 0; font-size: 12px; color: #6B7280;">\n                            ${t?.role?t.role.charAt(0).toUpperCase()+t.role.slice(1):"Member"}\n                        </p>\n                    </div>\n                </div>\n                <div style="border-top: 1px solid #E5E7EB; padding-top: 8px; margin-top: 8px;">\n                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">\n                        <span style="font-size: 12px; color: #6B7280;">Status:</span>\n                        <span style="font-size: 12px; font-weight: 500; color: ${p?"#10B981":"#6B7280"};">\n                            ${p?"● Online":"○ Offline"}\n                        </span>\n                    </div>\n                    ${null!==d?`\n                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">\n                            <span style="font-size: 12px; color: #6B7280;">Battery:</span>\n                            <span style="font-size: 12px; font-weight: 500; color: ${d<20?"#EF4444":d<50?"#F59E0B":"#10B981"};">\n                                ${d}%\n                            </span>\n                        </div>\n                    `:""}\n                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">\n                        <span style="font-size: 12px; color: #6B7280;">Last seen:</span>\n                        <span style="font-size: 12px; color: #6B7280;">${c}</span>\n                    </div>\n                    <div style="display: flex; justify-content: space-between;">\n                        <span style="font-size: 12px; color: #6B7280;">Accuracy:</span>\n                        <span style="font-size: 12px; color: #6B7280;">${Math.round(e.accuracy)}m</span>\n                    </div>\n                </div>\n            </div>\n        `;if(r){r.setPosition(a);const t=h.current.get(e.userId);t&&t.setContent(y)}else{const s=t?.photoURL,n=k(t,s,!1),r=new google.maps.Marker({position:a,map:m.current,title:t?.displayName||`User ${e.userId.slice(0,8)}`,animation:google.maps.Animation.DROP,icon:n||{path:google.maps.SymbolPath.CIRCLE,scale:8,fillColor:"#6750A4",fillOpacity:1,strokeColor:"#FFFFFF",strokeWeight:2}});!s||C.current.has(s)||G.current.has(s)||M(s).then(()=>{const e=k(t,s,!1);e&&r.getMap()&&r.setIcon(e)}).catch(()=>{});const o=new google.maps.InfoWindow({content:y});r.addListener("click",()=>{h.current.forEach(e=>e.close()),o.open(m.current,r)}),f.current.set(e.userId,r),h.current.set(e.userId,o)}};return e.useEffect(()=>{if(!m.current||!b)return;const e=c.filter(e=>e&&e.userId&&e.latitude&&e.longitude&&e.isSharing),t=f.current,s=new Set(e.map(e=>e.userId));t.forEach((e,n)=>{if(!s.has(n)){e.setMap(null),t.delete(n);const s=h.current.get(n);s&&(s.close(),h.current.delete(n))}}),e.forEach(e=>{S(e)})},[c,u,b,i?.id,g]),e.useEffect(()=>()=>{f.current.forEach(e=>e.setMap(null)),f.current.clear(),h.current.forEach(e=>e.close()),h.current.clear()},[]),w?a.jsx("div",{className:"flex items-center justify-center bg-gray-100 rounded-lg",style:{height:t},children:a.jsxs("div",{className:"text-center max-w-md px-6",children:[a.jsx("p",{className:"text-red-600 font-semibold mb-2 text-lg",children:"Map Error"}),a.jsx("p",{className:"text-gray-700 text-sm mb-3",children:w}),a.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 text-left",children:[a.jsx("p",{className:"text-blue-800 font-semibold text-sm mb-2",children:"Quick Fix:"}),a.jsxs("ol",{className:"text-blue-700 text-xs space-y-1 list-decimal list-inside",children:[a.jsxs("li",{children:["Check your ",a.jsx("code",{className:"bg-blue-100 px-1 rounded",children:".env"})," file"]}),a.jsxs("li",{children:["Add: ",a.jsx("code",{className:"bg-blue-100 px-1 rounded",children:"VITE_GOOGLE_MAPS_API_KEY=your_key"})]}),a.jsx("li",{children:"Restart the dev server"})]}),a.jsxs("p",{className:"text-blue-600 text-xs mt-3",children:["See ",a.jsx("code",{className:"bg-blue-100 px-1 rounded",children:"GOOGLE_MAPS_SETUP.md"})," for details"]})]})]})}):a.jsxs("div",{className:"relative w-full h-full",children:[a.jsx("div",{ref:p,style:{width:"100%",height:t||"100%",minHeight:"400px"},className:"bg-gray-100"}),!b&&a.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-100 bg-opacity-90 z-50",children:a.jsxs("div",{className:"text-center",children:[a.jsx(J,{size:"large"}),a.jsx("p",{className:"mt-4 text-gray-600 text-sm",children:"Loading map..."})]})}),c.length>0&&a.jsx("div",{className:"absolute top-6 left-6 bg-white rounded-xl shadow-md px-4 py-2.5 backdrop-blur-sm bg-white/95",children:a.jsxs("p",{className:"text-sm font-semibold text-gray-900 flex items-center gap-2",children:[a.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),c.length," ",1===c.length?"member":"members"," online"]})})]})},be=({location:t,userName:s="User",userPhoto:n,batteryLevel:r,isOnline:d=!0})=>{const[u,g]=e.useState(!1);return a.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl p-4 cursor-pointer transition-all duration-200 hover:shadow-3xl border border-gray-100",onClick:()=>g(!u),children:[a.jsxs("div",{className:"flex items-start gap-3",children:[a.jsxs("div",{className:"relative flex-shrink-0",children:[a.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center text-white font-semibold text-lg overflow-hidden",children:n?a.jsx("img",{src:n,alt:s,className:"w-full h-full object-cover"}):s.charAt(0).toUpperCase()}),d&&a.jsx("div",{className:"absolute -bottom-0.5 -right-0.5 w-4 h-4 bg-green-500 rounded-full border-2 border-white"})]}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsx("h3",{className:"font-semibold text-gray-900 text-base",children:s}),a.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-600 mt-1",children:[a.jsx(o,{size:12}),a.jsxs("span",{className:"truncate",children:[t.latitude.toFixed(4),", ",t.longitude.toFixed(4)]})]}),a.jsxs("div",{className:"flex items-center gap-3 mt-2",children:[a.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-500",children:[a.jsx(i,{size:12}),a.jsx("span",{children:(e=>{const t=new Date;let s;if("number"==typeof e)s=e;else if(e&&"function"==typeof e.getTime)s=e.getTime();else{if(!e||"function"!=typeof e.toMillis)return"Unknown";s=e.toMillis()}const n=Math.floor((t.getTime()-s)/1e3);return n<60?"Just now":n<3600?`${Math.floor(n/60)}m ago`:n<86400?`${Math.floor(n/3600)}h ago`:new Date(s).toLocaleDateString()})(t.timestamp)})]}),void 0!==r&&a.jsxs("div",{className:"flex items-center gap-1 text-xs "+(p=r,p?p<20?"text-red-500":p<50?"text-yellow-500":"text-green-500":"text-gray-400"),children:[a.jsx(l,{size:12}),a.jsxs("span",{children:[r,"%"]})]})]})]}),a.jsx("div",{className:"flex-shrink-0",children:a.jsx("div",{className:"px-2 py-1 bg-gray-100 rounded-full",children:a.jsxs("span",{className:"text-xs text-gray-600",children:["±",Math.round(t.accuracy),"m"]})})})]}),u&&a.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-200 space-y-3",children:[a.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[null!==t.speed&&void 0!==t.speed&&a.jsxs("div",{children:[a.jsx("p",{className:"text-xs text-gray-500",children:"Speed"}),a.jsxs("p",{className:"font-semibold text-gray-900",children:[Math.round(3.6*t.speed)," km/h"]})]}),null!==t.heading&&void 0!==t.heading&&a.jsxs("div",{children:[a.jsx("p",{className:"text-xs text-gray-500",children:"Heading"}),a.jsxs("p",{className:"font-semibold text-gray-900",children:[Math.round(t.heading),"°"]})]})]}),a.jsxs("div",{className:"flex gap-2",children:[a.jsxs("button",{className:"flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-colors text-sm font-medium",children:[a.jsx(c,{size:14}),"Directions"]}),a.jsxs("button",{className:"flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium",children:[a.jsx(o,{size:14}),"Details"]})]})]})]});var p},ve=({onEditGeofence:t,onDeleteGeofence:s,onCreateGeofence:n})=>{const{geofences:r,isLoading:i}=me(),[l,c]=e.useState(null);e.useEffect(()=>{console.log("[GeofenceManager] Geofences updated:",{count:r.length,geofences:r.map(e=>({id:e.id,name:e.name,isActive:e.isActive})),isLoading:i})},[r,i]);const v=e=>{switch(e){case"home":return a.jsx(b,{className:"text-blue-500",size:20});case"school":return a.jsx(y,{className:"text-green-500",size:20});case"work":return a.jsx(x,{className:"text-purple-500",size:20});default:return a.jsx(o,{className:"text-gray-500",size:20})}};return i?a.jsx("div",{className:"p-6",children:a.jsx("div",{className:"flex items-center justify-center py-12",children:a.jsx(J,{size:"medium"})})}):a.jsxs("div",{className:"p-6",children:[a.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6",children:[a.jsxs("div",{children:[a.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Geofences"}),a.jsx("p",{className:"text-gray-600 mt-1",children:"Set up location alerts for your family"})]}),a.jsxs("button",{onClick:()=>{n&&n()},className:"flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl hover:from-purple-700 hover:to-indigo-700 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5",children:[a.jsx(d,{size:20}),a.jsx("span",{className:"font-semibold",children:"Add Geofence"})]})]}),0===r.length?a.jsxs("div",{className:"bg-white rounded-2xl p-12 shadow-lg border border-gray-100 text-center",children:[a.jsx("div",{className:"w-20 h-20 bg-gradient-to-br from-purple-100 to-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4",children:a.jsx(o,{size:36,className:"text-purple-600"})}),a.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"No geofences yet"}),a.jsx("p",{className:"text-gray-600 mb-6 max-w-md mx-auto",children:"Create your first geofence to start receiving location alerts when family members enter or leave specific areas"}),a.jsx("button",{onClick:()=>{n&&n()},className:"px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl hover:from-purple-700 hover:to-indigo-700 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 font-semibold",children:a.jsxs("span",{className:"flex items-center gap-2",children:[a.jsx(d,{size:18}),"Create Your First Geofence"]})})]}):a.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:r.map(e=>{return a.jsx("div",{className:`bg-white rounded-xl border-2 transition-all hover:shadow-lg ${l===e.id?"shadow-lg border-purple-300":"shadow-sm border-gray-200 hover:border-purple-200"} ${e.isActive?"":"opacity-60"}`,children:a.jsxs("div",{className:"p-5",children:[a.jsxs("div",{className:"flex items-start justify-between mb-3",children:[a.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[a.jsx("div",{className:"w-12 h-12 rounded-xl flex items-center justify-center "+("home"===e.type?"bg-blue-100":"school"===e.type?"bg-green-100":"work"===e.type?"bg-purple-100":"bg-gray-100"),children:v(e.type)}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsx("h3",{className:"font-bold text-gray-900 text-lg mb-1",children:e.name}),a.jsxs("p",{className:"text-sm text-gray-600 flex items-center gap-2",children:[a.jsx("span",{className:"capitalize",children:e.type}),a.jsx("span",{children:"•"}),a.jsx("span",{children:(n=e.radius,n<1e3?`${Math.round(n)}m`:`${(n/1e3).toFixed(1)}km`)})]})]})]}),a.jsx("div",{className:"flex items-center gap-1",children:e.isActive?a.jsx(u,{className:"text-green-500",size:20}):a.jsx(g,{className:"text-gray-400",size:20})})]}),a.jsxs("div",{className:"flex flex-wrap gap-2 mb-3",children:[e.alertOnEntry&&a.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-green-50 text-green-700 rounded-md text-xs font-medium",children:[a.jsx(g,{size:12}),"Entry Alert"]}),e.alertOnExit&&a.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-orange-50 text-orange-700 rounded-md text-xs font-medium",children:[a.jsx(g,{size:12}),"Exit Alert"]})]}),a.jsxs("div",{className:"flex items-center justify-between pt-3 border-t border-gray-100",children:[a.jsx("div",{className:"flex items-center gap-2",children:a.jsx("button",{onClick:()=>{},className:"flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium transition-colors "+(e.isActive?"bg-green-100 text-green-700 hover:bg-green-200":"bg-gray-100 text-gray-600 hover:bg-gray-200"),title:e.isActive?"Disable geofence":"Enable geofence",children:e.isActive?a.jsxs(a.Fragment,{children:[a.jsx(p,{size:16}),"Active"]}):a.jsxs(a.Fragment,{children:[a.jsx(m,{size:16}),"Inactive"]})})}),a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx("button",{onClick:()=>t?.(e),className:"p-2 text-gray-500 hover:text-purple-600 hover:bg-purple-50 rounded-lg transition-colors",title:"Edit geofence",children:a.jsx(f,{size:18})}),a.jsx("button",{onClick:()=>{confirm(`Are you sure you want to delete "${e.name}"?`)&&s?.(e.id)},className:"p-2 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors",title:"Delete geofence",children:a.jsx(h,{size:18})})]})]}),l===e.id&&a.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-200",children:[a.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm mb-4",children:[a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-600 block mb-1",children:"Latitude:"}),a.jsx("p",{className:"font-mono text-xs font-medium",children:e.center.latitude.toFixed(6)})]}),a.jsxs("div",{children:[a.jsx("span",{className:"text-gray-600 block mb-1",children:"Longitude:"}),a.jsx("p",{className:"font-mono text-xs font-medium",children:e.center.longitude.toFixed(6)})]})]}),e.description&&a.jsxs("div",{className:"mt-3 pt-3 border-t border-gray-100",children:[a.jsx("span",{className:"text-gray-600 text-xs font-medium block mb-1",children:"Description:"}),a.jsx("p",{className:"text-sm text-gray-700",children:e.description})]})]})]})},e.id);var n})})]})},we=({isOpen:t,onClose:s,onSave:n,initialLocation:r,geofence:i})=>{console.log("[GeofenceMapEditor] Component rendered",{isOpen:t,hasGeofence:!!i,geofenceId:i?.id,initialLocation:r});const{currentHub:l}=Y(),{currentLocation:d}=ce(),u=e.useRef(null),g=e.useRef(null),p=e.useRef(null),m=e.useRef(null),f=e.useRef([]),h=e.useRef(null),j=d?{latitude:d.latitude,longitude:d.longitude}:r;console.log("[GeofenceMapEditor] Location data:",{currentLocation:d?{lat:d.latitude,lng:d.longitude}:null,initialLocation:r,bestLocation:j?{lat:j.latitude,lng:j.longitude}:null});const[E,N]=e.useState(!1),[C,G]=e.useState(!1),[M,k]=e.useState(!1),[S,I]=e.useState({name:i?.name||"",description:i?.description||"",type:i?.type||"custom",center:i?.center||j||{latitude:0,longitude:0},radius:i?.radius||100,alertOnEntry:void 0===i?.alertOnEntry||i.alertOnEntry,alertOnExit:void 0===i?.alertOnExit||i.alertOnExit,alertRecipients:[]}),L=e.useRef(!1),F=e.useRef(!1),A=e.useRef(S),z=e.useRef(i),P=e.useRef(!1),O=e.useRef(!1);e.useEffect(()=>{L.current=C,F.current=M},[C,M]),e.useEffect(()=>{A.current=S},[S]),e.useEffect(()=>{z.current=i},[i]),console.log("[GeofenceMapEditor] Form data initialized:",{name:S.name,center:S.center,radius:S.radius,type:S.type}),e.useEffect(()=>{if(console.log("[GeofenceMapEditor] Form data effect triggered",{isOpen:t,hasGeofence:!!i,geofenceId:i?.id,bestLocation:j?{lat:j.latitude,lng:j.longitude}:null,hasInitialized:P.current,currentPlacementMode:L.current}),!t)return P.current=!1,void(O.current=!1);if(O.current||L.current||C)console.log("[GeofenceMapEditor] Placement mode is active, skipping form data effect to preserve user state",{userActivated:O.current,refValue:L.current,stateValue:C,hasInitialized:P.current});else if(P.current&&i?.id)i&&(console.log("[GeofenceMapEditor] Geofence prop changed, updating form data"),I(e=>({...e,name:i.name,description:i.description||"",type:i.type,center:i.center,radius:i.radius,alertOnEntry:void 0===i.alertOnEntry||i.alertOnEntry,alertOnExit:void 0===i.alertOnExit||i.alertOnExit})),k(!0),G(!1));else if(i&&t)console.log("[GeofenceMapEditor] Editing existing geofence:",i),I(e=>({...e,name:i.name,description:i.description||"",type:i.type,center:i.center,radius:i.radius,alertOnEntry:void 0===i.alertOnEntry||i.alertOnEntry,alertOnExit:void 0===i.alertOnExit||i.alertOnExit})),k(!0),G(!1),P.current=!0,console.log("[GeofenceMapEditor] Form data updated for editing, hasPlacedCenter: true");else if(!i&&t){console.log("[GeofenceMapEditor] Creating new geofence");const e=C||L.current;P.current?console.log("[GeofenceMapEditor] Already initialized, preserving all state (placement mode, placed center)",{currentPlacementMode:C,refPlacementMode:L.current,hasPlacedCenter:M}):(k(!1),e?console.log("[GeofenceMapEditor] User has activated placement mode, preserving it during initialization"):G(!1),j&&0!==j.latitude&&0!==j.longitude?(console.log("[GeofenceMapEditor] Setting initial location from bestLocation:",j),I(e=>0===e.center.latitude&&0===e.center.longitude?(console.log("[GeofenceMapEditor] Updating form data with bestLocation"),{...e,name:"",description:"",type:"custom",center:j,radius:100,alertOnEntry:!0,alertOnExit:!0,alertRecipients:[]}):(console.log("[GeofenceMapEditor] Form data center already set, skipping update"),e))):console.warn("[GeofenceMapEditor] No bestLocation available for new geofence"),P.current=!0,console.log("[GeofenceMapEditor] Initialization complete, hasInitialized set to true"))}},[i,t,j]);const R=e=>{switch(e){case"home":return"#3B82F6";case"school":return"#10B981";case"work":return"#8B5CF6";default:return"#6B7280"}},D=e.useCallback(()=>{if(console.log("[GeofenceMapEditor] createResizeMarkers called",{hasGoogleMap:!!g.current,hasCircle:!!p.current}),!g.current||!p.current)return void console.warn("[GeofenceMapEditor] Cannot create resize markers - map or circle not available");f.current.forEach(e=>{e&&(google.maps.event.clearInstanceListeners(e),e.setMap(null))}),f.current=[];const e=p.current.getCenter();if(!e)return void console.warn("[GeofenceMapEditor] Circle has no center, cannot create resize markers");const t=p.current.getRadius(),s=R(S.type);console.log("[GeofenceMapEditor] Creating resize markers",{center:{lat:e.lat(),lng:e.lng()},radius:t,color:s});[0,90,180,270].forEach(n=>{const r=google.maps.geometry.spherical.computeOffset(e,t,n),a=new google.maps.Marker({position:r,map:g.current,title:"Drag to resize",draggable:!C,icon:{path:google.maps.SymbolPath.CIRCLE,scale:10,fillColor:"#FFFFFF",fillOpacity:1,strokeColor:s,strokeWeight:3},zIndex:999,optimized:!1,visible:!C});a.addListener("drag",()=>{if(C)return;const e=a.getPosition(),t=p.current?.getCenter();if(e&&t){const s=google.maps.geometry.spherical.computeDistanceBetween(t,e),n=Math.max(10,Math.min(5e3,s));I(e=>Math.abs(e.radius-n)<1?e:{...e,radius:n}),p.current&&p.current.setRadius(n)}}),f.current.push(a)}),console.log("[GeofenceMapEditor] Resize markers created:",f.current.length)},[S.type,C]);e.useEffect(()=>{if(console.log("[GeofenceMapEditor] Click listener effect triggered",{isMapLoaded:E,hasGoogleMap:!!g.current,isOpen:t,hasClickListener:!!h.current}),t)if(E){if(g.current)return console.log("[GeofenceMapEditor] Setting up map click listener",{isPlacementMode:L.current,hasPlacedCenter:F.current,hasGeofence:!!z.current,mapReady:!!g.current}),h.current&&(console.log("[GeofenceMapEditor] Removing existing click listener"),google.maps.event.removeListener(h.current),h.current=null),h.current=google.maps.event.addListener(g.current,"click",e=>{const t=L.current,s=F.current,n=z.current,r=A.current;if(console.log("[GeofenceMapEditor] Map clicked",{hasLatLng:!!e.latLng,latLng:e.latLng?{lat:e.latLng.lat(),lng:e.latLng.lng()}:null,isPlacementMode:t,hasPlacedCenter:s,hasGeofence:!!n}),!e.latLng)return void console.warn("[GeofenceMapEditor] Click event has no latLng");const a=e.latLng.lat(),o=e.latLng.lng();if(console.log("[GeofenceMapEditor] Map clicked - processing",{lat:a,lng:o,isPlacementMode:t,hasGeofence:!!n}),t){if(console.log("[GeofenceMapEditor] In placement mode - placing geofence at:",{lat:a,lng:o}),I(e=>(console.log("[GeofenceMapEditor] Updating formData center",{old:e.center,new:{latitude:a,longitude:o}}),{...e,center:{latitude:a,longitude:o}})),console.log("[GeofenceMapEditor] Exiting placement mode and creating geofence"),O.current=!1,L.current=!1,k(!0),G(!1),g.current&&g.current.setOptions({draggable:!0,draggableCursor:"default"}),m.current)console.log("[GeofenceMapEditor] Updating existing center marker position"),m.current.setPosition(new google.maps.LatLng(a,o));else{console.log("[GeofenceMapEditor] Creating center marker");const e=new google.maps.LatLng(a,o),t=R(r.type);m.current=new google.maps.Marker({position:e,map:g.current,title:"Geofence Center",draggable:!0,icon:{path:google.maps.SymbolPath.CIRCLE,scale:12,fillColor:t,fillOpacity:1,strokeColor:"#FFFFFF",strokeWeight:3},zIndex:1e3,optimized:!1}),m.current.addListener("drag",e=>{e.latLng&&(console.log("[GeofenceMapEditor] Center marker dragged",{lat:e.latLng.lat(),lng:e.latLng.lng()}),I(t=>({...t,center:{latitude:e.latLng.lat(),longitude:e.latLng.lng()}})))}),console.log("[GeofenceMapEditor] Center marker created and drag listener added")}if(p.current){if(console.log("[GeofenceMapEditor] Updating existing circle"),p.current.setCenter(new google.maps.LatLng(a,o)),f.current.length>0&&p.current){const e=p.current.getCenter();if(e){const t=p.current.getRadius(),s=[0,90,180,270];f.current.forEach((n,r)=>{if(n&&e){const a=google.maps.geometry.spherical.computeOffset(e,t,s[r]);n.setPosition(a)}})}}else if(p.current){const e=p.current.getCenter();if(e&&g.current){const t=p.current.getRadius(),s=R(r.type),n=[0,90,180,270];f.current.forEach(e=>{e&&(google.maps.event.clearInstanceListeners(e),e.setMap(null))}),f.current=[],n.forEach(n=>{const r=google.maps.geometry.spherical.computeOffset(e,t,n),a=new google.maps.Marker({position:r,map:g.current,title:"Drag to resize",draggable:!0,icon:{path:google.maps.SymbolPath.CIRCLE,scale:10,fillColor:"#FFFFFF",fillOpacity:1,strokeColor:s,strokeWeight:3},zIndex:999,optimized:!1});a.addListener("drag",()=>{const e=a.getPosition(),t=p.current?.getCenter();if(e&&t){const s=google.maps.geometry.spherical.computeDistanceBetween(t,e),n=Math.max(10,Math.min(5e3,s));I(e=>Math.abs(e.radius-n)<1?e:{...e,radius:n}),p.current&&p.current.setRadius(n)}}),f.current.push(a)})}}}else{console.log("[GeofenceMapEditor] Creating circle");const e=new google.maps.LatLng(a,o),t=R(r.type);if(p.current=new google.maps.Circle({strokeColor:t,strokeOpacity:.8,strokeWeight:2,fillColor:t,fillOpacity:.2,map:g.current,center:e,radius:r.radius,clickable:!1}),console.log("[GeofenceMapEditor] Circle created, creating resize markers"),g.current&&p.current){f.current.forEach(e=>{e&&(google.maps.event.clearInstanceListeners(e),e.setMap(null))}),f.current=[];const e=p.current.getCenter();if(e){const t=p.current.getRadius(),s=R(r.type);[0,90,180,270].forEach(n=>{const r=google.maps.geometry.spherical.computeOffset(e,t,n),a=new google.maps.Marker({position:r,map:g.current,title:"Drag to resize",draggable:!0,icon:{path:google.maps.SymbolPath.CIRCLE,scale:10,fillColor:"#FFFFFF",fillOpacity:1,strokeColor:s,strokeWeight:3},zIndex:999,optimized:!1});a.addListener("drag",()=>{const e=a.getPosition(),t=p.current?.getCenter();if(e&&t){const s=google.maps.geometry.spherical.computeDistanceBetween(t,e),n=Math.max(10,Math.min(5e3,s));I(e=>Math.abs(e.radius-n)<1?e:{...e,radius:n}),p.current&&p.current.setRadius(n)}}),f.current.push(a)}),console.log("[GeofenceMapEditor] Resize markers created:",f.current.length)}}}}else n?(console.log("[GeofenceMapEditor] Editing geofence - updating center"),I(e=>({...e,center:{latitude:a,longitude:o}}))):console.log("[GeofenceMapEditor] Click ignored - not in placement mode and not editing")}),console.log("[GeofenceMapEditor] Map click listener added successfully"),()=>{h.current&&g.current&&(console.log("[GeofenceMapEditor] Removing click listener on cleanup"),google.maps.event.removeListener(h.current),h.current=null)};console.warn("[GeofenceMapEditor] Google map ref is null, cannot set up click listener")}else console.log("[GeofenceMapEditor] Map not loaded yet, skipping click listener setup");else console.log("[GeofenceMapEditor] Modal not open, skipping click listener setup")},[E,t]),e.useEffect(()=>{if(!E||!g.current||!i||m.current||p.current)return;console.log("[GeofenceMapEditor] Creating markers for existing geofence");const e=new google.maps.LatLng(S.center.latitude,S.center.longitude),t=R(S.type);m.current=new google.maps.Marker({position:e,map:g.current,title:"Geofence Center",draggable:!0,icon:{path:google.maps.SymbolPath.CIRCLE,scale:12,fillColor:t,fillOpacity:1,strokeColor:"#FFFFFF",strokeWeight:3},zIndex:1e3,optimized:!1}),m.current.addListener("drag",e=>{e.latLng&&(console.log("[GeofenceMapEditor] Editing: Center marker dragged",{lat:e.latLng.lat(),lng:e.latLng.lng()}),I(t=>({...t,center:{latitude:e.latLng.lat(),longitude:e.latLng.lng()}})))}),p.current=new google.maps.Circle({strokeColor:t,strokeOpacity:.8,strokeWeight:2,fillColor:t,fillOpacity:.2,map:g.current,center:e,radius:S.radius,clickable:!1}),console.log("[GeofenceMapEditor] Created markers and circle for existing geofence"),D()},[E,i,S.center.latitude,S.center.longitude,S.radius,S.type,D]),e.useEffect(()=>{if(console.log("[GeofenceMapEditor] Map draggability effect triggered",{hasGoogleMap:!!g.current,isPlacementMode:C,hasPlacedCenter:M}),!g.current)return void console.log("[GeofenceMapEditor] Google map ref is null, skipping draggability update");const e=!C&&M;console.log("[GeofenceMapEditor] Updating map draggability",{draggable:e,cursor:C?"crosshair":"default"}),g.current.setOptions({draggable:e,draggableCursor:C?"crosshair":"default"}),console.log("[GeofenceMapEditor] Map draggability updated")},[C,M]),e.useEffect(()=>{if(console.log("[GeofenceMapEditor] Visualization update effect triggered",{isMapLoaded:E,hasGoogleMap:!!g.current,formDataCenter:S.center,hasPlacedCenter:M,hasGeofence:!!i,isPlacementMode:C}),!E||!g.current)return void console.log("[GeofenceMapEditor] Map not loaded yet, skipping visualization update");if(0===S.center.latitude&&0===S.center.longitude)return void console.log("[GeofenceMapEditor] Form data center is at origin, skipping visualization update");if(!M&&!i)return void console.log("[GeofenceMapEditor] Center not placed yet and not editing, skipping visualization");const e=new google.maps.LatLng(S.center.latitude,S.center.longitude),t=R(S.type);if(console.log("[GeofenceMapEditor] Updating visualization",{center:{lat:S.center.latitude,lng:S.center.longitude},radius:S.radius,color:t,hasCenterMarker:!!m.current,hasCircle:!!p.current}),m.current)console.log("[GeofenceMapEditor] Updating center marker position and style"),m.current.setPosition(e),m.current.setIcon({path:google.maps.SymbolPath.CIRCLE,scale:12,fillColor:t,fillOpacity:1,strokeColor:"#FFFFFF",strokeWeight:3}),m.current.setDraggable(!C);else if(M||i){console.log("[GeofenceMapEditor] Creating center marker (should have been created earlier)");const t=R(S.type);m.current=new google.maps.Marker({position:e,map:g.current,title:"Geofence Center",draggable:!C,icon:{path:google.maps.SymbolPath.CIRCLE,scale:12,fillColor:t,fillOpacity:1,strokeColor:"#FFFFFF",strokeWeight:3},zIndex:1e3,optimized:!1}),m.current.addListener("drag",e=>{e.latLng&&(console.log("[GeofenceMapEditor] Center marker dragged",{lat:e.latLng.lat(),lng:e.latLng.lng()}),I(t=>({...t,center:{latitude:e.latLng.lat(),longitude:e.latLng.lng()}})))})}if(p.current?(console.log("[GeofenceMapEditor] Updating circle position and style"),p.current.setCenter(e),p.current.setRadius(S.radius),p.current.setOptions({strokeColor:t,fillColor:t})):(M||i)&&(console.log("[GeofenceMapEditor] Creating circle (should have been created earlier)"),p.current=new google.maps.Circle({strokeColor:t,strokeOpacity:.8,strokeWeight:2,fillColor:t,fillOpacity:.2,map:g.current,center:e,radius:S.radius,clickable:!1}),D()),p.current&&4===f.current.length&&(M||i)){const e=p.current.getCenter();if(e){console.log("[GeofenceMapEditor] Updating resize markers positions");const s=[0,90,180,270];f.current.forEach((n,r)=>{if(n){const a=google.maps.geometry.spherical.computeOffset(e,S.radius,s[r]);n.setPosition(a),n.setIcon({path:google.maps.SymbolPath.CIRCLE,scale:10,fillColor:"#FFFFFF",fillOpacity:1,strokeColor:t,strokeWeight:3}),n.setDraggable(!C),n.setVisible(!C)}})}}else p.current&&(M||i)&&0===f.current.length&&(console.log("[GeofenceMapEditor] Resize markers missing, creating them"),D())},[S.center.latitude,S.center.longitude,S.radius,S.type,E,M,C,i,D]),e.useEffect(()=>{!i&&l?.members&&0===S.alertRecipients.length&&I(e=>({...e,alertRecipients:[]}))},[i,l]),e.useEffect(()=>{if(console.log("[GeofenceMapEditor] Map initialization effect triggered",{isOpen:t,hasMapRef:!!u.current,hasGoogleMap:!!g.current,hasGeofence:!!i,bestLocation:j?{lat:j.latitude,lng:j.longitude}:null}),!t)return void console.log("[GeofenceMapEditor] Modal is not open, skipping map initialization");if(!u.current)return void console.warn("[GeofenceMapEditor] Map ref is not available");if(g.current)return void console.log("[GeofenceMapEditor] Map already initialized, skipping");if(!(i||j&&0!==j.latitude&&0!==j.longitude))return console.log("[GeofenceMapEditor] Waiting for location to be available"),console.log("[GeofenceMapEditor] bestLocation:",j),void console.log("[GeofenceMapEditor] currentLocation:",d);console.log("[GeofenceMapEditor] Starting map initialization");let e=!0;return ae.load().then(t=>{if(console.log("[GeofenceMapEditor] Google Maps loaded"),!e)return void console.log("[GeofenceMapEditor] Component unmounted, aborting map initialization");if(!u.current)return void console.warn("[GeofenceMapEditor] Map ref is null after load");let s;i?(s=i.center,console.log("[GeofenceMapEditor] Using geofence center:",s)):j&&0!==j.latitude&&0!==j.longitude?(s=j,console.log("[GeofenceMapEditor] Using bestLocation:",s)):(console.warn("[GeofenceMapEditor] No location available, using default (San Francisco)"),s={latitude:37.7749,longitude:-122.4194});const n=new t.maps.LatLng(s.latitude,s.longitude);console.log("[GeofenceMapEditor] Creating map with center:",s);try{g.current=new t.maps.Map(u.current,{center:n,zoom:15,mapTypeControl:!0,streetViewControl:!0,fullscreenControl:!0,zoomControl:!0,disableDefaultUI:!1}),console.log("[GeofenceMapEditor] Map created successfully"),i||(console.log("[GeofenceMapEditor] Updating formData with centerCoords"),I(e=>({...e,center:s}))),N(!0),console.log("[GeofenceMapEditor] isMapLoaded set to true - map is ready"),t.maps.event.addListenerOnce(g.current,"idle",()=>{console.log("[GeofenceMapEditor] Map is idle (fully loaded and ready)")})}catch(r){console.error("[GeofenceMapEditor] Error creating map:",r)}}).catch(e=>{console.error("[GeofenceMapEditor] Error loading Google Maps:",e)}),()=>{console.log("[GeofenceMapEditor] Cleaning up map initialization effect"),e=!1}},[t,i,j]);const T=[{value:"home",label:"Home",icon:a.jsx(b,{size:20})},{value:"school",label:"School",icon:a.jsx(y,{size:20})},{value:"work",label:"Work",icon:a.jsx(x,{size:20})},{value:"custom",label:"Custom",icon:a.jsx(o,{size:20})}];return console.log("[GeofenceMapEditor] Render check",{isOpen:t,hasGeofence:!!i,isMapLoaded:E,hasPlacedCenter:M,isPlacementMode:C,formDataCenter:S.center}),t?a.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:a.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden",children:[a.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(o,{size:24,className:"text-purple-600"}),a.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:i?"Edit Geofence":"Create Geofence"})]}),a.jsx("button",{onClick:s,className:"p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors",children:a.jsx(v,{size:20})})]}),a.jsxs("div",{className:"flex h-[600px]",children:[a.jsxs("div",{className:"flex-1 relative",children:[a.jsx("div",{ref:u,className:"w-full h-full",style:{minHeight:"400px"}}),(!E||!i&&(!j||0===j.latitude))&&a.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-100",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-2"}),a.jsx("p",{className:"text-gray-600",children:i||j&&0!==j.latitude?"Loading map...":"Waiting for your location..."})]})}),a.jsx("div",{className:"absolute top-4 left-4 bg-white bg-opacity-95 backdrop-blur-sm rounded-lg p-3 shadow-lg z-10",children:C?a.jsxs(a.Fragment,{children:[a.jsx("p",{className:"text-sm font-medium text-purple-600 mb-1",children:"📍 Placement Mode Active"}),a.jsx("p",{className:"text-xs text-gray-700",children:"Click anywhere on the map to place the geofence center"})]}):M||i?a.jsxs(a.Fragment,{children:[a.jsx("p",{className:"text-sm text-gray-700 font-medium",children:i?"Editing geofence":"Geofence placed"}),a.jsx("p",{className:"text-xs text-gray-600 mt-1",children:"• Drag center marker to move"}),a.jsx("p",{className:"text-xs text-gray-600",children:"• Drag white dots to resize radius"}),!i&&a.jsx("p",{className:"text-xs text-gray-600",children:'• Click "Place Geofence" to reposition'})]}):a.jsxs(a.Fragment,{children:[a.jsx("p",{className:"text-sm text-gray-700 font-medium",children:"Ready to create geofence"}),a.jsx("p",{className:"text-xs text-gray-600 mt-1",children:'Click "Place Geofence" button to start'})]})}),!i&&a.jsxs("div",{className:"absolute top-4 right-4 flex flex-col gap-2 z-10",children:[!M&&!C&&a.jsxs("button",{type:"button",onClick:()=>{console.log("[GeofenceMapEditor] Place Geofence button clicked"),console.log("[GeofenceMapEditor] Current state:",{hasPlacedCenter:M,isPlacementMode:C,hasGoogleMap:!!g.current,formDataCenter:S.center}),O.current=!0,L.current=!0,console.log("[GeofenceMapEditor] Refs set to true immediately"),G(!0),console.log("[GeofenceMapEditor] isPlacementMode state set to true"),g.current?(console.log("[GeofenceMapEditor] Updating map options - disabling dragging"),g.current.setOptions({draggable:!1,draggableCursor:"crosshair"}),console.log("[GeofenceMapEditor] Map options updated")):console.warn("[GeofenceMapEditor] Google map ref is null, cannot update options")},className:"bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 transition-colors font-medium",children:[a.jsx(w,{size:16}),a.jsx("span",{className:"text-sm",children:"Place Geofence"})]}),C&&a.jsxs("button",{type:"button",onClick:()=>{console.log("[GeofenceMapEditor] Cancel button clicked"),O.current=!1,L.current=!1,G(!1),console.log("[GeofenceMapEditor] Placement mode cancelled - refs and state updated"),g.current&&(console.log("[GeofenceMapEditor] Re-enabling map dragging"),g.current.setOptions({draggable:!0,draggableCursor:"default"}),console.log("[GeofenceMapEditor] Map options updated"))},className:"bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 transition-colors font-medium",children:[a.jsx(v,{size:16}),a.jsx("span",{className:"text-sm",children:"Cancel"})]}),M&&!C&&a.jsxs("button",{type:"button",onClick:()=>{G(!0),g.current&&g.current.setOptions({draggable:!1,draggableCursor:"crosshair"})},className:"bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 transition-colors font-medium",children:[a.jsx(w,{size:16}),a.jsx("span",{className:"text-sm",children:"Reposition"})]}),!C&&j&&0!==j.latitude&&a.jsxs("button",{type:"button",onClick:()=>{if(j&&g.current){const e=new google.maps.LatLng(j.latitude,j.longitude);g.current.setCenter(e),g.current.setZoom(15),I(e=>({...e,center:j})),m.current&&m.current.setPosition(e)}},className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 transition-colors font-medium",children:[a.jsx(c,{size:16}),a.jsx("span",{className:"text-sm",children:"My Location"})]})]})]}),a.jsx("div",{className:"w-80 border-l border-gray-200 p-6 overflow-y-auto",children:a.jsxs("form",{onSubmit:e=>{e.preventDefault(),console.log("[GeofenceMapEditor] Form submitted",{name:S.name,center:S.center,radius:S.radius,hasPlacedCenter:M,hasGeofence:!!i}),S.name.trim()?M||i?0!==S.center.latitude||0!==S.center.longitude?(console.log("[GeofenceMapEditor] Calling onSave with data:",S),n({...S,alertRecipients:S.alertRecipients.length>0?S.alertRecipients:[]})):console.warn("[GeofenceMapEditor] Form validation failed - center is at origin"):console.warn("[GeofenceMapEditor] Form validation failed - center not placed"):console.warn("[GeofenceMapEditor] Form validation failed - name is empty")},className:"space-y-6",children:[a.jsxs("div",{children:[a.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Geofence Details"}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Name *"}),a.jsx("input",{type:"text",value:S.name,onChange:e=>I(t=>({...t,name:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent",placeholder:"e.g., Home, School, Work",required:!0})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Description"}),a.jsx("textarea",{value:S.description,onChange:e=>I(t=>({...t,description:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent",placeholder:"Optional description...",rows:3})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Type"}),a.jsx("div",{className:"grid grid-cols-2 gap-2",children:T.map(e=>a.jsxs("label",{className:"flex items-center gap-2 p-2 border-2 rounded-lg cursor-pointer transition-colors "+(S.type===e.value?"border-purple-500 bg-purple-50":"border-gray-200 hover:border-gray-300"),children:[a.jsx("input",{type:"radio",name:"type",value:e.value,checked:S.type===e.value,onChange:e=>I(t=>({...t,type:e.target.value})),className:"sr-only"}),e.icon,a.jsx("span",{className:"text-sm font-medium",children:e.label})]},e.value))})]})]})]}),a.jsxs("div",{children:[a.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Location"}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"space-y-2 text-sm",children:[a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{className:"text-gray-600",children:"Latitude:"}),a.jsx("span",{className:"font-mono text-xs",children:S.center.latitude.toFixed(6)})]}),a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{className:"text-gray-600",children:"Longitude:"}),a.jsx("span",{className:"font-mono text-xs",children:S.center.longitude.toFixed(6)})]})]}),a.jsxs("div",{children:[a.jsxs("div",{className:"flex items-center justify-between mb-2",children:[a.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Radius"}),a.jsx("span",{className:"text-sm font-bold text-purple-600",children:S.radius<1e3?`${Math.round(S.radius)}m`:`${(S.radius/1e3).toFixed(1)}km`})]}),a.jsx("input",{type:"range",min:"10",max:"5000",step:"10",value:S.radius,onChange:e=>{const t=parseInt(e.target.value,10);I(e=>({...e,radius:t}))},className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider",style:{background:`linear-gradient(to right, #9333ea 0%, #9333ea ${S.radius/5e3*100}%, #e5e7eb ${S.radius/5e3*100}%, #e5e7eb 100%)`}}),a.jsxs("div",{className:"flex justify-between text-xs text-gray-500 mt-1",children:[a.jsx("span",{children:"10m"}),a.jsx("span",{children:"5km"})]})]})]})]}),a.jsxs("div",{children:[a.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Alert Settings"}),a.jsxs("div",{className:"space-y-3",children:[a.jsxs("label",{className:"flex items-center gap-3",children:[a.jsx("input",{type:"checkbox",checked:S.alertOnEntry,onChange:e=>I(t=>({...t,alertOnEntry:e.target.checked})),className:"w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500"}),a.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Alert when entering this area"})]}),a.jsxs("label",{className:"flex items-center gap-3",children:[a.jsx("input",{type:"checkbox",checked:S.alertOnExit,onChange:e=>I(t=>({...t,alertOnExit:e.target.checked})),className:"w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500"}),a.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Alert when leaving this area"})]})]}),a.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"Alerts will be sent to all hub members"})]}),a.jsxs("div",{className:"flex gap-3 pt-6 border-t border-gray-200",children:[a.jsx("button",{type:"button",onClick:s,className:"flex-1 px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors",children:"Cancel"}),a.jsx("button",{type:"submit",className:"flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors",children:i?"Update":"Create"})]})]})})]})]})}):(console.log("[GeofenceMapEditor] Modal is not open, returning null"),null)},je=({geofence:e,isOpen:t,onClose:s,onEdit:n,onDelete:r})=>{if(!t||!e)return null;const i=e=>new Intl.DateTimeFormat("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}).format(e);return a.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:a.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto",children:[a.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[(e=>{switch(e){case"home":return a.jsx(b,{className:"text-blue-500",size:24});case"school":return a.jsx(y,{className:"text-green-500",size:24});case"work":return a.jsx(x,{className:"text-purple-500",size:24});default:return a.jsx(o,{className:"text-gray-500",size:24})}})(e.type),a.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:e.name})]}),a.jsx("button",{onClick:s,className:"p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors","aria-label":"Close",children:a.jsx(v,{size:20})})]}),a.jsxs("div",{className:"p-6 space-y-6",children:[e.description&&a.jsxs("div",{children:[a.jsx("h3",{className:"text-sm font-semibold text-gray-700 mb-2",children:"Description"}),a.jsx("p",{className:"text-gray-600",children:e.description})]}),a.jsxs("div",{children:[a.jsx("h3",{className:"text-sm font-semibold text-gray-700 mb-3",children:"Location"}),a.jsxs("div",{className:"space-y-2 text-sm",children:[a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{className:"text-gray-600",children:"Latitude:"}),a.jsx("span",{className:"font-mono text-gray-900",children:e.center.latitude.toFixed(6)})]}),a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{className:"text-gray-600",children:"Longitude:"}),a.jsx("span",{className:"font-mono text-gray-900",children:e.center.longitude.toFixed(6)})]}),a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{className:"text-gray-600",children:"Radius:"}),a.jsx("span",{className:"font-medium text-gray-900",children:(l=e.radius,l<1e3?`${Math.round(l)}m`:`${(l/1e3).toFixed(1)}km`)})]})]})]}),a.jsxs("div",{children:[a.jsxs("h3",{className:"text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2",children:[a.jsx(g,{size:16}),"Alert Settings"]}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[a.jsx("span",{className:"text-sm text-gray-700",children:"Entry Alerts"}),a.jsx("span",{className:"px-3 py-1 rounded-full text-xs font-medium "+(e.alertOnEntry?"bg-green-100 text-green-700":"bg-gray-100 text-gray-600"),children:e.alertOnEntry?"Enabled":"Disabled"})]}),a.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[a.jsx("span",{className:"text-sm text-gray-700",children:"Exit Alerts"}),a.jsx("span",{className:"px-3 py-1 rounded-full text-xs font-medium "+(e.alertOnExit?"bg-green-100 text-green-700":"bg-gray-100 text-gray-600"),children:e.alertOnExit?"Enabled":"Disabled"})]})]})]}),a.jsx("div",{className:"pt-4 border-t border-gray-200",children:a.jsxs("div",{className:"space-y-2 text-xs text-gray-500",children:[a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{children:"Created:"}),a.jsx("span",{children:i(e.createdAt)})]}),a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{children:"Updated:"}),a.jsx("span",{children:i(e.updatedAt)})]}),a.jsxs("div",{className:"flex justify-between",children:[a.jsx("span",{children:"Status:"}),a.jsx("span",{className:"font-medium "+(e.isActive?"text-green-600":"text-gray-500"),children:e.isActive?"Active":"Inactive"})]})]})})]}),a.jsxs("div",{className:"flex gap-3 p-6 border-t border-gray-200",children:[a.jsxs("button",{onClick:()=>{n(e),s()},className:"flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium",children:[a.jsx(f,{size:18}),"Edit"]}),a.jsxs("button",{onClick:()=>{window.confirm(`Are you sure you want to delete "${e.name}"?`)&&(r(e.id),s())},className:"flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors font-medium",children:[a.jsx(h,{size:18}),"Delete"]})]})]})});var l},Ee=()=>{const[t,s]=e.useState([]),[n,r]=e.useState(new Set);e.useEffect(()=>{const e=e=>{const t=e.detail;s(e=>[t,...e]),r(e=>new Set([...e,t.id])),setTimeout(()=>{r(e=>{const s=new Set(e);return s.delete(t.id),s})},5e3)};return window.addEventListener("geofenceAlert",e),()=>{window.removeEventListener("geofenceAlert",e)}},[]),e.useEffect(()=>{const e=he.getAlerts();s(e)},[]);const i=e=>"entry"===e?a.jsx(o,{className:"text-green-600",size:20}):a.jsx(o,{className:"text-red-600",size:20});return 0===t.length?null:a.jsx("div",{className:"fixed top-4 right-4 z-50 space-y-2 max-w-sm",children:t.filter(e=>n.has(e.id)).map(e=>{return a.jsx("div",{className:(t=e.type,"entry"===t?"bg-green-50 border-green-200 text-green-800":"bg-red-50 border-red-200 text-red-800")+" border rounded-lg p-4 shadow-lg animate-slide-in-right",children:a.jsxs("div",{className:"flex items-start gap-3",children:[a.jsx("div",{className:"flex-shrink-0 mt-0.5",children:i(e.type)}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[a.jsx(j,{size:14,className:"text-gray-500"}),a.jsx("span",{className:"text-sm font-medium",children:"Geofence Alert"})]}),a.jsx("p",{className:"text-sm font-semibold mb-1",children:e.message}),a.jsxs("p",{className:"text-xs text-gray-600",children:[e.geofenceName," • ",e.timestamp.toLocaleTimeString()]})]}),a.jsx("button",{onClick:()=>{return t=e.id,r(e=>{const s=new Set(e);return s.delete(t),s}),void he.markAsRead(t);var t},className:"flex-shrink-0 p-1 text-gray-400 hover:text-gray-600 transition-colors","aria-label":"Dismiss alert",children:a.jsx(v,{size:16})})]})},e.id);var t})})},Ne=({isOpen:e,onClose:t})=>{const{currentHub:s,isFeatureEnabled:n}=Y(),{user:r}=Q(),i=E(),l=[{to:"/",icon:a.jsx(o,{size:20}),label:"Map",feature:"location"},{to:"/tasks",icon:a.jsx(N,{size:20}),label:"Tasks",feature:"tasks"},{to:"/messages",icon:a.jsx(C,{size:20}),label:"Messages",feature:"chat"},{to:"/vault",icon:a.jsx(G,{size:20}),label:"Vault",feature:"vault"},{to:"/dashboard",icon:a.jsx(b,{size:20}),label:"Dashboard"},{to:"/settings",icon:a.jsx(M,{size:20}),label:"Settings"}].filter(e=>!e.feature||n(e.feature));return a.jsxs(a.Fragment,{children:[e&&a.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden",onClick:t}),a.jsx("div",{className:"fixed top-0 left-0 h-full w-80 bg-white shadow-2xl z-50 transform transition-transform duration-300 ease-in-out "+(e?"translate-x-0":"-translate-x-full"),children:a.jsxs("div",{className:"flex flex-col h-full",children:[a.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[a.jsxs("div",{children:[a.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Menu"}),s&&a.jsx("p",{className:"text-sm text-gray-500 mt-1",children:s.name})]}),a.jsx("button",{onClick:t,className:"p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors","aria-label":"Close menu",children:a.jsx(v,{size:20})})]}),r&&a.jsx("div",{className:"p-4 border-b border-gray-200 bg-gray-50",children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center text-white font-semibold",children:r.email?.charAt(0).toUpperCase()||"U"}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsx("p",{className:"text-sm font-semibold text-gray-900 truncate",children:r.email?.split("@")[0]||"User"}),a.jsx("p",{className:"text-xs text-gray-500 truncate",children:r.email})]})]})}),a.jsxs("nav",{className:"flex-1 overflow-y-auto py-4",children:[a.jsx("div",{className:"space-y-1 px-2",children:l.map(e=>a.jsxs(k,{to:e.to,onClick:t,className:({isActive:e})=>"flex items-center gap-3 px-4 py-3 rounded-lg transition-colors "+(e?"bg-purple-100 text-purple-700 font-semibold":"text-gray-700 hover:bg-gray-100"),children:[e.icon,a.jsx("span",{children:e.label})]},e.to))}),a.jsx("div",{className:"my-4 border-t border-gray-200"}),s&&a.jsxs("div",{className:"px-4 py-3",children:[a.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600 mb-2",children:[a.jsx(S,{size:16}),a.jsx("span",{className:"font-medium",children:"Hub Members"})]}),a.jsxs("p",{className:"text-xs text-gray-500 pl-6",children:[s.members?.length||0," members"]})]})]}),a.jsx("div",{className:"border-t border-gray-200 p-4",children:a.jsxs("button",{onClick:async()=>{try{await V(X),i("/")}catch(e){console.error("Logout error:",e)}},className:"w-full flex items-center gap-3 px-4 py-3 text-red-600 hover:bg-red-50 rounded-lg transition-colors",children:[a.jsx(I,{size:20}),a.jsx("span",{className:"font-medium",children:"Sign Out"})]})})]})})]})};const Ce=new class{statusCallbacks=new Set;currentStatus=null;batteryMonitor=null;onlineListener=null;updateInterval=null;lastUpdateTime=Date.now();constructor(){this.initializeBatteryMonitoring(),this.initializeOnlineMonitoring(),this.startPeriodicUpdates()}async initializeBatteryMonitoring(){try{if("getBattery"in navigator&&navigator.getBattery){const e=await navigator.getBattery();this.batteryMonitor=e,e.addEventListener("chargingchange",()=>{this.updateStatus()}),e.addEventListener("levelchange",()=>{this.updateStatus()}),this.updateStatus()}else console.log("🔋 Battery Manager API not supported, battery monitoring disabled")}catch(e){console.warn("Failed to initialize battery monitoring:",e)}}initializeOnlineMonitoring(){this.onlineListener=()=>{this.updateStatus()},window.addEventListener("online",this.onlineListener),window.addEventListener("offline",this.onlineListener),this.updateStatus()}startPeriodicUpdates(){this.updateInterval=window.setInterval(()=>{this.updateStatus()},3e4)}async updateStatus(){const e=Date.now();if(e-this.lastUpdateTime<5e3)return;this.lastUpdateTime=e;const t={batteryLevel:null,isCharging:null,isOnline:navigator.onLine,lastSeen:new Date,platform:this.getPlatform(),connectionType:await this.getConnectionType()};if(this.batteryMonitor)try{t.batteryLevel=Math.round(100*this.batteryMonitor.level),t.isCharging=this.batteryMonitor.charging}catch(s){console.warn("Failed to read battery status:",s)}this.currentStatus=t,this.notifyCallbacks(t)}getPlatform(){const e=navigator.userAgent;return/iPad|iPhone|iPod/.test(e)?"iOS":/Android/.test(e)?"Android":/Mac/.test(e)?"macOS":/Win/.test(e)?"Windows":/Linux/.test(e)?"Linux":"Unknown"}async getConnectionType(){try{const e=navigator.connection||navigator.mozConnection||navigator.webkitConnection;if(e){const t=e.effectiveType||e.type;if(t.includes("wifi")||"wifi"===t)return"wifi";if(t.includes("cellular")||t.includes("4g")||t.includes("3g")||t.includes("2g"))return"cellular";if(t.includes("ethernet"))return"ethernet"}}catch(e){console.warn("Failed to get connection type:",e)}return"unknown"}subscribe(e){return this.statusCallbacks.add(e),this.currentStatus?e(this.currentStatus):this.updateStatus(),()=>{this.statusCallbacks.delete(e)}}notifyCallbacks(e){this.statusCallbacks.forEach(t=>{try{t(e)}catch(s){console.error("Error in device status callback:",s)}})}getCurrentStatus(){return this.currentStatus}isBatteryMonitoringSupported(){return null!==this.batteryMonitor}destroy(){this.onlineListener&&(window.removeEventListener("online",this.onlineListener),window.removeEventListener("offline",this.onlineListener)),null!==this.updateInterval&&clearInterval(this.updateInterval),this.statusCallbacks.clear()}},Ge=()=>{const{user:t}=Q(),{currentHub:n}=Y(),[r,a]=e.useState(null),[o,i]=e.useState(!1),l=e.useRef(0),c=e.useRef(null),d=e.useRef(null);e.useEffect(()=>{c.current=t?.id||null,d.current=n?.id||null},[t?.id,n?.id]);const u=s({mutationFn:e=>{const t=c.current,s=d.current;if(!t||!s)throw new Error("User or hub not available");return async function(e,t,s){try{const n=T(H,"hubs",t,"deviceStatus",e),r={userId:e,hubId:t,batteryLevel:s.batteryLevel,isCharging:s.isCharging,isOnline:s.isOnline,lastSeen:s.lastSeen,platform:s.platform,connectionType:s.connectionType,updatedAt:new Date};return await U(n,{...r,lastSeen:s.lastSeen,updatedAt:$()},{merge:!0}),{success:!0}}catch(n){return n instanceof Error&&(n.message.includes("permission")||n.message.includes("Permission")),{success:!1,error:n instanceof Error?n.message:"Failed to update device status"}}}(t,s,e)},onError:e=>{}});e.useEffect(()=>{if(!t||!n)return;i(!0);const e=Ce.subscribe(e=>{a(e);const t=Date.now();t-l.current>3e4&&(l.current=t,c.current&&d.current&&u.mutate(e))});return()=>{e(),i(!1)}},[t?.id,n?.id]);const g=e.useCallback(()=>Ce.getCurrentStatus(),[]);return{deviceStatus:r,isMonitoring:o,isBatterySupported:Ce.isBatteryMonitoringSupported(),getCurrentStatus:g,isLoading:u.isPending,error:u.error}},Me=async e=>{try{const{hubId:t,userId:s,userName:n,coordinates:r,note:a,address:o}=e,i={hubId:t,userId:s,userName:n||null,location:{latitude:r.latitude,longitude:r.longitude},accuracy:r.accuracy||0,timestamp:$(),note:a||null,address:o||null},l=await q((e=>R(H,"hubs",e,"checkIns"))(t),i),c=(e=>({id:e.id,hubId:e.hubId,userId:e.userId,userName:e.userName,location:e.location,accuracy:e.accuracy,timestamp:e.timestamp?.toDate()||new Date,note:e.note,address:e.address}))({id:l.id,...i,timestamp:_.now()});return{success:!0,data:c}}catch(t){return console.error("Error creating check-in:",t),{success:!1,error:t instanceof Error?t.message:"Failed to create check-in"}}},ke=async(e,t)=>{const s=await(async(e,t)=>{try{const s=new((await ae.load()).maps.Geocoder);return new Promise((n,r)=>{s.geocode({location:{lat:e,lng:t}},(s,r)=>{if("OK"===r&&s&&s.length>0){const r=s[0],a=r.address_components||[],o={};a.forEach(e=>{const t=e.types;t.includes("street_number")||t.includes("route")?o.street=e.long_name:t.includes("locality")?o.city=e.long_name:t.includes("administrative_area_level_1")?o.state=e.short_name:t.includes("country")?o.country=e.short_name:t.includes("postal_code")&&(o.postalCode=e.short_name)});const i=r.formatted_address,l=[];o.street&&l.push(o.street),o.city&&l.push(o.city),o.state&&l.push(o.state);const c=l.length>0?l.join(", "):r.formatted_address||`${e}, ${t}`;n({address:c,formattedAddress:i,components:o})}else console.warn("Reverse geocoding failed:",r),n(null)})})}catch(s){return console.warn("Geocoding service not available:",s),null}})(e,t);return s?.address||`${e.toFixed(6)}, ${t.toFixed(6)}`},Se=()=>{const{user:e}=Q(),{currentHub:t}=Y(),a=r(),o=s({mutationFn:async s=>{if(!t?.id||!e?.id)throw new Error("No hub or user selected");let n;try{n=await ke(s.coordinates.latitude,s.coordinates.longitude)}catch(r){console.warn("Failed to get address:",r)}return Me({...s,address:n,hubId:t.id,userId:e.id,userName:e.email?.split("@")[0]||e.displayName||"User"})},onSuccess:s=>{s.success?(a.invalidateQueries({queryKey:["checkIns",t?.id]}),a.invalidateQueries({queryKey:["checkIns",t?.id,e?.id]}),n.success("Checked in successfully!")):n.error(s.error||"Failed to check in")},onError:e=>{console.error("Error creating check-in:",e),n.error("Failed to check in")}});return{createCheckIn:o.mutate,createCheckInAsync:o.mutateAsync,isCheckingIn:o.isPending,error:o.error}},Ie=()=>{const t=E(),{user:s}=Q(),{currentHub:r}=Y(),{locations:i}=de(r?.id),{data:l=[]}=ee(),{data:d}=Z(s?.id),{currentLocation:g,isSharing:p,isWatching:m,error:f,startTracking:h,toggleSharing:x}=ce(),{deviceStatus:y}=Ge(),{getDeviceStatus:b}=ue(r?.id),{createCheckIn:w,isCheckingIn:j}=Se(),{createGeofence:N,updateGeofence:C,deleteGeofence:G}=me(),k=i.filter(e=>e.userId!==s?.id),I=s&&g&&p?[...k,{userId:s.id,hubId:r?.id||"",latitude:g.latitude,longitude:g.longitude,accuracy:g.accuracy,timestamp:new Date(g.timestamp),isSharing:!0,lastUpdated:Date.now()}]:k,[z,P]=e.useState(!0),[O,R]=e.useState(!1),[D,T]=e.useState(!1),[U,_]=e.useState(!1),[B,$]=e.useState(!1),[W,q]=e.useState(!1),[K,V]=e.useState(null),[H,J]=e.useState(null),{geofences:X}=me();return e.useEffect(()=>{console.log("[Geofence] State changed:",{showGeofenceManager:U,showGeofenceEditor:B,showGeofenceDetails:W,editingGeofence:K?.id,selectedGeofence:H?.id,currentLocation:g?{lat:g.latitude,lng:g.longitude}:null,currentHub:r?.id})},[U,B,W,K,H,g,r]),e.useEffect(()=>{!O&&s&&r&&!m&&(R(!0),h())},[s?.id,r?.id]),a.jsxs(a.Fragment,{children:[a.jsxs(L,{children:[a.jsx("title",{children:"Map - Family Safety App"}),a.jsx("meta",{name:"description",content:"Real-time family location map"})]}),a.jsxs("div",{className:"fixed inset-0 flex flex-col bg-gray-50",children:[a.jsx("div",{className:"absolute top-0 left-0 right-0 z-20 bg-white/95 backdrop-blur-md shadow-sm border-b border-gray-200",children:a.jsxs("div",{className:"flex items-center justify-between p-4 safe-top",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("button",{onClick:()=>T(!0),className:"w-10 h-10 bg-white rounded-full shadow-md hover:shadow-lg transition-all duration-200 hover:scale-105 active:scale-95 flex items-center justify-center","aria-label":"Open menu",children:a.jsx(F,{size:20,className:"text-gray-700"})}),a.jsx(te,{})]}),a.jsx("div",{className:"flex items-center gap-2",children:a.jsx("button",{onClick:()=>t("/settings"),className:"w-10 h-10 bg-white rounded-full shadow-md hover:shadow-lg transition-all duration-200 hover:scale-105 active:scale-95 flex items-center justify-center","aria-label":"Settings",children:a.jsx(M,{size:20,className:"text-gray-700"})})})]})}),a.jsxs("div",{className:"flex-1 relative",children:[a.jsx(ye,{height:"100%",zoom:13,showControls:!1,onGeofenceClick:e=>{const t=X.find(t=>t.id===e);t&&(J(t),q(!0))}}),!g&&!f&&a.jsx("div",{className:"absolute top-24 left-1/2 transform -translate-x-1/2 bg-white/95 backdrop-blur-md rounded-xl shadow-lg px-6 py-4 z-20",children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center animate-pulse",children:a.jsx(o,{size:16,className:"text-white"})}),a.jsxs("div",{children:[a.jsx("p",{className:"text-sm font-semibold text-gray-900",children:"Finding your location..."}),a.jsx("p",{className:"text-xs text-gray-600",children:"Please allow location access"})]})]})}),f&&a.jsxs("div",{className:"absolute top-24 left-1/2 transform -translate-x-1/2 bg-red-50 border border-red-200 rounded-xl shadow-lg px-6 py-4 z-20 max-w-md",children:[a.jsx("p",{className:"text-sm text-red-700 font-semibold mb-2",children:"Location Error"}),a.jsx("p",{className:"text-xs text-red-600 mb-3",children:f}),a.jsx("button",{onClick:h,className:"text-xs font-semibold text-red-700 underline hover:no-underline",children:"Try Again"})]}),a.jsxs("div",{className:"absolute top-24 right-4 flex flex-col gap-3 z-10",children:[a.jsxs("div",{className:"group relative",children:[a.jsx("button",{onClick:x,className:"w-14 h-14 rounded-full shadow-lg flex items-center justify-center transition-all duration-200 hover:scale-110 active:scale-95 "+(p?"bg-green-500 hover:bg-green-600 text-white shadow-green-200":"bg-white hover:bg-gray-50 text-gray-700"),"aria-label":p?"Stop sharing location":"Start sharing location",children:a.jsx(o,{size:24})}),a.jsxs("div",{className:"absolute right-full mr-2 top-1/2 -translate-y-1/2 px-3 py-1.5 bg-gray-900 text-white text-xs font-medium rounded-lg whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none",children:[p?"Sharing Location":"Share Location",a.jsx("div",{className:"absolute left-full top-1/2 -translate-y-1/2 border-4 border-transparent border-l-gray-900"})]})]}),a.jsxs("div",{className:"group relative",children:[a.jsx("button",{onClick:()=>{m||h()},className:"w-14 h-14 bg-purple-600 hover:bg-purple-700 rounded-full shadow-lg flex items-center justify-center text-white transition-all duration-200 hover:scale-110 active:scale-95 shadow-purple-200","aria-label":"Center map on my current location",children:a.jsx(c,{size:24})}),a.jsxs("div",{className:"absolute right-full mr-2 top-1/2 -translate-y-1/2 px-3 py-1.5 bg-gray-900 text-white text-xs font-medium rounded-lg whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none",children:["Center on Me",a.jsx("div",{className:"absolute left-full top-1/2 -translate-y-1/2 border-4 border-transparent border-l-gray-900"})]})]}),a.jsxs("div",{className:"group relative",children:[a.jsx("button",{onClick:()=>{console.log("[Geofence] Button clicked - Opening geofence manager"),console.log("[Geofence] Current state:",{showGeofenceManager:U,showGeofenceEditor:B,editingGeofence:K?.id}),_(!0),console.log("[Geofence] State updated - showGeofenceManager set to true")},className:"w-14 h-14 bg-white hover:bg-gray-50 rounded-full shadow-lg flex items-center justify-center text-gray-700 transition-all duration-200 hover:scale-110 active:scale-95","aria-label":"Open geofence management",children:a.jsx(A,{size:24})}),a.jsxs("div",{className:"absolute right-full mr-2 top-1/2 -translate-y-1/2 px-3 py-1.5 bg-gray-900 text-white text-xs font-medium rounded-lg whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none",children:["Geofences",a.jsx("div",{className:"absolute left-full top-1/2 -translate-y-1/2 border-4 border-transparent border-l-gray-900"})]})]}),a.jsxs("div",{className:"group relative",children:[a.jsx("button",{onClick:()=>{g&&s&&r?w({coordinates:{latitude:g.latitude,longitude:g.longitude,accuracy:g.accuracy,timestamp:g.timestamp,speed:null,heading:null,altitude:null,altitudeAccuracy:null},note:`Checked in at ${(new Date).toLocaleTimeString()}`}):n.error("Location not available")},disabled:!g||j,className:"w-14 h-14 rounded-full shadow-lg flex items-center justify-center transition-all duration-200 hover:scale-110 active:scale-95 "+(!g||j?"bg-gray-100 text-gray-400 cursor-not-allowed":"bg-blue-500 hover:bg-blue-600 text-white shadow-blue-200"),"aria-label":"Check in at current location",title:g?"Check in at current location":"Waiting for location...",children:j?a.jsx("div",{className:"w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"}):a.jsx(u,{size:24})}),a.jsxs("div",{className:"absolute right-full mr-2 top-1/2 -translate-y-1/2 px-3 py-1.5 bg-gray-900 text-white text-xs font-medium rounded-lg whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none",children:[j?"Checking in...":"Check In",a.jsx("div",{className:"absolute left-full top-1/2 -translate-y-1/2 border-4 border-transparent border-l-gray-900"})]})]})]})]}),a.jsxs("div",{className:"absolute left-0 right-0 bg-gradient-to-t from-white via-white to-white/95 backdrop-blur-sm shadow-2xl rounded-t-3xl transition-all duration-300 z-10 bottom-0 "+(z?"translate-y-0":"translate-y-full"),children:[a.jsx("button",{onClick:()=>P(!z),className:"w-full py-4 flex justify-center hover:bg-gray-50/50 transition-colors rounded-t-3xl","aria-label":z?"Hide member list":"Show member list",children:a.jsx("div",{className:"w-12 h-1.5 bg-gray-300 rounded-full"})}),a.jsx("div",{className:"px-6 pb-4",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Family Members"}),a.jsx("div",{className:"px-4 py-1.5 bg-purple-100 rounded-full",children:a.jsxs("span",{className:"text-sm font-bold text-purple-700",children:[I.length," online"]})})]})}),a.jsx("div",{className:"px-6 pb-safe",children:I.length>0?a.jsx("div",{className:"flex gap-4 overflow-x-auto pb-6 hide-scrollbar",children:I.filter(e=>e&&e.userId).map(e=>{const t=e.userId===s?.id,n=t?y:b(e.userId),r=l.find(t=>t.userId===e.userId),o=t?d?.photoURL||s?.photoURL:r?.photoURL,i=t?d?.displayName||s?.displayName||`${s?.email?.split("@")[0]||"You"} (You)`:r?.displayName||`User ${e.userId.slice(0,8)}`;return a.jsx("div",{className:"flex-shrink-0 w-80",children:a.jsx(be,{location:e,userName:i,userPhoto:o,batteryLevel:n?.batteryLevel??void 0,isOnline:n?.isOnline??!0})},e.userId)})}):a.jsxs("div",{className:"text-center py-12 pb-safe",children:[a.jsx("div",{className:"w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4",children:a.jsx(S,{size:36,className:"text-gray-400"})}),a.jsx("p",{className:"text-gray-700 font-semibold text-lg",children:"No members sharing location"}),a.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"Invite family members to start tracking"})]})})]})]}),U&&a.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:a.jsxs("div",{className:"bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto",children:[a.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[a.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Geofence Management"}),a.jsx("button",{onClick:()=>_(!1),className:"p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors",children:a.jsx(v,{size:20})})]}),a.jsx(ve,{onCreateGeofence:()=>{console.log("[Geofence] onCreateGeofence called - Creating new geofence"),console.log("[Geofence] Current state before update:",{showGeofenceEditor:B,editingGeofence:K?.id,currentLocation:g,currentHub:r?.id}),V(null),$(!0),console.log("[Geofence] State updated - showGeofenceEditor set to true, editingGeofence set to null")},onEditGeofence:e=>{console.log("[Geofence] onEditGeofence called - Editing geofence:",e.id),console.log("[Geofence] Geofence data:",e),V(e),$(!0),console.log("[Geofence] State updated - showGeofenceEditor set to true, editingGeofence set")},onDeleteGeofence:e=>{console.log("[Geofence] onDeleteGeofence called - Deleting geofence:",e),G(e)}})]})}),a.jsx(we,{isOpen:B,onClose:()=>{console.log("[Geofence] Editor onClose called"),$(!1),V(null),console.log("[Geofence] Editor closed - state reset")},onSave:async e=>{console.log("[Geofence] Editor onSave called"),console.log("[Geofence] Save data:",e),console.log("[Geofence] Editing geofence:",K?.id);try{if(K){console.log("[Geofence] Updating existing geofence");const t={id:K.id,name:e.name,description:e.description,type:e.type,center:e.center,radius:e.radius,alertOnEntry:e.alertOnEntry,alertOnExit:e.alertOnExit,alertRecipients:e.alertRecipients};console.log("[Geofence] Update data:",t),await C(t),console.log("[Geofence] Geofence updated successfully")}else{console.log("[Geofence] Creating new geofence");const t={name:e.name,description:e.description,type:e.type,center:e.center,radius:e.radius,alertOnEntry:e.alertOnEntry,alertOnExit:e.alertOnExit,alertRecipients:e.alertRecipients};console.log("[Geofence] Create data:",t),await N(t),console.log("[Geofence] Geofence created successfully")}$(!1),V(null),console.log("[Geofence] Editor closed after save")}catch(t){console.error("[Geofence] Error saving geofence:",t),n.error("Failed to save geofence")}},geofence:K?{name:K.name,description:K.description,type:K.type,center:K.center,radius:K.radius,alertOnEntry:K.alertOnEntry,alertOnExit:K.alertOnExit}:null,initialLocation:g?{latitude:g.latitude,longitude:g.longitude}:void 0}),a.jsx(je,{geofence:H,isOpen:W,onClose:()=>{q(!1),J(null)},onEdit:e=>{V(e),q(!1),$(!0)},onDelete:e=>{G(e),q(!1),J(null)}}),a.jsx(Ee,{}),a.jsx(Ne,{isOpen:D,onClose:()=>T(!1)}),a.jsx("style",{children:"\n                .hide-scrollbar::-webkit-scrollbar {\n                    display: none;\n                }\n                .hide-scrollbar {\n                    -ms-overflow-style: none;\n                    scrollbar-width: none;\n                }\n                .pb-safe {\n                    padding-bottom: max(env(safe-area-inset-bottom), 1.5rem);\n                }\n                .safe-top {\n                    padding-top: max(env(safe-area-inset-top), 1rem);\n                }\n                @keyframes slide-down {\n                    from {\n                        opacity: 0;\n                        transform: translateY(-10px);\n                    }\n                    to {\n                        opacity: 1;\n                        transform: translateY(0);\n                    }\n                }\n                .animate-slide-down {\n                    animation: slide-down 0.3s ease-out;\n                }\n                @keyframes slide-in-right {\n                    from { transform: translateX(100%); opacity: 0; }\n                    to { transform: translateX(0); opacity: 1; }\n                }\n                .animate-slide-in-right {\n                    animation: slide-in-right 0.3s ease-out;\n                }\n            "})]})};export{Ie as default};
//# sourceMappingURL=LocationPage-BlfF897K.js.map

{"version":3,"file":"LocationPage-BlfF897K.js","sources":["../../src/lib/services/secret-manager.ts","../../src/lib/services/google-maps-loader.ts","../../src/features/location/services/location-service.ts","../../src/lib/api/user-preferences-api.ts","../../src/features/location/hooks/useLocation.ts","../../src/features/location/api/location-api.ts","../../src/features/location/api/device-status-api.ts","../../src/features/geofencing/api/geofence-api.ts","../../src/features/geofencing/hooks/useGeofences.ts","../../src/features/geofencing/services/geofence-detection.ts","../../src/features/geofencing/services/alert-service.ts","../../src/features/location/components/MapView.tsx","../../src/features/location/components/MemberLocationCard.tsx","../../src/features/geofencing/components/GeofenceManager.tsx","../../src/features/geofencing/components/GeofenceMapEditor.tsx","../../src/features/geofencing/components/GeofenceDetailsModal.tsx","../../src/features/geofencing/components/GeofenceAlertToast.tsx","../../src/features/location/components/NavigationPanel.tsx","../../src/features/location/services/device-monitor.ts","../../src/features/location/hooks/useDeviceStatus.ts","../../src/features/location/api/checkin-api.ts","../../src/lib/services/geocoding-service.ts","../../src/features/location/hooks/useCheckIn.ts","../../src/features/location/pages/LocationPage.tsx"],"sourcesContent":["/**\n * Google Cloud Secret Manager Service\n * \n * Fetches secrets from Google Cloud Secret Manager\n * Falls back to environment variables for local development\n */\n\nconst SECRET_MANAGER_API_BASE = import.meta.env.VITE_SECRET_MANAGER_API_BASE || '/api/secrets';\n\n/**\n * Fetch a secret from Google Cloud Secret Manager via API endpoint\n * Falls back to environment variable if API is not available\n */\nexport async function getSecret(secretName: string, fallbackEnvVar?: string): Promise<string | null> {\n    // In development, prefer environment variable\n    if (import.meta.env.DEV && fallbackEnvVar) {\n        const envValue = import.meta.env[fallbackEnvVar];\n        if (envValue && envValue !== `your-${secretName.toLowerCase().replace(/_/g, '-')}`) {\n            return envValue;\n        }\n    }\n\n    try {\n        // Try to fetch from API endpoint (Cloud Function or backend)\n        const response = await fetch(`${SECRET_MANAGER_API_BASE}/${secretName}`, {\n            method: 'GET',\n            headers: {\n                'Content-Type': 'application/json',\n            },\n        });\n\n        if (response.ok) {\n            const data = await response.json();\n            return data.value || null;\n        }\n    } catch (error) {\n        console.warn(`Failed to fetch secret ${secretName} from API:`, error);\n    }\n\n    // Fallback to environment variable\n    if (fallbackEnvVar) {\n        const envValue = import.meta.env[fallbackEnvVar];\n        if (envValue && envValue !== `your-${secretName.toLowerCase().replace(/_/g, '-')}`) {\n            return envValue;\n        }\n    }\n\n    return null;\n}\n\n/**\n * Get Google Maps API Key\n * Tries Secret Manager first, then falls back to VITE_GOOGLE_MAPS_API_KEY\n */\nexport async function getGoogleMapsApiKey(): Promise<string | null> {\n    return getSecret('GOOGLE_API_KEY', 'VITE_GOOGLE_MAPS_API_KEY');\n}\n\n","/**\n * Google Maps Loader Service\n * \n * Singleton service to prevent multiple Loader initializations\n * with different options\n * Supports Google Cloud Secret Manager for API key storage\n */\n\nimport { Loader } from '@googlemaps/js-api-loader';\nimport { getGoogleMapsApiKey } from './secret-manager';\n\nclass GoogleMapsLoaderService {\n    private static instance: GoogleMapsLoaderService;\n    private loader: Loader | null = null;\n    private isLoaded = false;\n    private loadPromise: Promise<typeof google> | null = null;\n    private apiKey: string | null = null;\n\n    private constructor() {}\n\n    static getInstance(): GoogleMapsLoaderService {\n        if (!GoogleMapsLoaderService.instance) {\n            GoogleMapsLoaderService.instance = new GoogleMapsLoaderService();\n        }\n        return GoogleMapsLoaderService.instance;\n    }\n\n    /**\n     * Get API key from Secret Manager or environment variable\n     */\n    private async getApiKey(): Promise<string> {\n        if (this.apiKey) {\n            return this.apiKey;\n        }\n\n        // Try to get from Secret Manager (or env fallback)\n        const secretKey = await getGoogleMapsApiKey();\n        \n        if (secretKey) {\n            this.apiKey = secretKey;\n            return secretKey;\n        }\n\n        // Fallback to direct env variable\n        const envKey = import.meta.env.VITE_GOOGLE_MAPS_API_KEY || '';\n        if (envKey && envKey !== 'your-google-maps-api-key') {\n            this.apiKey = envKey;\n            return envKey;\n        }\n\n        throw new Error('Google Maps API key is not configured. Please set GOOGLE_API_KEY in Secret Manager or VITE_GOOGLE_MAPS_API_KEY in .env');\n    }\n\n    async load(_libraries: string[] = ['places', 'geometry', 'marker']): Promise<typeof google> {\n        // If already loaded, return the existing promise\n        if (this.isLoaded && this.loadPromise) {\n            return this.loadPromise;\n        }\n\n        // If loader exists but with different libraries, we need to handle this\n        if (this.loader && !this.isLoaded) {\n            // Wait for existing load to complete\n            if (this.loadPromise) {\n                return this.loadPromise;\n            }\n        }\n\n        // Get API key (from Secret Manager or env)\n        const apiKey = await this.getApiKey();\n\n        // Create new loader with all required libraries\n        this.loader = new Loader({\n            apiKey,\n            version: 'weekly',\n            libraries: ['places', 'geometry', 'marker'], // Always include all libraries\n        });\n\n        this.loadPromise = this.loader.load();\n        \n        try {\n            const google = await this.loadPromise;\n            this.isLoaded = true;\n            return google;\n        } catch (error) {\n            console.error('Failed to load Google Maps:', error);\n            throw error;\n        }\n    }\n\n    isGoogleMapsLoaded(): boolean {\n        return this.isLoaded;\n    }\n\n    getLoader(): Loader | null {\n        return this.loader;\n    }\n}\n\n// Export singleton instance\nexport const googleMapsLoader = GoogleMapsLoaderService.getInstance();\n","/**\n * Location Service\n * \n * Handles real-time location tracking using W3C Geolocation API\n * - Watches user position continuously\n * - Provides location updates\n * - Handles permissions and errors\n */\n\nexport interface LocationCoordinates {\n    latitude: number;\n    longitude: number;\n    accuracy: number;\n    altitude?: number | null;\n    altitudeAccuracy?: number | null;\n    heading?: number | null;\n    speed?: number | null;\n    timestamp: number;\n}\n\nexport interface LocationError {\n    code: number;\n    message: string;\n}\n\nexport type LocationCallback = (location: LocationCoordinates) => void;\nexport type LocationErrorCallback = (error: LocationError) => void;\n\nclass LocationService {\n    private watchId: number | null = null;\n    private isWatching: boolean = false;\n    private lastKnownPosition: LocationCoordinates | null = null;\n\n    /**\n     * Check if geolocation is supported by the browser\n     */\n    isSupported(): boolean {\n        return 'geolocation' in navigator;\n    }\n\n    /**\n     * Request location permission from user\n     */\n    async requestPermission(): Promise<boolean> {\n        if (!this.isSupported()) {\n            throw new Error('Geolocation is not supported by this browser');\n        }\n\n        try {\n            // Try to get current position to trigger permission prompt\n            await this.getCurrentPosition();\n            return true;\n        } catch (error) {\n            console.error('Location permission denied:', error);\n            return false;\n        }\n    }\n\n    /**\n     * Get current position once\n     */\n    getCurrentPosition(): Promise<LocationCoordinates> {\n        return new Promise((resolve, reject) => {\n            if (!this.isSupported()) {\n                reject(new Error('Geolocation is not supported'));\n                return;\n            }\n\n            navigator.geolocation.getCurrentPosition(\n                (position) => {\n                    resolve(this.mapPosition(position));\n                },\n                (error) => {\n                    reject(this.mapError(error));\n                },\n                {\n                    enableHighAccuracy: true,\n                    timeout: 15000, // Increased to 15 seconds\n                    maximumAge: 60000, // Accept cached position up to 1 minute old\n                }\n            );\n        });\n    }\n\n    /**\n     * Start watching user position with continuous updates\n     */\n    startWatching(\n        onLocation: LocationCallback,\n        onError?: LocationErrorCallback\n    ): void {\n        if (!this.isSupported()) {\n            onError?.({\n                code: 0,\n                message: 'Geolocation is not supported',\n            });\n            return;\n        }\n\n        if (this.isWatching) {\n            // Already watching - silently return (expected in React Strict Mode)\n            return;\n        }\n\n        this.watchId = navigator.geolocation.watchPosition(\n            (position) => {\n                const mappedPosition = this.mapPosition(position);\n                this.lastKnownPosition = mappedPosition; // Store last known position\n                onLocation(mappedPosition);\n            },\n            (error) => {\n                onError?.(this.mapError(error));\n            },\n            {\n                enableHighAccuracy: false, // Use false for faster results, true for accuracy\n                timeout: 15000, // 15 seconds timeout\n                maximumAge: 30000, // Accept cached positions up to 30 seconds old\n            }\n        );\n\n        this.isWatching = true;\n    }\n\n    /**\n     * Stop watching user position\n     */\n    stopWatching(): void {\n        if (this.watchId !== null) {\n            navigator.geolocation.clearWatch(this.watchId);\n            this.watchId = null;\n            this.isWatching = false;\n        }\n    }\n\n    /**\n     * Check if currently watching position\n     */\n    getWatchingStatus(): boolean {\n        return this.isWatching;\n    }\n\n    /**\n     * Get the last known position (if available)\n     */\n    getLastKnownPosition(): LocationCoordinates | null {\n        return this.lastKnownPosition;\n    }\n\n    /**\n     * Calculate distance between two coordinates using Haversine formula\n     * Returns distance in meters\n     */\n    calculateDistance(\n        coord1: { latitude: number; longitude: number },\n        coord2: { latitude: number; longitude: number }\n    ): number {\n        const R = 6371e3; // Earth's radius in meters\n        const φ1 = (coord1.latitude * Math.PI) / 180;\n        const φ2 = (coord2.latitude * Math.PI) / 180;\n        const Δφ = ((coord2.latitude - coord1.latitude) * Math.PI) / 180;\n        const Δλ = ((coord2.longitude - coord1.longitude) * Math.PI) / 180;\n\n        const a =\n            Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +\n            Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);\n        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n\n        return R * c;\n    }\n\n    /**\n     * Map native Position to our LocationCoordinates interface\n     */\n    private mapPosition(position: GeolocationPosition): LocationCoordinates {\n        return {\n            latitude: position.coords.latitude,\n            longitude: position.coords.longitude,\n            accuracy: position.coords.accuracy,\n            altitude: position.coords.altitude,\n            altitudeAccuracy: position.coords.altitudeAccuracy,\n            heading: position.coords.heading,\n            speed: position.coords.speed,\n            timestamp: position.timestamp,\n        };\n    }\n\n    /**\n     * Map native GeolocationPositionError to our LocationError\n     */\n    private mapError(error: GeolocationPositionError): LocationError {\n        const messages: Record<number, string> = {\n            1: 'Location permission denied',\n            2: 'Location position unavailable',\n            3: 'Location request timeout',\n        };\n\n        return {\n            code: error.code,\n            message: messages[error.code] || 'Unknown location error',\n        };\n    }\n}\n\n// Export singleton instance\nexport const locationService = new LocationService();\n\n","/**\n * User Preferences API\n * \n * Store and retrieve user preferences in Firestore\n */\n\nimport { doc, setDoc, getDoc } from 'firebase/firestore';\nimport { db } from '@/config/firebase';\nimport type { ApiResponse } from '@/types';\n\nexport interface UserPreferences {\n    locationPermissionGranted: boolean;\n    locationSharingEnabled: boolean;\n    notificationsEnabled: boolean;\n    lastUpdated: Date;\n}\n\n/**\n * Get user preferences from Firestore\n */\nexport const getUserPreferences = async (\n    userId: string\n): Promise<ApiResponse<UserPreferences | null>> => {\n    try {\n        const prefsRef = doc(db, 'users', userId, 'settings', 'preferences');\n        const prefsSnap = await getDoc(prefsRef);\n\n        if (!prefsSnap.exists()) {\n            return { success: true, data: null };\n        }\n\n        const data = prefsSnap.data();\n        return {\n            success: true,\n            data: {\n                locationPermissionGranted: data.locationPermissionGranted || false,\n                locationSharingEnabled: data.locationSharingEnabled || false,\n                notificationsEnabled: data.notificationsEnabled || false,\n                lastUpdated: data.lastUpdated?.toDate() || new Date(),\n            },\n        };\n    } catch (error) {\n        console.error('Error getting user preferences:', error);\n        return {\n            success: false,\n            error: error instanceof Error ? error.message : 'Failed to get preferences',\n        };\n    }\n};\n\n/**\n * Update user preferences in Firestore\n */\nexport const updateUserPreferences = async (\n    userId: string,\n    preferences: Partial<UserPreferences>\n): Promise<ApiResponse<void>> => {\n    try {\n        const prefsRef = doc(db, 'users', userId, 'settings', 'preferences');\n        \n        await setDoc(\n            prefsRef,\n            {\n                ...preferences,\n                lastUpdated: new Date(),\n            },\n            { merge: true }\n        );\n\n        return { success: true };\n    } catch (error) {\n        console.error('Error updating user preferences:', error);\n        return {\n            success: false,\n            error: error instanceof Error ? error.message : 'Failed to update preferences',\n        };\n    }\n};\n\n/**\n * Update location permission status\n */\nexport const updateLocationPermission = async (\n    userId: string,\n    granted: boolean\n): Promise<ApiResponse<void>> => {\n    return updateUserPreferences(userId, {\n        locationPermissionGranted: granted,\n    });\n};\n\n/**\n * Update location sharing preference\n */\nexport const updateLocationSharingPreference = async (\n    userId: string,\n    enabled: boolean\n): Promise<ApiResponse<void>> => {\n    return updateUserPreferences(userId, {\n        locationSharingEnabled: enabled,\n    });\n};\n\n","/**\n * useLocation Hook\n * \n * React hook for managing location tracking and real-time updates\n */\n\nimport { useState, useEffect, useCallback } from 'react';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { locationService, type LocationCoordinates } from '../services/location-service';\nimport {\n    updateUserLocation,\n    getHubLocations,\n    subscribeToHubLocations,\n    updateLocationSharing,\n    type UserLocation,\n} from '../api/location-api';\nimport { subscribeToHubDeviceStatus, type DeviceStatusDocument } from '../api/device-status-api';\nimport {\n    getUserPreferences,\n    updateLocationPermission,\n    updateLocationSharingPreference,\n} from '@/lib/api/user-preferences-api';\nimport { useAuth } from '@/features/auth/hooks/useAuth';\nimport { useHubStore } from '@/lib/store/hub-store';\nimport toast from 'react-hot-toast';\n\n/**\n * Hook for tracking current user's location\n */\nexport const useUserLocation = () => {\n    const { user } = useAuth();\n    const { currentHub } = useHubStore();\n    const [currentLocation, setCurrentLocation] = useState<LocationCoordinates | null>(null);\n    const [isSharing, setIsSharing] = useState(true); // Default to true (Life360 style)\n    const [error, setError] = useState<string | null>(null);\n    const [isWatching, setIsWatching] = useState(false);\n\n    // On mount, load user preferences and sync with location service\n    useEffect(() => {\n        const isAlreadyWatching = locationService.getWatchingStatus();\n        if (isAlreadyWatching) {\n            setIsWatching(true);\n\n            // Get last known position from service (instant, no timeout!)\n            const lastPosition = locationService.getLastKnownPosition();\n            if (lastPosition) {\n                setCurrentLocation(lastPosition);\n            }\n        }\n\n        // Load user's sharing preference from Firestore\n        if (user) {\n            getUserPreferences(user.id).then((result) => {\n                if (result.success && result.data) {\n                    setIsSharing(result.data.locationSharingEnabled ?? true); // Default true if not set\n                }\n            });\n        }\n    }, [user]);\n\n    // Mutation for updating location in Firestore\n    const updateMutation = useMutation({\n        mutationFn: (coordinates: LocationCoordinates) => {\n            if (!user || !currentHub) {\n                throw new Error('User or hub not available');\n            }\n            return updateUserLocation({\n                hubId: currentHub.id,\n                userId: user.id,\n                coordinates,\n                isSharing,\n            });\n        },\n    });\n\n    // Start tracking location\n    const startTracking = useCallback(async () => {\n        if (!locationService.isSupported()) {\n            setError('Geolocation is not supported by your browser');\n            toast.error('Geolocation is not supported');\n            return;\n        }\n\n        // Check if already watching\n        if (locationService.getWatchingStatus()) {\n            setIsWatching(true);\n            return;\n        }\n\n        // Request permission\n        const hasPermission = await locationService.requestPermission();\n        if (!hasPermission) {\n            setError('Location permission denied');\n            toast.error('Please enable location permissions in your browser');\n\n            // Store permission denial\n            if (user) {\n                await updateLocationPermission(user.id, false);\n            }\n            return;\n        }\n\n        // Store permission grant\n        if (user) {\n            await updateLocationPermission(user.id, true);\n        }\n\n        // Start watching position\n        locationService.startWatching(\n            (location) => {\n                setCurrentLocation(location);\n                setError(null);\n\n                // Update Firestore every time location changes (throttled by service)\n                if (isSharing && user && currentHub) {\n                    updateMutation.mutate(location);\n                }\n            },\n            (error) => {\n                setError(error.message);\n                toast.error(error.message);\n            }\n        );\n\n        setIsWatching(true);\n    }, [isSharing, user, currentHub, updateMutation]);\n\n    // Stop tracking location\n    const stopTracking = useCallback(() => {\n        locationService.stopWatching();\n        setIsWatching(false);\n    }, []);\n\n    // Toggle location sharing\n    const toggleSharing = useCallback(async () => {\n        if (!user || !currentHub) return;\n\n        const newValue = !isSharing;\n        setIsSharing(newValue);\n\n        // Update in Firestore location collection\n        const result = await updateLocationSharing(currentHub.id, user.id, newValue);\n\n        // Also update in user preferences\n        await updateLocationSharingPreference(user.id, newValue);\n\n        if (result.success) {\n            toast.success(newValue ? 'Location sharing enabled' : 'Location sharing disabled');\n        } else {\n            toast.error('Failed to update sharing preference');\n            setIsSharing(!newValue); // Revert on error\n        }\n    }, [isSharing, user, currentHub]);\n\n    // Cleanup on unmount\n    useEffect(() => {\n        return () => {\n            if (isWatching) {\n                locationService.stopWatching();\n            }\n        };\n    }, [isWatching]);\n\n    return {\n        currentLocation,\n        isSharing,\n        isWatching,\n        error,\n        startTracking,\n        stopTracking,\n        toggleSharing,\n    };\n};\n\n/**\n * Hook for fetching hub member locations\n */\nexport const useHubLocations = (hubId: string | undefined) => {\n    const [locations, setLocations] = useState<UserLocation[]>([]);\n\n    // Query for initial load\n    const { data, isLoading, error } = useQuery({\n        queryKey: ['locations', hubId],\n        queryFn: async () => {\n            if (!hubId) throw new Error('Hub ID is required');\n            const response = await getHubLocations(hubId);\n            if (!response.success) throw new Error(response.error);\n            return response.data || [];\n        },\n        enabled: !!hubId,\n        staleTime: 10000, // 10 seconds\n    });\n\n    // Subscribe to real-time updates\n    useEffect(() => {\n        if (!hubId) return;\n\n        const unsubscribe = subscribeToHubLocations(\n            hubId,\n            (updatedLocations) => {\n                setLocations(updatedLocations);\n            },\n            (error) => {\n                console.error('Location subscription error:', error);\n            }\n        );\n\n        return unsubscribe;\n    }, [hubId]);\n\n    // Use real-time locations if available, otherwise fallback to query data\n    const finalLocations = locations.length > 0 ? locations : (data || []);\n\n    return {\n        locations: finalLocations,\n        isLoading,\n        error,\n    };\n};\n\n/**\n * Hook for calculating distance between two points\n */\nexport const useDistance = (\n    coord1: { latitude: number; longitude: number } | null,\n    coord2: { latitude: number; longitude: number } | null\n) => {\n    const [distance, setDistance] = useState<number | null>(null);\n\n    useEffect(() => {\n        if (coord1 && coord2) {\n            const dist = locationService.calculateDistance(coord1, coord2);\n            setDistance(dist);\n        } else {\n            setDistance(null);\n        }\n    }, [coord1, coord2]);\n\n    return distance;\n};\n\n/**\n * Hook for fetching hub member device status\n */\nexport const useHubDeviceStatus = (hubId: string | undefined) => {\n    const [deviceStatuses, setDeviceStatuses] = useState<Map<string, DeviceStatusDocument>>(new Map());\n\n    // Subscribe to real-time device status updates\n    useEffect(() => {\n        if (!hubId) return;\n\n        const unsubscribe = subscribeToHubDeviceStatus(\n            hubId,\n            (statuses) => {\n                setDeviceStatuses(statuses);\n            },\n            (error) => {\n                // Silently handle errors (already handled in API)\n                // Device status monitoring works locally even if Firestore fails\n            }\n        );\n\n        return unsubscribe;\n    }, [hubId]);\n\n    // Helper to get device status for a specific user\n    const getDeviceStatus = useCallback((userId: string): DeviceStatusDocument | null => {\n        return deviceStatuses.get(userId) || null;\n    }, [deviceStatuses]);\n\n    return {\n        deviceStatuses,\n        getDeviceStatus,\n    };\n};\n\n","/**\n * Location API\n * \n * Firebase Firestore operations for location tracking\n * - Store user locations with 30-day retention\n * - Fetch real-time locations for hub members\n * - Update location sharing preferences\n */\n\nimport {\n    collection,\n    doc,\n    setDoc,\n    getDocs,\n    query,\n    where,\n    orderBy,\n    limit,\n    onSnapshot,\n    Timestamp,\n    deleteDoc,\n} from 'firebase/firestore';\nimport { db } from '@/config/firebase';\nimport type { LocationCoordinates } from '../services/location-service';\nimport type { ApiResponse } from '@/types';\n\nexport interface UserLocation {\n    userId: string;\n    hubId: string;\n    latitude: number;\n    longitude: number;\n    accuracy: number;\n    speed?: number | null;\n    heading?: number | null;\n    timestamp: Date;\n    isSharing: boolean;\n}\n\nexport interface LocationUpdate {\n    hubId: string;\n    userId: string;\n    coordinates: LocationCoordinates;\n    isSharing: boolean;\n}\n\n/**\n * Update user's current location in Firestore\n */\nexport const updateUserLocation = async (\n    update: LocationUpdate\n): Promise<ApiResponse<void>> => {\n    try {\n        const { hubId, userId, coordinates, isSharing } = update;\n\n        // Store in current location collection\n        const locationRef = doc(db, 'hubs', hubId, 'locations', userId);\n        await setDoc(locationRef, {\n            userId,\n            hubId,\n            latitude: coordinates.latitude,\n            longitude: coordinates.longitude,\n            accuracy: coordinates.accuracy,\n            speed: coordinates.speed,\n            heading: coordinates.heading,\n            timestamp: Timestamp.fromMillis(coordinates.timestamp),\n            isSharing,\n            updatedAt: Timestamp.now(),\n        });\n\n        // Store in location history (for 30-day retention)\n        const historyRef = doc(\n            collection(db, 'hubs', hubId, 'locations', userId, 'history')\n        );\n        await setDoc(historyRef, {\n            latitude: coordinates.latitude,\n            longitude: coordinates.longitude,\n            accuracy: coordinates.accuracy,\n            speed: coordinates.speed,\n            heading: coordinates.heading,\n            timestamp: Timestamp.fromMillis(coordinates.timestamp),\n        });\n\n        return { success: true };\n    } catch (error) {\n        console.error('Error updating location:', error);\n        return {\n            success: false,\n            error: error instanceof Error ? error.message : 'Failed to update location',\n        };\n    }\n};\n\n/**\n * Get all current locations for hub members\n */\nexport const getHubLocations = async (\n    hubId: string\n): Promise<ApiResponse<UserLocation[]>> => {\n    try {\n        const locationsQuery = query(\n            collection(db, 'hubs', hubId, 'locations'),\n            where('isSharing', '==', true)\n        );\n\n        const snapshot = await getDocs(locationsQuery);\n        const locations: UserLocation[] = [];\n\n        snapshot.forEach((doc) => {\n            const data = doc.data();\n            locations.push({\n                userId: data.userId,\n                hubId: data.hubId,\n                latitude: data.latitude,\n                longitude: data.longitude,\n                accuracy: data.accuracy,\n                speed: data.speed,\n                heading: data.heading,\n                timestamp: data.timestamp?.toDate() || new Date(),\n                isSharing: data.isSharing,\n            });\n        });\n\n        return { success: true, data: locations };\n    } catch (error) {\n        console.error('Error getting hub locations:', error);\n        return {\n            success: false,\n            error: error instanceof Error ? error.message : 'Failed to get locations',\n        };\n    }\n};\n\n/**\n * Get location history for a specific user\n */\nexport const getUserLocationHistory = async (\n    hubId: string,\n    userId: string,\n    limitCount: number = 100\n): Promise<ApiResponse<LocationCoordinates[]>> => {\n    try {\n        const historyQuery = query(\n            collection(db, 'hubs', hubId, 'locations', userId, 'history'),\n            orderBy('timestamp', 'desc'),\n            limit(limitCount)\n        );\n\n        const snapshot = await getDocs(historyQuery);\n        const history: LocationCoordinates[] = [];\n\n        snapshot.forEach((doc) => {\n            const data = doc.data();\n            history.push({\n                latitude: data.latitude,\n                longitude: data.longitude,\n                accuracy: data.accuracy,\n                speed: data.speed,\n                heading: data.heading,\n                altitude: null,\n                altitudeAccuracy: null,\n                timestamp: data.timestamp?.toMillis() || Date.now(),\n            });\n        });\n\n        return { success: true, data: history };\n    } catch (error) {\n        console.error('Error getting location history:', error);\n        return {\n            success: false,\n            error:\n                error instanceof Error ? error.message : 'Failed to get location history',\n        };\n    }\n};\n\n/**\n * Subscribe to real-time location updates for a hub\n */\nexport const subscribeToHubLocations = (\n    hubId: string,\n    onUpdate: (locations: UserLocation[]) => void,\n    onError?: (error: Error) => void\n): (() => void) => {\n    const locationsQuery = query(\n        collection(db, 'hubs', hubId, 'locations'),\n        where('isSharing', '==', true)\n    );\n\n    const unsubscribe = onSnapshot(\n        locationsQuery,\n        (snapshot) => {\n            const locations: UserLocation[] = [];\n            snapshot.forEach((doc) => {\n                const data = doc.data();\n                locations.push({\n                    userId: data.userId,\n                    hubId: data.hubId,\n                    latitude: data.latitude,\n                    longitude: data.longitude,\n                    accuracy: data.accuracy,\n                    speed: data.speed,\n                    heading: data.heading,\n                    timestamp: data.timestamp?.toDate() || new Date(),\n                    isSharing: data.isSharing,\n                });\n            });\n            onUpdate(locations);\n        },\n        (error) => {\n            console.error('Error in location subscription:', error);\n            onError?.(error);\n        }\n    );\n\n    return unsubscribe;\n};\n\n/**\n * Update location sharing preference\n */\nexport const updateLocationSharing = async (\n    hubId: string,\n    userId: string,\n    isSharing: boolean\n): Promise<ApiResponse<void>> => {\n    try {\n        const locationRef = doc(db, 'hubs', hubId, 'locations', userId);\n        await setDoc(\n            locationRef,\n            {\n                isSharing,\n                updatedAt: Timestamp.now(),\n            },\n            { merge: true }\n        );\n\n        return { success: true };\n    } catch (error) {\n        console.error('Error updating location sharing:', error);\n        return {\n            success: false,\n            error:\n                error instanceof Error ? error.message : 'Failed to update sharing preference',\n        };\n    }\n};\n\n/**\n * Delete old location history (cleanup function)\n * Should be called periodically to maintain 30-day retention\n */\nexport const deleteOldLocationHistory = async (\n    hubId: string,\n    userId: string,\n    daysToKeep: number = 30\n): Promise<ApiResponse<number>> => {\n    try {\n        const cutoffDate = new Date();\n        cutoffDate.setDate(cutoffDate.getDate() - daysToKeep);\n\n        const historyQuery = query(\n            collection(db, 'hubs', hubId, 'locations', userId, 'history'),\n            where('timestamp', '<', Timestamp.fromDate(cutoffDate))\n        );\n\n        const snapshot = await getDocs(historyQuery);\n        let deletedCount = 0;\n\n        // Delete old records\n        const deletePromises = snapshot.docs.map((doc) => {\n            deletedCount++;\n            return deleteDoc(doc.ref);\n        });\n\n        await Promise.all(deletePromises);\n\n        return { success: true, data: deletedCount };\n    } catch (error) {\n        console.error('Error deleting old location history:', error);\n        return {\n            success: false,\n            error:\n                error instanceof Error\n                    ? error.message\n                    : 'Failed to delete old location history',\n        };\n    }\n};\n\n","/**\n * Device Status API\n * \n * Firestore operations for device status updates\n */\n\nimport { collection, doc, setDoc, serverTimestamp, getDoc, onSnapshot, query } from 'firebase/firestore';\nimport { db } from '@/config/firebase';\nimport type { DeviceStatus } from '../services/device-monitor';\nimport type { ApiResponse } from '@/types';\n\nexport interface DeviceStatusDocument {\n    userId: string;\n    hubId: string;\n    batteryLevel: number | null;\n    isCharging: boolean | null;\n    isOnline: boolean;\n    lastSeen: Date;\n    platform: string;\n    connectionType?: 'wifi' | 'cellular' | 'ethernet' | 'unknown';\n    updatedAt: Date;\n}\n\n/**\n * Update device status in Firestore\n */\nexport async function updateDeviceStatus(\n    userId: string,\n    hubId: string,\n    status: DeviceStatus\n): Promise<ApiResponse<void>> {\n    try {\n        const statusRef = doc(db, 'hubs', hubId, 'deviceStatus', userId);\n        \n        const statusData: DeviceStatusDocument = {\n            userId,\n            hubId,\n            batteryLevel: status.batteryLevel,\n            isCharging: status.isCharging,\n            isOnline: status.isOnline,\n            lastSeen: status.lastSeen,\n            platform: status.platform,\n            connectionType: status.connectionType,\n            updatedAt: new Date(),\n        };\n\n        await setDoc(statusRef, {\n            ...statusData,\n            lastSeen: status.lastSeen,\n            updatedAt: serverTimestamp(),\n        }, { merge: true });\n\n        return { success: true };\n    } catch (error) {\n        // Silently handle permission errors (rules may not be deployed yet)\n        // Device status monitoring works locally even if Firestore write fails\n        const isPermissionError = error instanceof Error && \n            (error.message.includes('permission') || error.message.includes('Permission'));\n        \n        if (!isPermissionError && process.env.NODE_ENV === 'development') {\n            console.warn('Update device status error:', error);\n        }\n        \n        return {\n            success: false,\n            error: error instanceof Error ? error.message : 'Failed to update device status',\n        };\n    }\n}\n\n/**\n * Get device status for a user\n */\nexport async function getDeviceStatus(\n    hubId: string,\n    userId: string\n): Promise<ApiResponse<DeviceStatusDocument | null>> {\n    try {\n        const statusRef = doc(db, 'hubs', hubId, 'deviceStatus', userId);\n        const statusSnap = await getDoc(statusRef);\n\n        if (!statusSnap.exists()) {\n            return { success: true, data: null };\n        }\n\n        const data = statusSnap.data();\n        return {\n            success: true,\n            data: {\n                ...data,\n                lastSeen: data.lastSeen?.toDate() || new Date(),\n                updatedAt: data.updatedAt?.toDate() || new Date(),\n            } as DeviceStatusDocument,\n        };\n    } catch (error) {\n        // Silently handle permission errors\n        const isPermissionError = error instanceof Error && \n            (error.message.includes('permission') || error.message.includes('Permission'));\n        \n        if (!isPermissionError && process.env.NODE_ENV === 'development') {\n            console.warn('Get device status error:', error);\n        }\n        \n        return {\n            success: false,\n            error: error instanceof Error ? error.message : 'Failed to get device status',\n            data: null,\n        };\n    }\n}\n\n/**\n * Subscribe to device status updates for all hub members\n */\nexport function subscribeToHubDeviceStatus(\n    hubId: string,\n    onUpdate: (statuses: Map<string, DeviceStatusDocument>) => void,\n    onError?: (error: Error) => void\n): () => void {\n    try {\n        const statusCollection = collection(db, 'hubs', hubId, 'deviceStatus');\n        const statusQuery = query(statusCollection);\n\n        const unsubscribe = onSnapshot(\n            statusQuery,\n            (snapshot) => {\n                const statusMap = new Map<string, DeviceStatusDocument>();\n\n                snapshot.forEach((doc) => {\n                    const data = doc.data();\n                    statusMap.set(doc.id, {\n                        ...data,\n                        lastSeen: data.lastSeen?.toDate() || new Date(),\n                        updatedAt: data.updatedAt?.toDate() || new Date(),\n                    } as DeviceStatusDocument);\n                });\n\n                onUpdate(statusMap);\n            },\n            (error) => {\n                // Silently handle permission errors\n                const isPermissionError = error instanceof Error && \n                    (error.message.includes('permission') || error.message.includes('Permission'));\n                \n                if (!isPermissionError && process.env.NODE_ENV === 'development') {\n                    console.warn('Device status subscription error:', error);\n                }\n                \n                if (onError) {\n                    onError(error);\n                }\n            }\n        );\n\n        return unsubscribe;\n    } catch (error) {\n        // Silently handle permission errors\n        const isPermissionError = error instanceof Error && \n            (error.message.includes('permission') || error.message.includes('Permission'));\n        \n        if (!isPermissionError && process.env.NODE_ENV === 'development') {\n            console.warn('Failed to subscribe to device status:', error);\n        }\n        \n        if (onError) {\n            onError(error instanceof Error ? error : new Error('Unknown error'));\n        }\n        return () => {}; // Return no-op unsubscribe\n    }\n}\n","/**\n * Geofence API\n * \n * Firestore operations for geofence management\n */\n\nimport {\n    collection,\n    doc,\n    addDoc,\n    updateDoc,\n    getDocs,\n    getDoc,\n    query,\n    orderBy,\n    serverTimestamp,\n    Timestamp,\n} from 'firebase/firestore';\nimport { db } from '@/config/firebase';\nimport type { ApiResponse } from '@/types';\nimport type {\n    GeofenceZone,\n    GeofenceEvent,\n    GeofenceAlert,\n    CreateGeofenceRequest,\n    UpdateGeofenceRequest,\n} from '../types';\n\n// Export types for use in hooks\nexport type { CreateGeofenceRequest, UpdateGeofenceRequest } from '../types';\n\n// Collection references\nconst getGeofencesRef = (hubId: string) =>\n    collection(db, 'hubs', hubId, 'geofences');\n\nconst getGeofenceEventsRef = (hubId: string) =>\n    collection(db, 'hubs', hubId, 'geofenceEvents');\n\nconst getGeofenceAlertsRef = (hubId: string) =>\n    collection(db, 'hubs', hubId, 'geofenceAlerts');\n\n// Convert Firestore data to GeofenceZone\nconst convertGeofenceZone = (doc: any): GeofenceZone => {\n    // Default isActive to true if not present (for backwards compatibility)\n    const isActive = doc.isActive !== undefined ? doc.isActive : true;\n    \n    return {\n        id: doc.id,\n        hubId: doc.hubId,\n        name: doc.name,\n        description: doc.description,\n        type: doc.type,\n        center: doc.center,\n        radius: doc.radius,\n        isActive,\n        createdBy: doc.createdBy,\n        createdAt: doc.createdAt?.toDate() || new Date(),\n        updatedAt: doc.updatedAt?.toDate() || new Date(),\n        alertOnEntry: doc.alertOnEntry,\n        alertOnExit: doc.alertOnExit,\n        alertRecipients: doc.alertRecipients || [],\n    };\n};\n\n// Convert Firestore data to GeofenceEvent\nconst convertGeofenceEvent = (doc: any): GeofenceEvent => ({\n    id: doc.id,\n    hubId: doc.hubId,\n    userId: doc.userId,\n    geofenceId: doc.geofenceId,\n    eventType: doc.eventType,\n    timestamp: doc.timestamp?.toDate() || new Date(),\n    location: doc.location,\n    accuracy: doc.accuracy,\n    alertSent: doc.alertSent || false,\n    alertSentAt: doc.alertSentAt?.toDate(),\n});\n\n// Convert Firestore data to GeofenceAlert\nconst convertGeofenceAlert = (doc: any): GeofenceAlert => ({\n    id: doc.id,\n    hubId: doc.hubId,\n    userId: doc.userId,\n    geofenceId: doc.geofenceId,\n    eventType: doc.eventType,\n    message: doc.message,\n    timestamp: doc.timestamp?.toDate() || new Date(),\n    isRead: doc.isRead || false,\n    readAt: doc.readAt?.toDate(),\n    geofenceName: doc.geofenceName,\n    userName: doc.userName,\n});\n\n/**\n * Create a new geofence\n */\nexport const createGeofence = async (\n    hubId: string,\n    userId: string,\n    data: CreateGeofenceRequest\n): Promise<ApiResponse<GeofenceZone>> => {\n    try {\n        console.log('[geofence-api] Creating geofence:', { hubId, userId, data });\n        const geofenceData = {\n            ...data,\n            hubId,\n            createdBy: userId,\n            isActive: true,\n            createdAt: serverTimestamp(),\n            updatedAt: serverTimestamp(),\n        };\n\n        console.log('[geofence-api] Geofence data to save:', geofenceData);\n        const docRef = await addDoc(getGeofencesRef(hubId), geofenceData);\n        console.log('[geofence-api] Geofence created with ID:', docRef.id);\n        \n        const geofence = convertGeofenceZone({\n            id: docRef.id,\n            ...geofenceData,\n            createdAt: Timestamp.now(),\n            updatedAt: Timestamp.now(),\n        });\n\n        console.log('[geofence-api] Geofence created successfully:', geofence);\n        return { success: true, data: geofence };\n    } catch (error) {\n        console.error('[geofence-api] Error creating geofence:', error);\n        \n        // Check if it's a permission error\n        const isPermissionError = error instanceof Error && \n            (error.message.includes('permission') || \n             error.message.includes('Permission') ||\n             error.message.includes('Missing or insufficient permissions'));\n        \n        if (isPermissionError) {\n            console.error('[geofence-api] Permission denied - user may not be admin or member with create permission');\n        }\n        \n        return {\n            success: false,\n            error: error instanceof Error ? error.message : 'Failed to create geofence',\n        };\n    }\n};\n\n/**\n * Get all geofences for a hub\n */\nexport const getGeofences = async (\n    hubId: string\n): Promise<ApiResponse<GeofenceZone[]>> => {\n    try {\n        console.log('[geofence-api] Getting geofences for hub:', hubId);\n        // Simplified query - filter and sort in memory to avoid index requirement\n        const q = query(getGeofencesRef(hubId));\n\n        const snapshot = await getDocs(q);\n        console.log('[geofence-api] Snapshot size:', snapshot.docs.length);\n        \n        // Log raw documents\n        snapshot.docs.forEach((doc) => {\n            const data = doc.data();\n            console.log('[geofence-api] Raw document:', {\n                id: doc.id,\n                name: data.name,\n                isActive: data.isActive,\n                hubId: data.hubId,\n                createdBy: data.createdBy,\n            });\n        });\n        \n        const geofences = snapshot.docs\n            .map((doc) => {\n                const converted = convertGeofenceZone({ id: doc.id, ...doc.data() });\n                console.log('[geofence-api] Converted geofence:', {\n                    id: converted.id,\n                    name: converted.name,\n                    isActive: converted.isActive,\n                });\n                return converted;\n            })\n            .filter((geofence) => {\n                const isActive = geofence.isActive;\n                console.log('[geofence-api] Filtering geofence:', {\n                    id: geofence.id,\n                    name: geofence.name,\n                    isActive,\n                    willInclude: isActive,\n                });\n                return isActive; // Filter active geofences\n            })\n            .sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime()); // Sort by createdAt desc\n\n        console.log('[geofence-api] Final geofences count:', geofences.length);\n        return { success: true, data: geofences };\n    } catch (error) {\n        console.error('[geofence-api] Error getting geofences:', error);\n        // Silently handle permission errors\n        const isPermissionError = error instanceof Error && \n            (error.message.includes('permission') || error.message.includes('Permission'));\n        \n        if (!isPermissionError && process.env.NODE_ENV === 'development') {\n            console.warn('[geofence-api] Error getting geofences:', error);\n        }\n        \n        return {\n            success: false,\n            error: error instanceof Error ? error.message : 'Failed to get geofences',\n            data: [],\n        };\n    }\n};\n\n/**\n * Update a geofence\n */\nexport const updateGeofence = async (\n    hubId: string,\n    geofenceId: string,\n    data: UpdateGeofenceRequest\n): Promise<ApiResponse<GeofenceZone>> => {\n    try {\n        const geofenceRef = doc(getGeofencesRef(hubId), geofenceId);\n        const updateData = {\n            ...data,\n            updatedAt: serverTimestamp(),\n        };\n\n        await updateDoc(geofenceRef, updateData);\n\n        // Get updated geofence\n        const geofenceDoc = await getDoc(geofenceRef);\n        if (!geofenceDoc.exists()) {\n            return { success: false, error: 'Geofence not found' };\n        }\n\n        const geofence = convertGeofenceZone(geofenceDoc.data());\n        return { success: true, data: geofence };\n    } catch (error) {\n        console.error('Error updating geofence:', error);\n        return {\n            success: false,\n            error: error instanceof Error ? error.message : 'Failed to update geofence',\n        };\n    }\n};\n\n/**\n * Delete a geofence (soft delete)\n */\nexport const deleteGeofence = async (\n    hubId: string,\n    geofenceId: string\n): Promise<ApiResponse<void>> => {\n    try {\n        const geofenceRef = doc(getGeofencesRef(hubId), geofenceId);\n        await updateDoc(geofenceRef, {\n            isActive: false,\n            updatedAt: serverTimestamp(),\n        });\n\n        return { success: true };\n    } catch (error) {\n        console.error('Error deleting geofence:', error);\n        return {\n            success: false,\n            error: error instanceof Error ? error.message : 'Failed to delete geofence',\n        };\n    }\n};\n\n/**\n * Create a geofence event\n */\nexport const createGeofenceEvent = async (\n    hubId: string,\n    eventData: Omit<GeofenceEvent, 'id' | 'hubId' | 'timestamp' | 'alertSent' | 'alertSentAt'>\n): Promise<ApiResponse<GeofenceEvent>> => {\n    try {\n        const event = {\n            ...eventData,\n            hubId,\n            timestamp: serverTimestamp(),\n            alertSent: false,\n        };\n\n        const docRef = await addDoc(getGeofenceEventsRef(hubId), event);\n        const geofenceEvent = convertGeofenceEvent({\n            id: docRef.id,\n            ...event,\n            timestamp: Timestamp.now(),\n        });\n\n        return { success: true, data: geofenceEvent };\n    } catch (error) {\n        console.error('Error creating geofence event:', error);\n        return {\n            success: false,\n            error: error instanceof Error ? error.message : 'Failed to create geofence event',\n        };\n    }\n};\n\n/**\n * Create a geofence alert\n */\nexport const createGeofenceAlert = async (\n    hubId: string,\n    alertData: Omit<GeofenceAlert, 'id' | 'hubId' | 'timestamp' | 'isRead' | 'readAt'>\n): Promise<ApiResponse<GeofenceAlert>> => {\n    try {\n        const alert = {\n            ...alertData,\n            hubId,\n            timestamp: serverTimestamp(),\n            isRead: false,\n        };\n\n        const docRef = await addDoc(getGeofenceAlertsRef(hubId), alert);\n        const geofenceAlert = convertGeofenceAlert({\n            id: docRef.id,\n            ...alert,\n            timestamp: Timestamp.now(),\n        });\n\n        return { success: true, data: geofenceAlert };\n    } catch (error) {\n        console.error('Error creating geofence alert:', error);\n        return {\n            success: false,\n            error: error instanceof Error ? error.message : 'Failed to create geofence alert',\n        };\n    }\n};\n\n/**\n * Get geofence alerts for a hub\n */\nexport const getGeofenceAlerts = async (\n    hubId: string,\n    limit: number = 50\n): Promise<ApiResponse<GeofenceAlert[]>> => {\n    try {\n        const q = query(\n            getGeofenceAlertsRef(hubId),\n            orderBy('timestamp', 'desc')\n        );\n\n        const snapshot = await getDocs(q);\n        const alerts = snapshot.docs\n            .slice(0, limit)\n            .map(convertGeofenceAlert);\n\n        return { success: true, data: alerts };\n    } catch (error) {\n        console.error('Error getting geofence alerts:', error);\n        return {\n            success: false,\n            error: error instanceof Error ? error.message : 'Failed to get geofence alerts',\n        };\n    }\n};\n\n/**\n * Mark alert as read\n */\nexport const markAlertAsRead = async (\n    hubId: string,\n    alertId: string\n): Promise<ApiResponse<void>> => {\n    try {\n        const alertRef = doc(getGeofenceAlertsRef(hubId), alertId);\n        await updateDoc(alertRef, {\n            isRead: true,\n            readAt: serverTimestamp(),\n        });\n\n        return { success: true };\n    } catch (error) {\n        console.error('Error marking alert as read:', error);\n        return {\n            success: false,\n            error: error instanceof Error ? error.message : 'Failed to mark alert as read',\n        };\n    }\n};\n","/**\n * useGeofences Hook\n * \n * React hook for managing geofences\n */\n\nimport { useState, useCallback } from 'react';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { useHubStore } from '@/lib/store/hub-store';\nimport { useAuth } from '@/features/auth/hooks/useAuth';\nimport {\n    getGeofences,\n    createGeofence,\n    updateGeofence,\n    deleteGeofence,\n} from '../api/geofence-api';\nimport type { CreateGeofenceRequest, UpdateGeofenceRequest, GeofenceZone } from '../types';\nimport toast from 'react-hot-toast';\n\n/**\n * Hook for managing geofences\n */\nexport const useGeofences = () => {\n    const { user } = useAuth();\n    const { currentHub } = useHubStore();\n    const queryClient = useQueryClient();\n\n    // Query for geofences\n    const {\n        data: geofences = [],\n        isLoading,\n        error,\n        refetch,\n    } = useQuery({\n        queryKey: ['geofences', currentHub?.id],\n        queryFn: async () => {\n            if (!currentHub?.id) {\n                console.log('[useGeofences] Query skipped - no hub selected');\n                throw new Error('No hub selected');\n            }\n            console.log('[useGeofences] Fetching geofences for hub:', currentHub.id);\n            const result = await getGeofences(currentHub.id);\n            console.log('[useGeofences] Query result:', result);\n            if (result.success && result.data) {\n                console.log('[useGeofences] Geofences fetched:', result.data.length, 'geofences');\n            } else {\n                console.error('[useGeofences] Query failed:', result.error);\n            }\n            return result;\n        },\n        enabled: !!currentHub?.id,\n        select: (data) => {\n            const selected = data.success && data.data ? data.data : [];\n            console.log('[useGeofences] Query select - geofences count:', selected.length);\n            return selected;\n        },\n    });\n\n    // Create geofence mutation\n    const createMutation = useMutation({\n        mutationFn: async (data: CreateGeofenceRequest) => {\n            if (!currentHub?.id || !user?.id) {\n                throw new Error('No hub or user selected');\n            }\n            console.log('[useGeofences] Creating geofence:', { hubId: currentHub.id, userId: user.id, data });\n            const result = await createGeofence(currentHub.id, user.id, data);\n            console.log('[useGeofences] Create geofence result:', result);\n            return result;\n        },\n        onSuccess: (result) => {\n            console.log('[useGeofences] Mutation onSuccess called:', { result, hubId: currentHub?.id });\n            if (result.success) {\n                const queryKey = ['geofences', currentHub?.id];\n                console.log('[useGeofences] Invalidating queries with key:', queryKey);\n                // Invalidate and refetch immediately\n                queryClient.invalidateQueries({ queryKey });\n                // Also explicitly refetch to ensure immediate update\n                queryClient.refetchQueries({ queryKey }).then(() => {\n                    console.log('[useGeofences] Query refetched successfully');\n                }).catch((error) => {\n                    console.error('[useGeofences] Error refetching query:', error);\n                });\n                toast.success('Geofence created successfully');\n            } else {\n                console.error('[useGeofences] Failed to create geofence:', result.error);\n                toast.error(result.error || 'Failed to create geofence');\n            }\n        },\n        onError: (error) => {\n            console.error('[useGeofences] Error creating geofence:', error);\n            toast.error('Failed to create geofence');\n        },\n    });\n\n    // Update geofence mutation\n    const updateMutation = useMutation({\n        mutationFn: async (data: UpdateGeofenceRequest) => {\n            if (!currentHub?.id) {\n                throw new Error('No hub selected');\n            }\n            console.log('[useGeofences] Updating geofence:', { hubId: currentHub.id, data });\n            const result = await updateGeofence(currentHub.id, data.id, data);\n            console.log('[useGeofences] Update geofence result:', result);\n            return result;\n        },\n        onSuccess: (result) => {\n            console.log('[useGeofences] Update mutation onSuccess called:', { result, hubId: currentHub?.id });\n            if (result.success) {\n                const queryKey = ['geofences', currentHub?.id];\n                console.log('[useGeofences] Invalidating queries with key:', queryKey);\n                queryClient.invalidateQueries({ queryKey });\n                queryClient.refetchQueries({ queryKey }).then(() => {\n                    console.log('[useGeofences] Query refetched successfully');\n                }).catch((error) => {\n                    console.error('[useGeofences] Error refetching query:', error);\n                });\n                toast.success('Geofence updated successfully');\n            } else {\n                console.error('[useGeofences] Failed to update geofence:', result.error);\n                toast.error(result.error || 'Failed to update geofence');\n            }\n        },\n        onError: (error) => {\n            console.error('[useGeofences] Error updating geofence:', error);\n            toast.error('Failed to update geofence');\n        },\n    });\n\n    // Delete geofence mutation\n    const deleteMutation = useMutation({\n        mutationFn: async (geofenceId: string) => {\n            if (!currentHub?.id) {\n                throw new Error('No hub selected');\n            }\n            return deleteGeofence(currentHub.id, geofenceId);\n        },\n        onSuccess: (result) => {\n            console.log('[useGeofences] Delete mutation onSuccess called:', { result, hubId: currentHub?.id });\n            if (result.success) {\n                const queryKey = ['geofences', currentHub?.id];\n                console.log('[useGeofences] Invalidating queries with key:', queryKey);\n                queryClient.invalidateQueries({ queryKey });\n                queryClient.refetchQueries({ queryKey }).then(() => {\n                    console.log('[useGeofences] Query refetched successfully');\n                }).catch((error) => {\n                    console.error('[useGeofences] Error refetching query:', error);\n                });\n                toast.success('Geofence deleted successfully');\n            } else {\n                toast.error(result.error || 'Failed to delete geofence');\n            }\n        },\n        onError: (error) => {\n            console.error('Error deleting geofence:', error);\n            toast.error('Failed to delete geofence');\n        },\n    });\n\n    // Helper functions\n    const createGeofenceHandler = useCallback(\n        async (data: CreateGeofenceRequest) => {\n            try {\n                const result = await createMutation.mutateAsync(data);\n                if (!result.success) {\n                    throw new Error(result.error || 'Failed to create geofence');\n                }\n                return result;\n            } catch (error) {\n                console.error('[useGeofences] Error in createGeofenceHandler:', error);\n                throw error;\n            }\n        },\n        [createMutation]\n    );\n\n    const updateGeofenceHandler = useCallback(\n        async (data: UpdateGeofenceRequest) => {\n            try {\n                const result = await updateMutation.mutateAsync(data);\n                if (!result.success) {\n                    throw new Error(result.error || 'Failed to update geofence');\n                }\n                return result;\n            } catch (error) {\n                console.error('[useGeofences] Error in updateGeofenceHandler:', error);\n                throw error;\n            }\n        },\n        [updateMutation]\n    );\n\n    const deleteGeofenceHandler = useCallback(\n        (geofenceId: string) => {\n            if (window.confirm('Are you sure you want to delete this geofence?')) {\n                deleteMutation.mutate(geofenceId);\n            }\n        },\n        [deleteMutation]\n    );\n\n    return {\n        geofences,\n        isLoading,\n        error,\n        refetch,\n        createGeofence: createGeofenceHandler,\n        updateGeofence: updateGeofenceHandler,\n        deleteGeofence: deleteGeofenceHandler,\n        isCreating: createMutation.isPending,\n        isUpdating: updateMutation.isPending,\n        isDeleting: deleteMutation.isPending,\n    };\n};\n\n/**\n * Hook for geofence detection\n */\nexport const useGeofenceDetection = () => {\n    const [detectionResults, setDetectionResults] = useState<any[]>([]);\n\n    const addDetectionResult = useCallback((result: any) => {\n        setDetectionResults(prev => [result, ...prev.slice(0, 49)]); // Keep last 50 results\n    }, []);\n\n    const clearDetectionResults = useCallback(() => {\n        setDetectionResults([]);\n    }, []);\n\n    return {\n        detectionResults,\n        addDetectionResult,\n        clearDetectionResults,\n    };\n};\n","/**\n * Geofence Detection Service\n * \n * Handles real-time geofence entry/exit detection\n */\n\nimport type { LocationCoordinates } from '../../location/services/location-service';\nimport type {\n    GeofenceZone,\n    GeofenceDetectionResult,\n    GeofenceEvent,\n} from '../types';\n\nexport interface GeofenceState {\n    geofenceId: string;\n    isInside: boolean;\n    lastEvent?: GeofenceEvent;\n}\n\nclass GeofenceDetectionService {\n    private userStates = new Map<string, Map<string, GeofenceState>>(); // userId -> geofenceId -> state\n    private detectionCallbacks: ((result: GeofenceDetectionResult) => void)[] = [];\n\n    /**\n     * Check if a location is inside a geofence\n     */\n    private isLocationInsideGeofence(\n        location: LocationCoordinates,\n        geofence: GeofenceZone\n    ): boolean {\n        const distance = this.calculateDistance(\n            location.latitude,\n            location.longitude,\n            geofence.center.latitude,\n            geofence.center.longitude\n        );\n\n        return distance <= geofence.radius;\n    }\n\n    /**\n     * Calculate distance between two points using Haversine formula\n     */\n    private calculateDistance(\n        lat1: number,\n        lon1: number,\n        lat2: number,\n        lon2: number\n    ): number {\n        const R = 6371e3; // Earth's radius in meters\n        const φ1 = (lat1 * Math.PI) / 180;\n        const φ2 = (lat2 * Math.PI) / 180;\n        const Δφ = ((lat2 - lat1) * Math.PI) / 180;\n        const Δλ = ((lon2 - lon1) * Math.PI) / 180;\n\n        const a =\n            Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +\n            Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);\n        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n\n        return R * c; // Distance in meters\n    }\n\n    /**\n     * Check geofence state for a user's location\n     */\n    checkGeofenceState(\n        userId: string,\n        location: LocationCoordinates,\n        geofences: GeofenceZone[]\n    ): GeofenceDetectionResult[] {\n        const results: GeofenceDetectionResult[] = [];\n        const userStates = this.userStates.get(userId) || new Map();\n        this.userStates.set(userId, userStates);\n\n        for (const geofence of geofences) {\n            if (!geofence.isActive) continue;\n\n            const isInside = this.isLocationInsideGeofence(location, geofence);\n            const currentState = userStates.get(geofence.id);\n            const wasInside = currentState?.isInside || false;\n\n            // Update state\n            userStates.set(geofence.id, {\n                geofenceId: geofence.id,\n                isInside,\n                lastEvent: currentState?.lastEvent,\n            });\n\n            // Detect entry\n            if (!wasInside && isInside) {\n                const result: GeofenceDetectionResult = {\n                    geofenceId: geofence.id,\n                    geofenceName: geofence.name,\n                    eventType: 'entry',\n                    distance: this.calculateDistance(\n                        location.latitude,\n                        location.longitude,\n                        geofence.center.latitude,\n                        geofence.center.longitude\n                    ),\n                    accuracy: location.accuracy,\n                };\n\n                results.push(result);\n                this.notifyCallbacks(result);\n            }\n\n            // Detect exit\n            if (wasInside && !isInside) {\n                const result: GeofenceDetectionResult = {\n                    geofenceId: geofence.id,\n                    geofenceName: geofence.name,\n                    eventType: 'exit',\n                    distance: this.calculateDistance(\n                        location.latitude,\n                        location.longitude,\n                        geofence.center.latitude,\n                        geofence.center.longitude\n                    ),\n                    accuracy: location.accuracy,\n                };\n\n                results.push(result);\n                this.notifyCallbacks(result);\n            }\n        }\n\n        return results;\n    }\n\n    /**\n     * Add callback for geofence detection events\n     */\n    onDetection(callback: (result: GeofenceDetectionResult) => void): () => void {\n        this.detectionCallbacks.push(callback);\n        \n        // Return unsubscribe function\n        return () => {\n            const index = this.detectionCallbacks.indexOf(callback);\n            if (index > -1) {\n                this.detectionCallbacks.splice(index, 1);\n            }\n        };\n    }\n\n    /**\n     * Notify all callbacks of a detection event\n     */\n    private notifyCallbacks(result: GeofenceDetectionResult): void {\n        this.detectionCallbacks.forEach(callback => {\n            try {\n                callback(result);\n            } catch (error) {\n                console.error('Error in geofence detection callback:', error);\n            }\n        });\n    }\n\n    /**\n     * Get current state for a user\n     */\n    getUserState(userId: string): Map<string, GeofenceState> {\n        return this.userStates.get(userId) || new Map();\n    }\n\n    /**\n     * Clear state for a user (when they log out)\n     */\n    clearUserState(userId: string): void {\n        this.userStates.delete(userId);\n    }\n\n    /**\n     * Clear all states\n     */\n    clearAllStates(): void {\n        this.userStates.clear();\n    }\n}\n\n// Export singleton instance\nexport const geofenceDetectionService = new GeofenceDetectionService();\n","/**\n * Alert Service\n * \n * Handles geofence alert notifications\n * - Browser notifications\n * - Sound alerts\n * - Visual toasts\n */\n\nexport interface GeofenceAlert {\n    id: string;\n    geofenceId: string;\n    geofenceName: string;\n    userId: string;\n    type: 'entry' | 'exit';\n    timestamp: Date;\n    location: {\n        latitude: number;\n        longitude: number;\n    };\n    message: string;\n    isRead: boolean;\n}\n\nclass AlertService {\n    private notifications: GeofenceAlert[] = [];\n    private audioContext: AudioContext | null = null;\n    private isNotificationPermissionGranted = false;\n\n    constructor() {\n        this.initializeAudioContext();\n        // Check existing permission, but don't request automatically\n        // (must be requested from user gesture)\n        try {\n            this.checkNotificationPermission();\n        } catch (error) {\n            // Silently fail - permission check shouldn't throw\n            if (process.env.NODE_ENV === 'development') {\n                console.warn('Failed to check notification permission:', error);\n            }\n        }\n    }\n\n    // Initialize Web Audio API for sound alerts\n    private initializeAudioContext() {\n        try {\n            this.audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();\n        } catch (error) {\n            console.warn('Web Audio API not supported:', error);\n        }\n    }\n\n    // Check existing notification permission (no prompt)\n    private checkNotificationPermission() {\n        if ('Notification' in window) {\n            this.isNotificationPermissionGranted = Notification.permission === 'granted';\n        }\n    }\n\n    // Request notification permission (must be called from user gesture)\n    async requestNotificationPermission(): Promise<boolean> {\n        if (!('Notification' in window)) {\n            return false;\n        }\n\n        // If already granted, return true\n        if (Notification.permission === 'granted') {\n            this.isNotificationPermissionGranted = true;\n            return true;\n        }\n\n        // If denied, return false\n        if (Notification.permission === 'denied') {\n            return false;\n        }\n\n        // Request permission (must be called from user gesture)\n        try {\n            const permission = await Notification.requestPermission();\n            this.isNotificationPermissionGranted = permission === 'granted';\n            return this.isNotificationPermissionGranted;\n        } catch (error) {\n            console.warn('Failed to request notification permission:', error);\n            return false;\n        }\n    }\n\n    // Create a new alert\n    createAlert(\n        geofenceId: string,\n        geofenceName: string,\n        userId: string,\n        type: 'entry' | 'exit',\n        location: { latitude: number; longitude: number }\n    ): GeofenceAlert {\n        const alert: GeofenceAlert = {\n            id: `alert_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n            geofenceId,\n            geofenceName,\n            userId,\n            type,\n            timestamp: new Date(),\n            location,\n            message: this.generateAlertMessage(geofenceName, type),\n            isRead: false,\n        };\n\n        this.notifications.unshift(alert); // Add to beginning\n        this.showAlert(alert);\n        \n        return alert;\n    }\n\n    // Generate alert message\n    private generateAlertMessage(geofenceName: string, type: 'entry' | 'exit'): string {\n        const action = type === 'entry' ? 'entered' : 'left';\n        return `Family member ${action} ${geofenceName}`;\n    }\n\n    // Show alert (notification + sound + visual)\n    private async showAlert(alert: GeofenceAlert) {\n        // Browser notification\n        if (this.isNotificationPermissionGranted) {\n            new Notification('Geofence Alert', {\n                body: alert.message,\n                icon: '/logo192.png',\n                tag: alert.id,\n                requireInteraction: true,\n            });\n        }\n\n        // Sound alert\n        this.playAlertSound();\n\n        // Visual toast (will be handled by UI components)\n        this.dispatchAlertEvent(alert);\n    }\n\n    // Play alert sound\n    private playAlertSound() {\n        if (!this.audioContext) return;\n\n        try {\n            const oscillator = this.audioContext.createOscillator();\n            const gainNode = this.audioContext.createGain();\n\n            oscillator.connect(gainNode);\n            gainNode.connect(this.audioContext.destination);\n\n            // Create a pleasant alert sound\n            oscillator.frequency.setValueAtTime(800, this.audioContext.currentTime);\n            oscillator.frequency.setValueAtTime(600, this.audioContext.currentTime + 0.1);\n            oscillator.frequency.setValueAtTime(800, this.audioContext.currentTime + 0.2);\n\n            gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);\n            gainNode.gain.linearRampToValueAtTime(0.3, this.audioContext.currentTime + 0.01);\n            gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5);\n\n            oscillator.start(this.audioContext.currentTime);\n            oscillator.stop(this.audioContext.currentTime + 0.5);\n        } catch (error) {\n            console.warn('Failed to play alert sound:', error);\n        }\n    }\n\n    // Dispatch custom event for UI components\n    private dispatchAlertEvent(alert: GeofenceAlert) {\n        const event = new CustomEvent('geofenceAlert', {\n            detail: alert,\n        });\n        window.dispatchEvent(event);\n    }\n\n    // Get all alerts\n    getAlerts(): GeofenceAlert[] {\n        return [...this.notifications];\n    }\n\n    // Get unread alerts\n    getUnreadAlerts(): GeofenceAlert[] {\n        return this.notifications.filter(alert => !alert.isRead);\n    }\n\n    // Mark alert as read\n    markAsRead(alertId: string) {\n        const alert = this.notifications.find(a => a.id === alertId);\n        if (alert) {\n            alert.isRead = true;\n        }\n    }\n\n    // Mark all alerts as read\n    markAllAsRead() {\n        this.notifications.forEach(alert => {\n            alert.isRead = true;\n        });\n    }\n\n    // Clear old alerts (older than 24 hours)\n    clearOldAlerts() {\n        const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);\n        this.notifications = this.notifications.filter(alert => alert.timestamp > oneDayAgo);\n    }\n\n    // Get notification permission status\n    getNotificationPermissionStatus(): NotificationPermission {\n        return 'Notification' in window ? Notification.permission : 'denied';\n    }\n\n    // Check if notifications are supported\n    isNotificationSupported(): boolean {\n        return 'Notification' in window;\n    }\n}\n\n// Export singleton instance\nexport const alertService = new AlertService();\n","/**\n * MapView Component\n * \n * Displays Google Map with user location markers\n * - Shows all hub members who are sharing location\n * - Centers on user's current location\n * - Updates in real-time\n */\n\nimport { useEffect, useRef, useState } from 'react';\nimport { googleMapsLoader } from '@/lib/services/google-maps-loader';\nimport { useHubLocations, useUserLocation, useHubDeviceStatus } from '../hooks/useLocation';\nimport { useGeofences } from '../../geofencing/hooks/useGeofences';\nimport { useHubStore } from '@/lib/store/hub-store';\nimport { useHubMembers } from '@/features/tasks/hooks/useHubMembers';\nimport { useAuth } from '@/features/auth/hooks/useAuth';\nimport { LoadingSpinner } from '@/components/LoadingSpinner';\nimport { geofenceDetectionService } from '../../geofencing/services/geofence-detection';\nimport { alertService } from '../../geofencing/services/alert-service';\nimport type { UserLocation } from '../api/location-api';\n\n// Using shared Google Maps loader service\n\n// Helper function to get geofence colors\nconst getGeofenceColor = (type: string): string => {\n    switch (type) {\n        case 'home':\n            return '#3B82F6'; // Blue\n        case 'school':\n            return '#10B981'; // Green\n        case 'work':\n            return '#8B5CF6'; // Purple\n        default:\n            return '#6B7280'; // Gray\n    }\n};\n\ninterface MapViewProps {\n    height?: string;\n    zoom?: number;\n    showControls?: boolean;\n    onGeofenceClick?: (geofenceId: string) => void;\n}\n\nexport const MapView = ({\n    height = '600px',\n    zoom = 13,\n    showControls = true,\n    onGeofenceClick,\n}: MapViewProps) => {\n    const { currentHub } = useHubStore();\n    const { user } = useAuth();\n    const { currentLocation } = useUserLocation();\n    const { locations } = useHubLocations(currentHub?.id);\n    const { geofences } = useGeofences();\n    const { data: members = [] } = useHubMembers();\n    const { getDeviceStatus } = useHubDeviceStatus(currentHub?.id);\n\n    const mapRef = useRef<HTMLDivElement>(null);\n    const googleMapRef = useRef<google.maps.Map | null>(null);\n    const markersRef = useRef<Map<string, google.maps.Marker>>(new Map());\n    const infoWindowsRef = useRef<Map<string, google.maps.InfoWindow>>(new Map());\n    const currentUserMarkerRef = useRef<google.maps.Marker | null>(null);\n    const geofenceCirclesRef = useRef<Map<string, google.maps.Circle>>(new Map());\n\n    const [isMapLoaded, setIsMapLoaded] = useState(false);\n    const [loadError, setLoadError] = useState<string | null>(null);\n\n    // Fallback: if map doesn't load in 10 seconds, show error\n    useEffect(() => {\n        const timeout = setTimeout(() => {\n            if (!isMapLoaded && !loadError) {\n                console.error('MapView: Map loading timeout');\n                setLoadError('Map loading timed out. Please refresh the page.');\n            }\n        }, 10000);\n\n        return () => clearTimeout(timeout);\n    }, [isMapLoaded, loadError]);\n\n    // Initialize Google Map\n    useEffect(() => {\n        // Prevent re-initialization if already loaded\n        if (isMapLoaded || googleMapRef.current) {\n            return;\n        }\n\n        // Check if map container ref is ready\n        if (!mapRef.current) {\n            return;\n        }\n\n        // Use shared loader service (will fetch from Secret Manager or env)\n        googleMapsLoader\n            .load()\n            .then((google) => {\n                if (!mapRef.current) return;\n\n                // Use current location if available, otherwise default to New York\n                const defaultCenter = currentLocation\n                    ? { lat: currentLocation.latitude, lng: currentLocation.longitude }\n                    : { lat: 40.7128, lng: -74.0060 }; // New York fallback\n\n                googleMapRef.current = new google.maps.Map(mapRef.current, {\n                    center: defaultCenter,\n                    zoom: currentLocation ? 15 : zoom, // Zoom in if we have user location\n                    mapTypeControl: showControls,\n                    streetViewControl: showControls,\n                    fullscreenControl: showControls,\n                    zoomControl: showControls,\n                    styles: [\n                        {\n                            featureType: 'poi',\n                            elementType: 'labels',\n                            stylers: [{ visibility: 'off' }],\n                        },\n                    ],\n                });\n\n                setIsMapLoaded(true);\n            })\n            .catch((error) => {\n                console.error('Error loading Google Maps:', error);\n                const errorMessage = error.message || 'Failed to load map';\n                if (errorMessage.includes('API key') || errorMessage.includes('key')) {\n                    setLoadError('Invalid Google Maps API key. Please check your configuration.');\n                } else {\n                    setLoadError(`Failed to load map: ${errorMessage}`);\n                }\n            });\n    }, []); // Run once on mount\n\n    // Center map on user's current location when it becomes available\n    useEffect(() => {\n        if (googleMapRef.current && currentLocation && isMapLoaded) {\n            const center = new google.maps.LatLng(\n                currentLocation.latitude,\n                currentLocation.longitude\n            );\n            googleMapRef.current.setCenter(center);\n            googleMapRef.current.setZoom(15); // Zoom in closer when user location is found\n        }\n    }, [currentLocation, isMapLoaded]);\n\n    // No need for manual location request - LocationPage auto-starts tracking\n    // and the currentLocation effect above will handle centering\n\n    // Geofence detection - monitor current user's location against geofences\n    useEffect(() => {\n        if (!currentLocation || !geofences.length || !currentHub?.id) return;\n\n        const results = geofenceDetectionService.checkGeofenceState(\n            'current-user', // Use a fixed ID for current user\n            currentLocation,\n            geofences\n        );\n\n        if (results.length > 0) {\n            // Create alerts for each geofence event\n            results.forEach(event => {\n                const geofence = geofences.find(g => g.id === event.geofenceId);\n                if (geofence) {\n                    alertService.createAlert(\n                        geofence.id,\n                        geofence.name,\n                        'current-user', // Current user ID\n                        event.eventType,\n                        {\n                            latitude: currentLocation.latitude,\n                            longitude: currentLocation.longitude,\n                        }\n                    );\n                }\n            });\n        }\n    }, [currentLocation, geofences, currentHub?.id]);\n\n    // Update current user's marker\n    useEffect(() => {\n        if (!googleMapRef.current || !isMapLoaded || !currentLocation) return;\n\n        const position = new google.maps.LatLng(\n            currentLocation.latitude,\n            currentLocation.longitude\n        );\n\n        // Get current user's photo\n        const currentUserPhoto = user?.photoURL;\n        const currentUserMember = members.find(m => m.userId === user?.id);\n        const photoURL = currentUserPhoto || currentUserMember?.photoURL;\n\n        // Create icon with photo or initials\n        const icon = createMarkerIcon(currentUserMember, photoURL, true);\n\n        if (currentUserMarkerRef.current) {\n            // Update existing marker position and icon\n            currentUserMarkerRef.current.setPosition(position);\n            if (icon) {\n                currentUserMarkerRef.current.setIcon(icon);\n            }\n        } else {\n            // Create new marker for current user with distinct styling\n            currentUserMarkerRef.current = new google.maps.Marker({\n                position,\n                map: googleMapRef.current,\n                title: 'Your Location',\n                icon: icon || {\n                    path: google.maps.SymbolPath.CIRCLE,\n                    scale: 10,\n                    fillColor: '#10B981', // Green color for current user\n                    fillOpacity: 1,\n                    strokeColor: '#FFFFFF',\n                    strokeWeight: 3,\n                },\n                zIndex: 1000, // Show current user marker on top\n            });\n\n            // If photo loads later, update the marker icon\n            if (photoURL && !imageCache.current.has(photoURL) && !failedImages.current.has(photoURL)) {\n                loadImage(photoURL).then(() => {\n                    const newIcon = createMarkerIcon(currentUserMember, photoURL, true);\n                    if (newIcon && currentUserMarkerRef.current && currentUserMarkerRef.current.getMap()) {\n                        currentUserMarkerRef.current.setIcon(newIcon);\n                    }\n                }).catch(() => {\n                    // Photo failed to load, keep initials\n                });\n            }\n\n            // Add pulsing ring around current user\n            new google.maps.Circle({\n                strokeColor: '#10B981',\n                strokeOpacity: 0.3,\n                strokeWeight: 2,\n                fillColor: '#10B981',\n                fillOpacity: 0.1,\n                map: googleMapRef.current,\n                center: position,\n                radius: currentLocation.accuracy || 50, // Use GPS accuracy or 50m default\n            });\n        }\n    }, [currentLocation, isMapLoaded, user?.id, user?.photoURL, members]);\n\n    // Update geofence circles when geofences change\n    useEffect(() => {\n        if (!googleMapRef.current || !isMapLoaded) return;\n\n        const currentCircles = geofenceCirclesRef.current;\n\n        // Remove circles for geofences that no longer exist\n        currentCircles.forEach((circle, geofenceId) => {\n            if (!geofences.find(g => g.id === geofenceId)) {\n                circle.setMap(null);\n                currentCircles.delete(geofenceId);\n            }\n        });\n\n        // Add or update circles for active geofences\n        geofences.forEach((geofence) => {\n            if (!geofence.isActive) return;\n\n            const center = new google.maps.LatLng(\n                geofence.center.latitude,\n                geofence.center.longitude\n            );\n\n            const existingCircle = currentCircles.get(geofence.id);\n            if (existingCircle) {\n                // Update existing circle\n                existingCircle.setCenter(center);\n                existingCircle.setRadius(geofence.radius);\n            } else {\n                // Create new circle\n                const circle = new google.maps.Circle({\n                    strokeColor: getGeofenceColor(geofence.type),\n                    strokeOpacity: 0.8,\n                    strokeWeight: 2,\n                    fillColor: getGeofenceColor(geofence.type),\n                    fillOpacity: 0.2,\n                    map: googleMapRef.current,\n                    center,\n                    radius: geofence.radius,\n                    clickable: true,\n                });\n\n                // Add click listener\n                circle.addListener('click', () => {\n                    if (onGeofenceClick) {\n                        onGeofenceClick(geofence.id);\n                    }\n                });\n\n                currentCircles.set(geofence.id, circle);\n            }\n        });\n    }, [geofences, isMapLoaded, onGeofenceClick]);\n\n    // Helper to get member info\n    const getMemberInfo = (userId: string) => {\n        return members.find(m => m.userId === userId);\n    };\n\n    // Helper to get initials from name\n    const getInitials = (name: string) => {\n        return name\n            .split(' ')\n            .map(n => n[0])\n            .join('')\n            .toUpperCase()\n            .slice(0, 2);\n    };\n\n    // Helper to draw initials on canvas\n    const drawInitials = (ctx: CanvasRenderingContext2D, member: typeof members[0] | undefined, size: number) => {\n        ctx.fillStyle = member ? '#E8DEF8' : '#D1D5DB';\n        ctx.fill();\n        ctx.fillStyle = member ? '#6750A4' : '#6B7280';\n        ctx.font = `bold ${size / 3}px Arial`;\n        ctx.textAlign = 'center';\n        ctx.textBaseline = 'middle';\n        const text = member ? getInitials(member.displayName) : '?';\n        ctx.fillText(text, size / 2, size / 2);\n    };\n\n    // Cache for loaded images to avoid reloading\n    const imageCache = useRef<Map<string, HTMLImageElement>>(new Map());\n    // Track failed image loads to avoid retrying\n    const failedImages = useRef<Set<string>>(new Set());\n\n    // Helper to load image and cache it\n    const loadImage = (url: string): Promise<HTMLImageElement> => {\n        if (imageCache.current.has(url)) {\n            return Promise.resolve(imageCache.current.get(url)!);\n        }\n\n        // Don't retry failed images\n        if (failedImages.current.has(url)) {\n            return Promise.reject(new Error('Image previously failed to load'));\n        }\n\n        return new Promise((resolve, reject) => {\n            const img = new Image();\n            // Try with crossOrigin first (for CORS-enabled buckets)\n            img.crossOrigin = 'anonymous';\n            \n            const timeout = setTimeout(() => {\n                img.onload = null;\n                img.onerror = null;\n                failedImages.current.add(url);\n                reject(new Error('Image load timeout'));\n            }, 5000); // 5 second timeout\n\n            img.onload = () => {\n                clearTimeout(timeout);\n                imageCache.current.set(url, img);\n                resolve(img);\n            };\n            \n            img.onerror = (error) => {\n                clearTimeout(timeout);\n                failedImages.current.add(url);\n                console.warn('Failed to load image (CORS or network issue):', url);\n                // Try without crossOrigin as fallback\n                if (img.crossOrigin === 'anonymous') {\n                    const img2 = new Image();\n                    img2.onload = () => {\n                        imageCache.current.set(url, img2);\n                        resolve(img2);\n                    };\n                    img2.onerror = () => {\n                        reject(error);\n                    };\n                    img2.src = url;\n                } else {\n                    reject(error);\n                }\n            };\n            \n            img.src = url;\n        });\n    };\n\n    // Preload member photos when members data loads\n    useEffect(() => {\n        if (!members || members.length === 0) return;\n\n        members.forEach((member) => {\n            if (member.photoURL && !imageCache.current.has(member.photoURL) && !failedImages.current.has(member.photoURL)) {\n                loadImage(member.photoURL).catch(() => {\n                    // Silently fail - will use initials\n                });\n            }\n        });\n    }, [members]);\n\n    // Helper to create custom marker icon with avatar (photo or initials)\n    const createMarkerIcon = (member: typeof members[0] | undefined, photoURL: string | undefined, isCurrentUser: boolean): google.maps.Icon | undefined => {\n        const size = isCurrentUser ? 48 : 40;\n        const borderWidth = isCurrentUser ? 4 : 3;\n        const borderColor = isCurrentUser ? '#10B981' : '#6750A4';\n        \n        // Create canvas for custom icon\n        const canvas = document.createElement('canvas');\n        canvas.width = size;\n        canvas.height = size;\n        const ctx = canvas.getContext('2d');\n        if (!ctx) return undefined;\n\n        // Draw circle background (border)\n        ctx.beginPath();\n        ctx.arc(size / 2, size / 2, size / 2 - borderWidth / 2, 0, 2 * Math.PI);\n        ctx.fillStyle = borderColor;\n        ctx.fill();\n\n        // Draw inner circle (avatar area)\n        ctx.beginPath();\n        ctx.arc(size / 2, size / 2, size / 2 - borderWidth, 0, 2 * Math.PI);\n        ctx.save();\n        ctx.clip(); // Clip to circle\n\n        // If photo exists and is cached, draw it\n        if (photoURL && imageCache.current.has(photoURL) && !failedImages.current.has(photoURL)) {\n            try {\n                const img = imageCache.current.get(photoURL)!;\n                const imgSize = size - borderWidth * 2;\n                ctx.drawImage(img, borderWidth, borderWidth, imgSize, imgSize);\n            } catch (error) {\n                // If drawing fails, fall back to initials\n                console.warn('Failed to draw image on canvas:', error);\n                drawInitials(ctx, member, size);\n            }\n        } else {\n            // No photo or not loaded yet, draw initials\n            drawInitials(ctx, member, size);\n            \n            // Try to load photo in background for next time (if not already failed)\n            if (photoURL && !failedImages.current.has(photoURL)) {\n                loadImage(photoURL)\n                    .then(() => {\n                        // Image loaded successfully - trigger marker update\n                        // This will be handled by the useEffect that watches for image cache changes\n                    })\n                    .catch(() => {\n                        // Silently fail - will use initials\n                    });\n            }\n        }\n\n        ctx.restore();\n\n        return {\n            url: canvas.toDataURL(),\n            scaledSize: new google.maps.Size(size, size),\n            anchor: new google.maps.Point(size / 2, size / 2),\n        };\n    };\n\n    // Update or create a marker for a user\n    const updateMarker = (location: UserLocation) => {\n        if (!googleMapRef.current) return;\n\n        // Safety check - ensure location has required properties\n        if (!location || !location.userId || typeof location.latitude !== 'number' || typeof location.longitude !== 'number') {\n            console.warn('Invalid location data:', location);\n            return;\n        }\n\n        // Skip current user marker (handled separately)\n        if (location.userId === user?.id) return;\n\n        const member = getMemberInfo(location.userId);\n        const deviceStatus = getDeviceStatus(location.userId);\n        const existingMarker = markersRef.current.get(location.userId);\n        const position = new google.maps.LatLng(location.latitude, location.longitude);\n\n        // Create info window content\n        const lastSeen = new Date(location.timestamp);\n        const timeAgo = Math.floor((Date.now() - lastSeen.getTime()) / 1000 / 60); // minutes ago\n        const timeAgoText = timeAgo < 1 ? 'Just now' : timeAgo < 60 ? `${timeAgo}m ago` : `${Math.floor(timeAgo / 60)}h ago`;\n\n        const batteryLevel = deviceStatus?.batteryLevel ?? null;\n        const isOnline = deviceStatus?.isOnline ?? true;\n\n        const memberPhotoURL = member?.photoURL;\n        const avatarHTML = memberPhotoURL \n            ? `<img src=\"${memberPhotoURL}\" alt=\"${member?.displayName || 'User'}\" style=\"width: 40px; height: 40px; border-radius: 50%; object-fit: cover;\" onerror=\"this.style.display='none'; this.nextElementSibling.style.display='flex';\" />`\n            : '';\n        const initialsHTML = `<div style=\"width: 40px; height: 40px; border-radius: 50%; background: ${member ? '#E8DEF8' : '#D1D5DB'}; display: ${memberPhotoURL ? 'none' : 'flex'}; align-items: center; justify-content: center; font-weight: bold; color: ${member ? '#6750A4' : '#6B7280'};\">\n                        ${member ? getInitials(member.displayName) : '?'}\n                    </div>`;\n\n        const infoContent = `\n            <div style=\"padding: 12px; min-width: 200px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\">\n                <div style=\"display: flex; align-items: center; gap: 10px; margin-bottom: 8px;\">\n                    ${avatarHTML}\n                    ${initialsHTML}\n                    <div style=\"flex: 1;\">\n                        <h3 style=\"margin: 0; font-size: 14px; font-weight: 600; color: #1F2937;\">\n                            ${member?.displayName || `User ${location.userId.slice(0, 8)}`}\n                        </h3>\n                        <p style=\"margin: 2px 0 0 0; font-size: 12px; color: #6B7280;\">\n                            ${member?.role ? member.role.charAt(0).toUpperCase() + member.role.slice(1) : 'Member'}\n                        </p>\n                    </div>\n                </div>\n                <div style=\"border-top: 1px solid #E5E7EB; padding-top: 8px; margin-top: 8px;\">\n                    <div style=\"display: flex; justify-content: space-between; margin-bottom: 4px;\">\n                        <span style=\"font-size: 12px; color: #6B7280;\">Status:</span>\n                        <span style=\"font-size: 12px; font-weight: 500; color: ${isOnline ? '#10B981' : '#6B7280'};\">\n                            ${isOnline ? '● Online' : '○ Offline'}\n                        </span>\n                    </div>\n                    ${batteryLevel !== null ? `\n                        <div style=\"display: flex; justify-content: space-between; margin-bottom: 4px;\">\n                            <span style=\"font-size: 12px; color: #6B7280;\">Battery:</span>\n                            <span style=\"font-size: 12px; font-weight: 500; color: ${batteryLevel < 20 ? '#EF4444' : batteryLevel < 50 ? '#F59E0B' : '#10B981'};\">\n                                ${batteryLevel}%\n                            </span>\n                        </div>\n                    ` : ''}\n                    <div style=\"display: flex; justify-content: space-between; margin-bottom: 4px;\">\n                        <span style=\"font-size: 12px; color: #6B7280;\">Last seen:</span>\n                        <span style=\"font-size: 12px; color: #6B7280;\">${timeAgoText}</span>\n                    </div>\n                    <div style=\"display: flex; justify-content: space-between;\">\n                        <span style=\"font-size: 12px; color: #6B7280;\">Accuracy:</span>\n                        <span style=\"font-size: 12px; color: #6B7280;\">${Math.round(location.accuracy)}m</span>\n                    </div>\n                </div>\n            </div>\n        `;\n\n        if (existingMarker) {\n            // Update existing marker position\n            existingMarker.setPosition(position);\n            \n            // Update info window content\n            const infoWindow = infoWindowsRef.current.get(location.userId);\n            if (infoWindow) {\n                infoWindow.setContent(infoContent);\n            }\n        } else {\n            // Get photo URL from member profile\n            const memberPhotoURL = member?.photoURL;\n            \n            // Create custom icon with photo\n            const icon = createMarkerIcon(member, memberPhotoURL, false);\n\n            // Create new marker\n            const marker = new google.maps.Marker({\n                position,\n                map: googleMapRef.current,\n                title: member?.displayName || `User ${location.userId.slice(0, 8)}`,\n                animation: google.maps.Animation.DROP,\n                icon: icon || {\n                    path: google.maps.SymbolPath.CIRCLE,\n                    scale: 8,\n                    fillColor: '#6750A4',\n                    fillOpacity: 1,\n                    strokeColor: '#FFFFFF',\n                    strokeWeight: 2,\n                },\n            });\n\n            // If photo loads later, update the marker icon\n            if (memberPhotoURL && !imageCache.current.has(memberPhotoURL) && !failedImages.current.has(memberPhotoURL)) {\n                loadImage(memberPhotoURL).then(() => {\n                    // Recreate icon with loaded photo\n                    const newIcon = createMarkerIcon(member, memberPhotoURL, false);\n                    if (newIcon && marker.getMap()) {\n                        marker.setIcon(newIcon);\n                    }\n                }).catch(() => {\n                    // Photo failed to load, keep initials\n                });\n            }\n\n            // Create info window\n            const infoWindow = new google.maps.InfoWindow({\n                content: infoContent,\n            });\n\n            // Add click listener\n            marker.addListener('click', () => {\n                // Close all other info windows\n                infoWindowsRef.current.forEach((iw) => iw.close());\n                infoWindow.open(googleMapRef.current!, marker);\n            });\n\n            markersRef.current.set(location.userId, marker);\n            infoWindowsRef.current.set(location.userId, infoWindow);\n        }\n    };\n\n    // Update markers when locations or members change\n    useEffect(() => {\n        if (!googleMapRef.current || !isMapLoaded) return;\n\n        // Filter out invalid locations\n        const validLocations = locations.filter(\n            (loc) => loc && loc.userId && loc.latitude && loc.longitude && loc.isSharing\n        );\n\n        const currentMarkers = markersRef.current;\n        const currentLocationIds = new Set(validLocations.map((loc) => loc.userId));\n\n        // Remove markers for users no longer in the list\n        currentMarkers.forEach((marker, userId) => {\n            if (!currentLocationIds.has(userId)) {\n                marker.setMap(null);\n                currentMarkers.delete(userId);\n                // Also close and remove info window\n                const infoWindow = infoWindowsRef.current.get(userId);\n                if (infoWindow) {\n                    infoWindow.close();\n                    infoWindowsRef.current.delete(userId);\n                }\n            }\n        });\n\n        // Add or update markers\n        validLocations.forEach((location) => {\n            updateMarker(location);\n        });\n    }, [locations, members, isMapLoaded, user?.id, getDeviceStatus]);\n\n    // Cleanup markers and info windows on unmount\n    useEffect(() => {\n        return () => {\n            markersRef.current.forEach((marker) => marker.setMap(null));\n            markersRef.current.clear();\n            infoWindowsRef.current.forEach((iw) => iw.close());\n            infoWindowsRef.current.clear();\n        };\n    }, []);\n\n    if (loadError) {\n        return (\n            <div\n                className=\"flex items-center justify-center bg-gray-100 rounded-lg\"\n                style={{ height }}\n            >\n                <div className=\"text-center max-w-md px-6\">\n                    <p className=\"text-red-600 font-semibold mb-2 text-lg\">Map Error</p>\n                    <p className=\"text-gray-700 text-sm mb-3\">{loadError}</p>\n                    <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-4 text-left\">\n                        <p className=\"text-blue-800 font-semibold text-sm mb-2\">Quick Fix:</p>\n                        <ol className=\"text-blue-700 text-xs space-y-1 list-decimal list-inside\">\n                            <li>Check your <code className=\"bg-blue-100 px-1 rounded\">.env</code> file</li>\n                            <li>Add: <code className=\"bg-blue-100 px-1 rounded\">VITE_GOOGLE_MAPS_API_KEY=your_key</code></li>\n                            <li>Restart the dev server</li>\n                        </ol>\n                        <p className=\"text-blue-600 text-xs mt-3\">\n                            See <code className=\"bg-blue-100 px-1 rounded\">GOOGLE_MAPS_SETUP.md</code> for details\n                        </p>\n                    </div>\n                </div>\n            </div>\n        );\n    }\n\n    // Always render the map div (even during location loading)\n    // Just show a loading overlay if needed\n    return (\n        <div className=\"relative w-full h-full\">\n            {/* Map container - always render so ref can attach */}\n            <div\n                ref={mapRef}\n                style={{\n                    width: '100%',\n                    height: height || '100%',\n                    minHeight: '400px', // Ensure minimum height\n                }}\n                className=\"bg-gray-100\"\n            />\n\n            {/* Loading overlay (only while map is initializing) */}\n            {!isMapLoaded && (\n                <div className=\"absolute inset-0 flex items-center justify-center bg-gray-100 bg-opacity-90 z-50\">\n                    <div className=\"text-center\">\n                        <LoadingSpinner size=\"large\" />\n                        <p className=\"mt-4 text-gray-600 text-sm\">Loading map...</p>\n                    </div>\n                </div>\n            )}\n\n            {/* Location count badge - only show if there are locations */}\n            {locations.length > 0 && (\n                <div className=\"absolute top-6 left-6 bg-white rounded-xl shadow-md px-4 py-2.5 backdrop-blur-sm bg-white/95\">\n                    <p className=\"text-sm font-semibold text-gray-900 flex items-center gap-2\">\n                        <span className=\"w-2 h-2 bg-green-500 rounded-full animate-pulse\"></span>\n                        {locations.length} {locations.length === 1 ? 'member' : 'members'} online\n                    </p>\n                </div>\n            )}\n        </div>\n    );\n};\n\n","/**\n * MemberLocationCard Component\n * \n * Displays a member's location info in a card overlay (Life360 style)\n * - Shows avatar/photo\n * - Location name/address\n * - Battery level\n * - Last updated time\n * - Quick actions (Check-In, SOS, etc.)\n */\n\nimport { useState } from 'react';\nimport { FiBattery, FiClock, FiMapPin, FiNavigation } from 'react-icons/fi';\nimport type { UserLocation } from '../api/location-api';\n\ninterface MemberLocationCardProps {\n    location: UserLocation;\n    userName?: string;\n    userPhoto?: string;\n    batteryLevel?: number;\n    isOnline?: boolean;\n}\n\nexport const MemberLocationCard = ({\n    location,\n    userName = 'User',\n    userPhoto,\n    batteryLevel,\n    isOnline = true\n}: MemberLocationCardProps) => {\n    const [isExpanded, setIsExpanded] = useState(false);\n\n    // Format timestamp - handles Date objects, timestamps, and Firestore Timestamps\n    const formatTime = (date: Date | number | any) => {\n        const now = new Date();\n\n        // Convert to timestamp if it's a Date object or Firestore Timestamp\n        let timestamp: number;\n        if (typeof date === 'number') {\n            timestamp = date;\n        } else if (date && typeof date.getTime === 'function') {\n            timestamp = date.getTime();\n        } else if (date && typeof date.toMillis === 'function') {\n            // Firestore Timestamp\n            timestamp = date.toMillis();\n        } else {\n            return 'Unknown';\n        }\n\n        const diff = Math.floor((now.getTime() - timestamp) / 1000); // seconds\n\n        if (diff < 60) return 'Just now';\n        if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;\n        if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;\n        return new Date(timestamp).toLocaleDateString();\n    };\n\n    // Get battery icon color\n    const getBatteryColor = (level?: number) => {\n        if (!level) return 'text-gray-400';\n        if (level < 20) return 'text-red-500';\n        if (level < 50) return 'text-yellow-500';\n        return 'text-green-500';\n    };\n\n    return (\n        <div\n            className=\"bg-white rounded-2xl shadow-2xl p-4 cursor-pointer transition-all duration-200 hover:shadow-3xl border border-gray-100\"\n            onClick={() => setIsExpanded(!isExpanded)}\n        >\n            {/* Main Content */}\n            <div className=\"flex items-start gap-3\">\n                {/* Avatar */}\n                <div className=\"relative flex-shrink-0\">\n                    <div className=\"w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center text-white font-semibold text-lg overflow-hidden\">\n                        {userPhoto ? (\n                            <img src={userPhoto} alt={userName} className=\"w-full h-full object-cover\" />\n                        ) : (\n                            userName.charAt(0).toUpperCase()\n                        )}\n                    </div>\n                    {/* Online status indicator */}\n                    {isOnline && (\n                        <div className=\"absolute -bottom-0.5 -right-0.5 w-4 h-4 bg-green-500 rounded-full border-2 border-white\"></div>\n                    )}\n                </div>\n\n                {/* Info */}\n                <div className=\"flex-1 min-w-0\">\n                    <h3 className=\"font-semibold text-gray-900 text-base\">{userName}</h3>\n\n                    {/* Location & Status */}\n                    <div className=\"flex items-center gap-2 text-xs text-gray-600 mt-1\">\n                        <FiMapPin size={12} />\n                        <span className=\"truncate\">\n                            {location.latitude.toFixed(4)}, {location.longitude.toFixed(4)}\n                        </span>\n                    </div>\n\n                    {/* Time & Battery */}\n                    <div className=\"flex items-center gap-3 mt-2\">\n                        <div className=\"flex items-center gap-1 text-xs text-gray-500\">\n                            <FiClock size={12} />\n                            <span>{formatTime(location.timestamp)}</span>\n                        </div>\n\n                        {batteryLevel !== undefined && (\n                            <div className={`flex items-center gap-1 text-xs ${getBatteryColor(batteryLevel)}`}>\n                                <FiBattery size={12} />\n                                <span>{batteryLevel}%</span>\n                            </div>\n                        )}\n                    </div>\n                </div>\n\n                {/* Accuracy badge */}\n                <div className=\"flex-shrink-0\">\n                    <div className=\"px-2 py-1 bg-gray-100 rounded-full\">\n                        <span className=\"text-xs text-gray-600\">±{Math.round(location.accuracy)}m</span>\n                    </div>\n                </div>\n            </div>\n\n            {/* Expanded Content */}\n            {isExpanded && (\n                <div className=\"mt-4 pt-4 border-t border-gray-200 space-y-3\">\n                    {/* Additional Info */}\n                    <div className=\"grid grid-cols-2 gap-3 text-sm\">\n                        {location.speed !== null && location.speed !== undefined && (\n                            <div>\n                                <p className=\"text-xs text-gray-500\">Speed</p>\n                                <p className=\"font-semibold text-gray-900\">\n                                    {Math.round(location.speed * 3.6)} km/h\n                                </p>\n                            </div>\n                        )}\n\n                        {location.heading !== null && location.heading !== undefined && (\n                            <div>\n                                <p className=\"text-xs text-gray-500\">Heading</p>\n                                <p className=\"font-semibold text-gray-900\">{Math.round(location.heading)}°</p>\n                            </div>\n                        )}\n                    </div>\n\n                    {/* Quick Actions */}\n                    <div className=\"flex gap-2\">\n                        <button className=\"flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-colors text-sm font-medium\">\n                            <FiNavigation size={14} />\n                            Directions\n                        </button>\n                        <button className=\"flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium\">\n                            <FiMapPin size={14} />\n                            Details\n                        </button>\n                    </div>\n                </div>\n            )}\n        </div>\n    );\n};\n\n","/**\n * GeofenceManager Component\n * \n * UI for managing geofences (Life360 style)\n * - List of existing geofences\n * - Create new geofence button\n * - Edit/delete geofences\n * - Enable/disable geofences\n */\n\nimport { useState, useEffect } from 'react';\nimport { FiPlus, FiEdit2, FiTrash2, FiMapPin, FiHome, FiBriefcase, FiBookOpen, FiToggleLeft, FiToggleRight, FiAlertCircle, FiCheckCircle } from 'react-icons/fi';\nimport { useGeofences } from '../hooks/useGeofences';\nimport type { GeofenceZone, GeofenceType } from '../types';\nimport { LoadingSpinner } from '@/components/LoadingSpinner';\n\ninterface GeofenceManagerProps {\n    onEditGeofence?: (geofence: GeofenceZone) => void;\n    onDeleteGeofence?: (geofenceId: string) => void;\n    onCreateGeofence?: () => void;\n}\n\nexport const GeofenceManager = ({\n    onEditGeofence,\n    onDeleteGeofence,\n    onCreateGeofence,\n}: GeofenceManagerProps) => {\n    const { geofences, isLoading } = useGeofences();\n    const [expandedGeofence, setExpandedGeofence] = useState<string | null>(null);\n\n    // Debug: Log geofences changes\n    useEffect(() => {\n        console.log('[GeofenceManager] Geofences updated:', {\n            count: geofences.length,\n            geofences: geofences.map(g => ({ id: g.id, name: g.name, isActive: g.isActive })),\n            isLoading,\n        });\n    }, [geofences, isLoading]);\n\n    const getGeofenceIcon = (type: GeofenceType) => {\n        switch (type) {\n            case 'home':\n                return <FiHome className=\"text-blue-500\" size={20} />;\n            case 'school':\n                return <FiBookOpen className=\"text-green-500\" size={20} />;\n            case 'work':\n                return <FiBriefcase className=\"text-purple-500\" size={20} />;\n            default:\n                return <FiMapPin className=\"text-gray-500\" size={20} />;\n        }\n    };\n\n    const getGeofenceColor = (type: GeofenceType) => {\n        switch (type) {\n            case 'home':\n                return 'bg-blue-50 border-blue-200';\n            case 'school':\n                return 'bg-green-50 border-green-200';\n            case 'work':\n                return 'bg-purple-50 border-purple-200';\n            default:\n                return 'bg-gray-50 border-gray-200';\n        }\n    };\n\n    const formatRadius = (radius: number) => {\n        if (radius < 1000) {\n            return `${Math.round(radius)}m`;\n        }\n        return `${(radius / 1000).toFixed(1)}km`;\n    };\n\n    if (isLoading) {\n        return (\n            <div className=\"p-6\">\n                <div className=\"flex items-center justify-center py-12\">\n                    <LoadingSpinner size=\"medium\" />\n                </div>\n            </div>\n        );\n    }\n\n    return (\n        <div className=\"p-6\">\n            {/* Header */}\n            <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n                <div>\n                    <h2 className=\"text-2xl font-bold text-gray-900\">Geofences</h2>\n                    <p className=\"text-gray-600 mt-1\">\n                        Set up location alerts for your family\n                    </p>\n                </div>\n                <button\n                    onClick={() => {\n                        if (onCreateGeofence) {\n                            onCreateGeofence();\n                        }\n                    }}\n                    className=\"flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl hover:from-purple-700 hover:to-indigo-700 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5\"\n                >\n                    <FiPlus size={20} />\n                    <span className=\"font-semibold\">Add Geofence</span>\n                </button>\n            </div>\n\n            {/* Geofences List */}\n            {geofences.length === 0 ? (\n                <div className=\"bg-white rounded-2xl p-12 shadow-lg border border-gray-100 text-center\">\n                    <div className=\"w-20 h-20 bg-gradient-to-br from-purple-100 to-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4\">\n                        <FiMapPin size={36} className=\"text-purple-600\" />\n                    </div>\n                    <h3 className=\"text-xl font-semibold text-gray-900 mb-2\">\n                        No geofences yet\n                    </h3>\n                    <p className=\"text-gray-600 mb-6 max-w-md mx-auto\">\n                        Create your first geofence to start receiving location alerts when family members enter or leave specific areas\n                    </p>\n                    <button\n                        onClick={() => {\n                            if (onCreateGeofence) {\n                                onCreateGeofence();\n                            }\n                        }}\n                        className=\"px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl hover:from-purple-700 hover:to-indigo-700 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 font-semibold\"\n                    >\n                        <span className=\"flex items-center gap-2\">\n                            <FiPlus size={18} />\n                            Create Your First Geofence\n                        </span>\n                    </button>\n                </div>\n            ) : (\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    {geofences.map((geofence) => (\n                        <div\n                            key={geofence.id}\n                            className={`bg-white rounded-xl border-2 transition-all hover:shadow-lg ${\n                                expandedGeofence === geofence.id\n                                    ? 'shadow-lg border-purple-300'\n                                    : 'shadow-sm border-gray-200 hover:border-purple-200'\n                            } ${!geofence.isActive ? 'opacity-60' : ''}`}\n                        >\n                            {/* Geofence Header */}\n                            <div className=\"p-5\">\n                                <div className=\"flex items-start justify-between mb-3\">\n                                    <div className=\"flex items-center gap-3 flex-1\">\n                                        <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${\n                                            geofence.type === 'home' ? 'bg-blue-100' :\n                                            geofence.type === 'school' ? 'bg-green-100' :\n                                            geofence.type === 'work' ? 'bg-purple-100' :\n                                            'bg-gray-100'\n                                        }`}>\n                                            {getGeofenceIcon(geofence.type)}\n                                        </div>\n                                        <div className=\"flex-1 min-w-0\">\n                                            <h3 className=\"font-bold text-gray-900 text-lg mb-1\">\n                                                {geofence.name}\n                                            </h3>\n                                            <p className=\"text-sm text-gray-600 flex items-center gap-2\">\n                                                <span className=\"capitalize\">{geofence.type}</span>\n                                                <span>•</span>\n                                                <span>{formatRadius(geofence.radius)}</span>\n                                            </p>\n                                        </div>\n                                    </div>\n                                    <div className=\"flex items-center gap-1\">\n                                        {geofence.isActive ? (\n                                            <FiCheckCircle className=\"text-green-500\" size={20} />\n                                        ) : (\n                                            <FiAlertCircle className=\"text-gray-400\" size={20} />\n                                        )}\n                                    </div>\n                                </div>\n\n                                {/* Alert Status Badges */}\n                                <div className=\"flex flex-wrap gap-2 mb-3\">\n                                    {geofence.alertOnEntry && (\n                                        <span className=\"inline-flex items-center gap-1 px-2 py-1 bg-green-50 text-green-700 rounded-md text-xs font-medium\">\n                                            <FiAlertCircle size={12} />\n                                            Entry Alert\n                                        </span>\n                                    )}\n                                    {geofence.alertOnExit && (\n                                        <span className=\"inline-flex items-center gap-1 px-2 py-1 bg-orange-50 text-orange-700 rounded-md text-xs font-medium\">\n                                            <FiAlertCircle size={12} />\n                                            Exit Alert\n                                        </span>\n                                    )}\n                                </div>\n\n                                {/* Actions */}\n                                <div className=\"flex items-center justify-between pt-3 border-t border-gray-100\">\n                                    <div className=\"flex items-center gap-2\">\n                                        <button\n                                            onClick={() => {\n                                                // Toggle active state\n                                                // This would need to be implemented in the hook\n                                            }}\n                                            className={`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ${\n                                                geofence.isActive\n                                                    ? 'bg-green-100 text-green-700 hover:bg-green-200'\n                                                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'\n                                            }`}\n                                            title={geofence.isActive ? 'Disable geofence' : 'Enable geofence'}\n                                        >\n                                            {geofence.isActive ? (\n                                                <>\n                                                    <FiToggleRight size={16} />\n                                                    Active\n                                                </>\n                                            ) : (\n                                                <>\n                                                    <FiToggleLeft size={16} />\n                                                    Inactive\n                                                </>\n                                            )}\n                                        </button>\n                                    </div>\n                                    <div className=\"flex items-center gap-1\">\n                                        <button\n                                            onClick={() => onEditGeofence?.(geofence)}\n                                            className=\"p-2 text-gray-500 hover:text-purple-600 hover:bg-purple-50 rounded-lg transition-colors\"\n                                            title=\"Edit geofence\"\n                                        >\n                                            <FiEdit2 size={18} />\n                                        </button>\n                                        <button\n                                            onClick={() => {\n                                                if (confirm(`Are you sure you want to delete \"${geofence.name}\"?`)) {\n                                                    onDeleteGeofence?.(geofence.id);\n                                                }\n                                            }}\n                                            className=\"p-2 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors\"\n                                            title=\"Delete geofence\"\n                                        >\n                                            <FiTrash2 size={18} />\n                                        </button>\n                                    </div>\n                                </div>\n\n                                {/* Expanded Details */}\n                                {expandedGeofence === geofence.id && (\n                                    <div className=\"mt-4 pt-4 border-t border-gray-200\">\n                                        <div className=\"grid grid-cols-2 gap-4 text-sm mb-4\">\n                                            <div>\n                                                <span className=\"text-gray-600 block mb-1\">Latitude:</span>\n                                                <p className=\"font-mono text-xs font-medium\">\n                                                    {geofence.center.latitude.toFixed(6)}\n                                                </p>\n                                            </div>\n                                            <div>\n                                                <span className=\"text-gray-600 block mb-1\">Longitude:</span>\n                                                <p className=\"font-mono text-xs font-medium\">\n                                                    {geofence.center.longitude.toFixed(6)}\n                                                </p>\n                                            </div>\n                                        </div>\n                                        {geofence.description && (\n                                            <div className=\"mt-3 pt-3 border-t border-gray-100\">\n                                                <span className=\"text-gray-600 text-xs font-medium block mb-1\">Description:</span>\n                                                <p className=\"text-sm text-gray-700\">{geofence.description}</p>\n                                            </div>\n                                        )}\n                                    </div>\n                                )}\n                            </div>\n                        </div>\n                    ))}\n                </div>\n            )}\n        </div>\n    );\n};\n","/**\n * GeofenceMapEditor Component\n * \n * Interactive map-based geofence creation/editing\n * - Click to place center\n * - Drag to resize radius\n * - Visual feedback\n */\n\nimport { useEffect, useRef, useState, useCallback } from 'react';\nimport { googleMapsLoader } from '@/lib/services/google-maps-loader';\nimport { FiX, FiHome, FiBriefcase, FiBookOpen, FiMapPin, FiNavigation, FiTarget } from 'react-icons/fi';\nimport type { GeofenceType, CreateGeofenceRequest } from '../types';\nimport { useAuth } from '@/features/auth/hooks/useAuth';\nimport { useHubStore } from '@/lib/store/hub-store';\nimport { useUserLocation } from '@/features/location/hooks/useLocation';\n\ninterface GeofenceMapEditorProps {\n    isOpen: boolean;\n    onClose: () => void;\n    onSave: (data: CreateGeofenceRequest) => void;\n    initialLocation?: {\n        latitude: number;\n        longitude: number;\n    };\n    geofence?: {\n        id?: string;\n        name: string;\n        description?: string;\n        type: GeofenceType;\n        center: { latitude: number; longitude: number };\n        radius: number;\n        alertOnEntry?: boolean;\n        alertOnExit?: boolean;\n    } | null;\n}\n\nexport const GeofenceMapEditor = ({\n    isOpen,\n    onClose,\n    onSave,\n    initialLocation,\n    geofence,\n}: GeofenceMapEditorProps) => {\n    console.log('[GeofenceMapEditor] Component rendered', {\n        isOpen,\n        hasGeofence: !!geofence,\n        geofenceId: geofence?.id,\n        initialLocation,\n    });\n\n    const { currentHub } = useHubStore();\n    const { currentLocation } = useUserLocation();\n    const mapRef = useRef<HTMLDivElement>(null);\n    const googleMapRef = useRef<google.maps.Map | null>(null);\n    const circleRef = useRef<google.maps.Circle | null>(null);\n    const centerMarkerRef = useRef<google.maps.Marker | null>(null);\n    const resizeMarkersRef = useRef<google.maps.Marker[]>([]);\n    const clickListenerRef = useRef<google.maps.MapsEventListener | null>(null);\n\n    // Get the best available location (current location > initial location > null)\n    const bestLocation = currentLocation \n        ? { latitude: currentLocation.latitude, longitude: currentLocation.longitude }\n        : initialLocation;\n\n    console.log('[GeofenceMapEditor] Location data:', {\n        currentLocation: currentLocation ? { lat: currentLocation.latitude, lng: currentLocation.longitude } : null,\n        initialLocation,\n        bestLocation: bestLocation ? { lat: bestLocation.latitude, lng: bestLocation.longitude } : null,\n    });\n\n    const [isMapLoaded, setIsMapLoaded] = useState(false);\n    const [isPlacementMode, setIsPlacementMode] = useState(false);\n    const [hasPlacedCenter, setHasPlacedCenter] = useState(false);\n    const [formData, setFormData] = useState({\n        name: geofence?.name || '',\n        description: geofence?.description || '',\n        type: (geofence?.type || 'custom') as GeofenceType,\n        center: geofence?.center || bestLocation || { latitude: 0, longitude: 0 },\n        radius: geofence?.radius || 100,\n        alertOnEntry: geofence?.alertOnEntry !== undefined ? geofence.alertOnEntry : true,\n        alertOnExit: geofence?.alertOnExit !== undefined ? geofence.alertOnExit : true,\n        alertRecipients: [] as string[],\n    });\n    \n    // Use refs to track current state so click handler always has latest values\n    const isPlacementModeRef = useRef(false);\n    const hasPlacedCenterRef = useRef(false);\n    const formDataRef = useRef(formData);\n    const geofenceRef = useRef(geofence);\n    const hasInitializedRef = useRef(false);\n    // Track if user just activated placement mode - update immediately to prevent reset\n    const userActivatedPlacementModeRef = useRef(false);\n    \n    // Update refs when state changes\n    // Note: Button handlers set refs immediately, but this sync ensures consistency\n    // IMPORTANT: Don't clear userActivatedPlacementModeRef here - it's only cleared in button handlers\n    useEffect(() => {\n        // Sync refs with state (button handlers set refs immediately, but this ensures consistency)\n        isPlacementModeRef.current = isPlacementMode;\n        hasPlacedCenterRef.current = hasPlacedCenter;\n        // Note: userActivatedPlacementModeRef is only managed in button handlers, not here\n        // This prevents the effect from clearing it when state changes due to other reasons\n    }, [isPlacementMode, hasPlacedCenter]);\n    \n    useEffect(() => {\n        formDataRef.current = formData;\n    }, [formData]);\n    \n    useEffect(() => {\n        geofenceRef.current = geofence;\n    }, [geofence]);\n\n    console.log('[GeofenceMapEditor] Form data initialized:', {\n        name: formData.name,\n        center: formData.center,\n        radius: formData.radius,\n        type: formData.type,\n    });\n\n    // Update form data when geofence prop changes or location becomes available\n    // Use a ref to track initialization to prevent resetting placement mode on re-runs\n    useEffect(() => {\n        console.log('[GeofenceMapEditor] Form data effect triggered', {\n            isOpen,\n            hasGeofence: !!geofence,\n            geofenceId: geofence?.id,\n            bestLocation: bestLocation ? { lat: bestLocation.latitude, lng: bestLocation.longitude } : null,\n            hasInitialized: hasInitializedRef.current,\n            currentPlacementMode: isPlacementModeRef.current,\n        });\n\n        // Reset initialization flag when modal closes\n        if (!isOpen) {\n            hasInitializedRef.current = false;\n            userActivatedPlacementModeRef.current = false;\n            return;\n        }\n\n        // CRITICAL: If user has activated placement mode, NEVER run initialization logic\n        // This prevents the effect from resetting placement mode after user activates it\n        // Check the ref first (updated immediately) then state (might be stale during batched updates)\n        // Also check userActivatedPlacementModeRef which is set when user clicks the button\n        const placementModeActive = userActivatedPlacementModeRef.current || isPlacementModeRef.current || isPlacementMode;\n        if (placementModeActive) {\n            console.log('[GeofenceMapEditor] Placement mode is active, skipping form data effect to preserve user state', {\n                userActivated: userActivatedPlacementModeRef.current,\n                refValue: isPlacementModeRef.current,\n                stateValue: isPlacementMode,\n                hasInitialized: hasInitializedRef.current,\n            });\n            // Don't modify any state when placement mode is active - user controls it\n            return;\n        }\n\n        // Only initialize once when modal opens\n        if (hasInitializedRef.current && geofence?.id) {\n            // Geofence prop changed - update form data\n            if (geofence) {\n                console.log('[GeofenceMapEditor] Geofence prop changed, updating form data');\n                setFormData(prev => ({\n                    ...prev,\n                    name: geofence.name,\n                    description: geofence.description || '',\n                    type: geofence.type,\n                    center: geofence.center,\n                    radius: geofence.radius,\n                    alertOnEntry: geofence.alertOnEntry !== undefined ? geofence.alertOnEntry : true,\n                    alertOnExit: geofence.alertOnExit !== undefined ? geofence.alertOnExit : true,\n                }));\n                setHasPlacedCenter(true);\n                setIsPlacementMode(false);\n            }\n            return;\n        }\n\n        if (geofence && isOpen) {\n            console.log('[GeofenceMapEditor] Editing existing geofence:', geofence);\n            setFormData(prev => ({\n                ...prev,\n                name: geofence.name,\n                description: geofence.description || '',\n                type: geofence.type,\n                center: geofence.center,\n                radius: geofence.radius,\n                alertOnEntry: geofence.alertOnEntry !== undefined ? geofence.alertOnEntry : true,\n                alertOnExit: geofence.alertOnExit !== undefined ? geofence.alertOnExit : true,\n            }));\n            setHasPlacedCenter(true);\n            setIsPlacementMode(false);\n            hasInitializedRef.current = true;\n            console.log('[GeofenceMapEditor] Form data updated for editing, hasPlacedCenter: true');\n        } else if (!geofence && isOpen) {\n            console.log('[GeofenceMapEditor] Creating new geofence');\n            // Only initialize form data if not already initialized\n            // CRITICAL: Never reset placement mode if user has activated it\n            // Check placement mode state BEFORE any initialization logic\n            const userActivatedPlacementMode = isPlacementMode || isPlacementModeRef.current;\n            \n            if (!hasInitializedRef.current) {\n                // First time opening modal for new geofence - reset placement state ONLY if user hasn't activated it\n                setHasPlacedCenter(false);\n                // Only reset placement mode if user hasn't activated it\n                if (!userActivatedPlacementMode) {\n                    setIsPlacementMode(false);\n                } else {\n                    console.log('[GeofenceMapEditor] User has activated placement mode, preserving it during initialization');\n                }\n                \n                if (bestLocation && bestLocation.latitude !== 0 && bestLocation.longitude !== 0) {\n                    console.log('[GeofenceMapEditor] Setting initial location from bestLocation:', bestLocation);\n                    setFormData(prev => {\n                        if (prev.center.latitude === 0 && prev.center.longitude === 0) {\n                            console.log('[GeofenceMapEditor] Updating form data with bestLocation');\n                            return {\n                                ...prev,\n                                name: '',\n                                description: '',\n                                type: 'custom',\n                                center: bestLocation,\n                                radius: 100,\n                                alertOnEntry: true,\n                                alertOnExit: true,\n                                alertRecipients: [],\n                            };\n                        }\n                        console.log('[GeofenceMapEditor] Form data center already set, skipping update');\n                        return prev;\n                    });\n                } else {\n                    console.warn('[GeofenceMapEditor] No bestLocation available for new geofence');\n                }\n                hasInitializedRef.current = true;\n                console.log('[GeofenceMapEditor] Initialization complete, hasInitialized set to true');\n            } else {\n                // Already initialized - don't touch placement mode state at all\n                // This preserves the user's placement mode state when the effect re-runs\n                console.log('[GeofenceMapEditor] Already initialized, preserving all state (placement mode, placed center)', {\n                    currentPlacementMode: isPlacementMode,\n                    refPlacementMode: isPlacementModeRef.current,\n                    hasPlacedCenter,\n                });\n                // Don't modify any placement-related state - let the user control it via the button\n            }\n        }\n    }, [geofence, isOpen, bestLocation]);\n\n    // Get geofence color - define early since it's used by multiple functions\n    const getGeofenceColor = (type: GeofenceType): string => {\n        switch (type) {\n            case 'home': return '#3B82F6';\n            case 'school': return '#10B981';\n            case 'work': return '#8B5CF6';\n            default: return '#6B7280';\n        }\n    };\n\n    // Create resize markers around the circle - define early since it's used by multiple useEffects\n    const createResizeMarkers = useCallback(() => {\n        console.log('[GeofenceMapEditor] createResizeMarkers called', {\n            hasGoogleMap: !!googleMapRef.current,\n            hasCircle: !!circleRef.current,\n        });\n\n        if (!googleMapRef.current || !circleRef.current) {\n            console.warn('[GeofenceMapEditor] Cannot create resize markers - map or circle not available');\n            return;\n        }\n\n        // Clear existing resize markers and their listeners\n        resizeMarkersRef.current.forEach(marker => {\n            if (marker) {\n                google.maps.event.clearInstanceListeners(marker);\n                marker.setMap(null);\n            }\n        });\n        resizeMarkersRef.current = [];\n\n        const center = circleRef.current.getCenter();\n        if (!center) {\n            console.warn('[GeofenceMapEditor] Circle has no center, cannot create resize markers');\n            return;\n        }\n\n        const radius = circleRef.current.getRadius();\n        const color = getGeofenceColor(formData.type);\n        \n        console.log('[GeofenceMapEditor] Creating resize markers', {\n            center: { lat: center.lat(), lng: center.lng() },\n            radius,\n            color,\n        });\n        \n        // Create 4 resize markers around the circle (North, East, South, West)\n        const angles = [0, 90, 180, 270];\n        \n        angles.forEach((angle) => {\n            // Calculate position using Google Maps geometry\n            const point = google.maps.geometry.spherical.computeOffset(\n                center,\n                radius,\n                angle\n            );\n            \n            const marker = new google.maps.Marker({\n                position: point,\n                map: googleMapRef.current,\n                title: 'Drag to resize',\n                draggable: !isPlacementMode,\n                icon: {\n                    path: google.maps.SymbolPath.CIRCLE,\n                    scale: 10,\n                    fillColor: '#FFFFFF',\n                    fillOpacity: 1,\n                    strokeColor: color,\n                    strokeWeight: 3,\n                },\n                zIndex: 999,\n                optimized: false,\n                visible: !isPlacementMode, // Hide during placement mode\n            });\n\n            // Add drag listener to update radius\n            marker.addListener('drag', () => {\n                if (isPlacementMode) return; // Don't allow resizing in placement mode\n                \n                const newPosition = marker.getPosition();\n                const currentCenter = circleRef.current?.getCenter();\n                if (newPosition && currentCenter) {\n                    const newRadius = google.maps.geometry.spherical.computeDistanceBetween(\n                        currentCenter,\n                        newPosition\n                    );\n                    // Update radius directly via setFormData to avoid circular dependency\n                    const clampedRadius = Math.max(10, Math.min(5000, newRadius));\n                    setFormData(prev => {\n                        if (Math.abs(prev.radius - clampedRadius) < 1) {\n                            return prev;\n                        }\n                        return {\n                            ...prev,\n                            radius: clampedRadius,\n                        };\n                    });\n                    \n                    // Update circle immediately\n                    if (circleRef.current) {\n                        circleRef.current.setRadius(clampedRadius);\n                    }\n                }\n            });\n\n            resizeMarkersRef.current.push(marker);\n        });\n\n        console.log('[GeofenceMapEditor] Resize markers created:', resizeMarkersRef.current.length);\n    }, [formData.type, isPlacementMode]);\n\n    // Set up map click listener when map is ready - separate effect for better control\n    useEffect(() => {\n        console.log('[GeofenceMapEditor] Click listener effect triggered', {\n            isMapLoaded,\n            hasGoogleMap: !!googleMapRef.current,\n            isOpen,\n            hasClickListener: !!clickListenerRef.current,\n        });\n\n        if (!isOpen) {\n            console.log('[GeofenceMapEditor] Modal not open, skipping click listener setup');\n            return;\n        }\n\n        if (!isMapLoaded) {\n            console.log('[GeofenceMapEditor] Map not loaded yet, skipping click listener setup');\n            return;\n        }\n\n        if (!googleMapRef.current) {\n            console.warn('[GeofenceMapEditor] Google map ref is null, cannot set up click listener');\n            return;\n        }\n\n        console.log('[GeofenceMapEditor] Setting up map click listener', {\n            isPlacementMode: isPlacementModeRef.current,\n            hasPlacedCenter: hasPlacedCenterRef.current,\n            hasGeofence: !!geofenceRef.current,\n            mapReady: !!googleMapRef.current,\n        });\n\n        // Remove existing click listener\n        if (clickListenerRef.current) {\n            console.log('[GeofenceMapEditor] Removing existing click listener');\n            google.maps.event.removeListener(clickListenerRef.current);\n            clickListenerRef.current = null;\n        }\n\n        // Add map click listener - use refs so it always has latest state\n        clickListenerRef.current = google.maps.event.addListener(\n            googleMapRef.current,\n            'click',\n            (e: google.maps.MapMouseEvent) => {\n                // Use refs to get current state values\n                const currentPlacementMode = isPlacementModeRef.current;\n                const currentHasPlacedCenter = hasPlacedCenterRef.current;\n                const currentGeofence = geofenceRef.current;\n                const currentFormData = formDataRef.current;\n\n                console.log('[GeofenceMapEditor] Map clicked', {\n                    hasLatLng: !!e.latLng,\n                    latLng: e.latLng ? { lat: e.latLng.lat(), lng: e.latLng.lng() } : null,\n                    isPlacementMode: currentPlacementMode,\n                    hasPlacedCenter: currentHasPlacedCenter,\n                    hasGeofence: !!currentGeofence,\n                });\n\n                if (!e.latLng) {\n                    console.warn('[GeofenceMapEditor] Click event has no latLng');\n                    return;\n                }\n                \n                const lat = e.latLng.lat();\n                const lng = e.latLng.lng();\n                \n                console.log('[GeofenceMapEditor] Map clicked - processing', {\n                    lat,\n                    lng,\n                    isPlacementMode: currentPlacementMode,\n                    hasGeofence: !!currentGeofence,\n                });\n                \n                // If in placement mode, place the geofence\n                if (currentPlacementMode) {\n                    console.log('[GeofenceMapEditor] In placement mode - placing geofence at:', { lat, lng });\n                    \n                    // Update center\n                    setFormData(prev => {\n                        console.log('[GeofenceMapEditor] Updating formData center', {\n                            old: prev.center,\n                            new: { latitude: lat, longitude: lng },\n                        });\n                        return {\n                            ...prev,\n                            center: { latitude: lat, longitude: lng },\n                        };\n                    });\n                    \n                    // Exit placement mode and show geofence\n                    console.log('[GeofenceMapEditor] Exiting placement mode and creating geofence');\n                    // Clear refs immediately\n                    userActivatedPlacementModeRef.current = false;\n                    isPlacementModeRef.current = false;\n                    // Then update state\n                    setHasPlacedCenter(true);\n                    setIsPlacementMode(false);\n                    \n                    // Update map draggability\n                    if (googleMapRef.current) {\n                        googleMapRef.current.setOptions({\n                            draggable: true,\n                            draggableCursor: 'default',\n                        });\n                    }\n                    \n                    // Create marker and circle if they don't exist\n                    if (!centerMarkerRef.current) {\n                        console.log('[GeofenceMapEditor] Creating center marker');\n                        const centerPos = new google.maps.LatLng(lat, lng);\n                        const markerColor = getGeofenceColor(currentFormData.type);\n                        \n        centerMarkerRef.current = new google.maps.Marker({\n                            position: centerPos,\n            map: googleMapRef.current,\n            title: 'Geofence Center',\n            draggable: true,\n            icon: {\n                path: google.maps.SymbolPath.CIRCLE,\n                                scale: 12,\n                                fillColor: markerColor,\n                fillOpacity: 1,\n                strokeColor: '#FFFFFF',\n                                strokeWeight: 3,\n                            },\n                            zIndex: 1000,\n                            optimized: false,\n                        });\n\n                        // Add drag listener\n                        centerMarkerRef.current.addListener('drag', (e: google.maps.MapMouseEvent) => {\n                            if (e.latLng) {\n                                console.log('[GeofenceMapEditor] Center marker dragged', {\n                                    lat: e.latLng.lat(),\n                                    lng: e.latLng.lng(),\n                                });\n                                setFormData(prev => ({\n                                    ...prev,\n                                    center: { latitude: e.latLng!.lat(), longitude: e.latLng!.lng() },\n                                }));\n                            }\n                        });\n                        console.log('[GeofenceMapEditor] Center marker created and drag listener added');\n                    } else {\n                        // Update existing marker position\n                        console.log('[GeofenceMapEditor] Updating existing center marker position');\n                        centerMarkerRef.current.setPosition(new google.maps.LatLng(lat, lng));\n                    }\n                    \n                    if (!circleRef.current) {\n                        console.log('[GeofenceMapEditor] Creating circle');\n                        const centerPos = new google.maps.LatLng(lat, lng);\n                        const circleColor = getGeofenceColor(currentFormData.type);\n                        \n        circleRef.current = new google.maps.Circle({\n                            strokeColor: circleColor,\n            strokeOpacity: 0.8,\n            strokeWeight: 2,\n                            fillColor: circleColor,\n            fillOpacity: 0.2,\n            map: googleMapRef.current,\n                            center: centerPos,\n                            radius: currentFormData.radius,\n            clickable: false,\n        });\n\n                        console.log('[GeofenceMapEditor] Circle created, creating resize markers');\n                        // Create resize markers after circle is created - call it directly\n                        if (googleMapRef.current && circleRef.current) {\n                            // Clear existing resize markers\n                            resizeMarkersRef.current.forEach(marker => {\n                                if (marker) {\n                                    google.maps.event.clearInstanceListeners(marker);\n                                    marker.setMap(null);\n                                }\n                            });\n                            resizeMarkersRef.current = [];\n\n                            const center = circleRef.current.getCenter();\n                            if (center) {\n                                const radius = circleRef.current.getRadius();\n                                const color = getGeofenceColor(currentFormData.type);\n                                const angles = [0, 90, 180, 270];\n                                \n                                angles.forEach((angle) => {\n                                    const point = google.maps.geometry.spherical.computeOffset(\n                                        center,\n                                        radius,\n                                        angle\n                                    );\n                                    \n                                    const marker = new google.maps.Marker({\n                                        position: point,\n                                        map: googleMapRef.current,\n                                        title: 'Drag to resize',\n                                        draggable: true,\n                                        icon: {\n                                            path: google.maps.SymbolPath.CIRCLE,\n                                            scale: 10,\n                                            fillColor: '#FFFFFF',\n                                            fillOpacity: 1,\n                                            strokeColor: color,\n                                            strokeWeight: 3,\n                                        },\n                                        zIndex: 999,\n                                        optimized: false,\n                                    });\n\n                                    marker.addListener('drag', () => {\n                                        const newPosition = marker.getPosition();\n                                        const currentCenter = circleRef.current?.getCenter();\n                                        if (newPosition && currentCenter) {\n                                            const newRadius = google.maps.geometry.spherical.computeDistanceBetween(\n                                                currentCenter,\n                                                newPosition\n                                            );\n                                            const clampedRadius = Math.max(10, Math.min(5000, newRadius));\n                                            setFormData(prev => {\n                                                if (Math.abs(prev.radius - clampedRadius) < 1) {\n                                                    return prev;\n                                                }\n                                                return {\n                                                    ...prev,\n                                                    radius: clampedRadius,\n                                                };\n                                            });\n                                            \n                                            if (circleRef.current) {\n                                                circleRef.current.setRadius(clampedRadius);\n                                            }\n                                        }\n                                    });\n\n                                    resizeMarkersRef.current.push(marker);\n                                });\n                                console.log('[GeofenceMapEditor] Resize markers created:', resizeMarkersRef.current.length);\n                            }\n                        }\n                    } else {\n                        // Update existing circle\n                        console.log('[GeofenceMapEditor] Updating existing circle');\n                        circleRef.current.setCenter(new google.maps.LatLng(lat, lng));\n                        // Update resize markers positions\n                        if (resizeMarkersRef.current.length > 0 && circleRef.current) {\n        const center = circleRef.current.getCenter();\n                            if (center) {\n        const radius = circleRef.current.getRadius();\n                                const angles = [0, 90, 180, 270];\n                                resizeMarkersRef.current.forEach((marker, index) => {\n                                    if (marker && center) {\n                                        const point = google.maps.geometry.spherical.computeOffset(\n                                            center,\n                                            radius,\n                                            angles[index]\n                                        );\n                                        marker.setPosition(point);\n                                    }\n                                });\n                            }\n                        } else if (circleRef.current) {\n                            // Create resize markers if they don't exist\n                            const center = circleRef.current.getCenter();\n                            if (center && googleMapRef.current) {\n                                const radius = circleRef.current.getRadius();\n                                const color = getGeofenceColor(currentFormData.type);\n                                const angles = [0, 90, 180, 270];\n                                \n                                resizeMarkersRef.current.forEach(marker => {\n                                    if (marker) {\n                                        google.maps.event.clearInstanceListeners(marker);\n                                        marker.setMap(null);\n                                    }\n                                });\n                                resizeMarkersRef.current = [];\n                                \n                                angles.forEach((angle) => {\n                                    const point = google.maps.geometry.spherical.computeOffset(\n                                        center,\n                                        radius,\n                                        angle\n                                    );\n            \n            const marker = new google.maps.Marker({\n                                        position: point,\n                map: googleMapRef.current,\n                                        title: 'Drag to resize',\n                draggable: true,\n                icon: {\n                    path: google.maps.SymbolPath.CIRCLE,\n                                            scale: 10,\n                    fillColor: '#FFFFFF',\n                    fillOpacity: 1,\n                                            strokeColor: color,\n                                            strokeWeight: 3,\n                },\n                                        zIndex: 999,\n                                        optimized: false,\n            });\n\n            marker.addListener('drag', () => {\n                                        const newPosition = marker.getPosition();\n                                        const currentCenter = circleRef.current?.getCenter();\n                                        if (newPosition && currentCenter) {\n                const newRadius = google.maps.geometry.spherical.computeDistanceBetween(\n                                                currentCenter,\n                                                newPosition\n                                            );\n                                            const clampedRadius = Math.max(10, Math.min(5000, newRadius));\n                                            setFormData(prev => {\n                                                if (Math.abs(prev.radius - clampedRadius) < 1) {\n                                                    return prev;\n                                                }\n                                                return {\n                                                    ...prev,\n                                                    radius: clampedRadius,\n                                                };\n                                            });\n                                            \n                                            if (circleRef.current) {\n                                                circleRef.current.setRadius(clampedRadius);\n                                            }\n                                        }\n            });\n\n            resizeMarkersRef.current.push(marker);\n        });\n                            }\n                        }\n                    }\n                } else if (currentGeofence) {\n                    // Editing existing geofence - allow clicking to move center\n                    console.log('[GeofenceMapEditor] Editing geofence - updating center');\n                    setFormData(prev => ({\n                        ...prev,\n                        center: { latitude: lat, longitude: lng },\n                    }));\n                } else {\n                    console.log('[GeofenceMapEditor] Click ignored - not in placement mode and not editing');\n                }\n            }\n        );\n\n        console.log('[GeofenceMapEditor] Map click listener added successfully');\n\n        // Cleanup\n        return () => {\n            if (clickListenerRef.current && googleMapRef.current) {\n                console.log('[GeofenceMapEditor] Removing click listener on cleanup');\n                google.maps.event.removeListener(clickListenerRef.current);\n                clickListenerRef.current = null;\n            }\n        };\n        // eslint-disable-next-line react-hooks/exhaustive-deps\n    }, [isMapLoaded, isOpen]); // Only depend on isMapLoaded and isOpen - click handler uses refs for current state\n\n    // Initialize markers for existing geofence when map and geofence are ready\n    useEffect(() => {\n        if (!isMapLoaded || !googleMapRef.current || !geofence || centerMarkerRef.current || circleRef.current) {\n            return;\n        }\n\n        console.log('[GeofenceMapEditor] Creating markers for existing geofence');\n        const centerPos = new google.maps.LatLng(formData.center.latitude, formData.center.longitude);\n        const markerColor = getGeofenceColor(formData.type);\n\n        // Create center marker\n        centerMarkerRef.current = new google.maps.Marker({\n            position: centerPos,\n            map: googleMapRef.current,\n            title: 'Geofence Center',\n            draggable: true,\n            icon: {\n                path: google.maps.SymbolPath.CIRCLE,\n                scale: 12,\n                fillColor: markerColor,\n                fillOpacity: 1,\n                strokeColor: '#FFFFFF',\n                strokeWeight: 3,\n            },\n            zIndex: 1000,\n            optimized: false,\n        });\n\n        centerMarkerRef.current.addListener('drag', (e: google.maps.MapMouseEvent) => {\n            if (e.latLng) {\n                console.log('[GeofenceMapEditor] Editing: Center marker dragged', {\n                    lat: e.latLng.lat(),\n                    lng: e.latLng.lng(),\n                });\n        setFormData(prev => ({\n            ...prev,\n                    center: { latitude: e.latLng!.lat(), longitude: e.latLng!.lng() },\n                }));\n            }\n        });\n\n        // Create circle\n        circleRef.current = new google.maps.Circle({\n            strokeColor: markerColor,\n            strokeOpacity: 0.8,\n            strokeWeight: 2,\n            fillColor: markerColor,\n            fillOpacity: 0.2,\n            map: googleMapRef.current,\n            center: centerPos,\n            radius: formData.radius,\n            clickable: false,\n        });\n\n        console.log('[GeofenceMapEditor] Created markers and circle for existing geofence');\n        // Create resize markers after circle is created\n        createResizeMarkers();\n    }, [isMapLoaded, geofence, formData.center.latitude, formData.center.longitude, formData.radius, formData.type, createResizeMarkers]);\n\n    // Update map draggability based on placement mode\n    useEffect(() => {\n        console.log('[GeofenceMapEditor] Map draggability effect triggered', {\n            hasGoogleMap: !!googleMapRef.current,\n            isPlacementMode,\n            hasPlacedCenter,\n        });\n\n        if (!googleMapRef.current) {\n            console.log('[GeofenceMapEditor] Google map ref is null, skipping draggability update');\n            return;\n        }\n        \n        // Update map draggability\n        const shouldBeDraggable = !isPlacementMode && hasPlacedCenter;\n        console.log('[GeofenceMapEditor] Updating map draggability', {\n            draggable: shouldBeDraggable,\n            cursor: isPlacementMode ? 'crosshair' : 'default',\n        });\n        \n        googleMapRef.current.setOptions({\n            draggable: shouldBeDraggable,\n            draggableCursor: isPlacementMode ? 'crosshair' : 'default',\n        });\n        \n        console.log('[GeofenceMapEditor] Map draggability updated');\n    }, [isPlacementMode, hasPlacedCenter]);\n\n    // Update visualization when formData changes\n    useEffect(() => {\n        console.log('[GeofenceMapEditor] Visualization update effect triggered', {\n            isMapLoaded,\n            hasGoogleMap: !!googleMapRef.current,\n            formDataCenter: formData.center,\n            hasPlacedCenter,\n            hasGeofence: !!geofence,\n            isPlacementMode,\n        });\n\n        if (!isMapLoaded || !googleMapRef.current) {\n            console.log('[GeofenceMapEditor] Map not loaded yet, skipping visualization update');\n            return;\n        }\n\n        if (formData.center.latitude === 0 && formData.center.longitude === 0) {\n            console.log('[GeofenceMapEditor] Form data center is at origin, skipping visualization update');\n            return;\n        }\n\n        if (!hasPlacedCenter && !geofence) {\n            console.log('[GeofenceMapEditor] Center not placed yet and not editing, skipping visualization');\n            return; // Don't show geofence until center is placed\n        }\n\n        const center = new google.maps.LatLng(formData.center.latitude, formData.center.longitude);\n        const color = getGeofenceColor(formData.type);\n\n        console.log('[GeofenceMapEditor] Updating visualization', {\n            center: { lat: formData.center.latitude, lng: formData.center.longitude },\n            radius: formData.radius,\n            color,\n            hasCenterMarker: !!centerMarkerRef.current,\n            hasCircle: !!circleRef.current,\n        });\n\n        // Update center marker\n        if (centerMarkerRef.current) {\n            console.log('[GeofenceMapEditor] Updating center marker position and style');\n            centerMarkerRef.current.setPosition(center);\n            centerMarkerRef.current.setIcon({\n                path: google.maps.SymbolPath.CIRCLE,\n                scale: 12,\n                fillColor: color,\n                fillOpacity: 1,\n                strokeColor: '#FFFFFF',\n                strokeWeight: 3,\n            });\n            centerMarkerRef.current.setDraggable(!isPlacementMode); // Only draggable when not in placement mode\n        } else if (hasPlacedCenter || geofence) {\n            console.log('[GeofenceMapEditor] Creating center marker (should have been created earlier)');\n            // Marker should have been created, but if not, create it now\n            const markerColor = getGeofenceColor(formData.type);\n            centerMarkerRef.current = new google.maps.Marker({\n                position: center,\n                map: googleMapRef.current,\n                title: 'Geofence Center',\n                draggable: !isPlacementMode,\n                icon: {\n                    path: google.maps.SymbolPath.CIRCLE,\n                    scale: 12,\n                    fillColor: markerColor,\n                    fillOpacity: 1,\n                    strokeColor: '#FFFFFF',\n                    strokeWeight: 3,\n                },\n                zIndex: 1000,\n                optimized: false,\n            });\n\n            centerMarkerRef.current.addListener('drag', (e: google.maps.MapMouseEvent) => {\n                if (e.latLng) {\n                    console.log('[GeofenceMapEditor] Center marker dragged', {\n                        lat: e.latLng.lat(),\n                        lng: e.latLng.lng(),\n                    });\n        setFormData(prev => ({\n            ...prev,\n                        center: { latitude: e.latLng!.lat(), longitude: e.latLng!.lng() },\n        }));\n        }\n            });\n        }\n\n        // Update circle\n        if (circleRef.current) {\n            console.log('[GeofenceMapEditor] Updating circle position and style');\n            circleRef.current.setCenter(center);\n            circleRef.current.setRadius(formData.radius);\n            circleRef.current.setOptions({\n                strokeColor: color,\n                fillColor: color,\n            });\n        } else if (hasPlacedCenter || geofence) {\n            console.log('[GeofenceMapEditor] Creating circle (should have been created earlier)');\n            // Circle should have been created, but if not, create it now\n            circleRef.current = new google.maps.Circle({\n                strokeColor: color,\n                strokeOpacity: 0.8,\n                strokeWeight: 2,\n                fillColor: color,\n                fillOpacity: 0.2,\n                map: googleMapRef.current,\n                center,\n                radius: formData.radius,\n                clickable: false,\n            });\n            createResizeMarkers();\n        }\n\n        // Update resize markers positions (only show when center is placed)\n        if (circleRef.current && resizeMarkersRef.current.length === 4 && (hasPlacedCenter || geofence)) {\n            const circleCenter = circleRef.current.getCenter();\n            if (circleCenter) {\n                console.log('[GeofenceMapEditor] Updating resize markers positions');\n                const angles = [0, 90, 180, 270];\n                resizeMarkersRef.current.forEach((marker, index) => {\n                    if (marker) {\n                        const point = google.maps.geometry.spherical.computeOffset(\n                            circleCenter,\n                            formData.radius,\n                            angles[index]\n                        );\n                        marker.setPosition(point);\n                        marker.setIcon({\n                            path: google.maps.SymbolPath.CIRCLE,\n                            scale: 10,\n                            fillColor: '#FFFFFF',\n                            fillOpacity: 1,\n                            strokeColor: color,\n                            strokeWeight: 3,\n                        });\n                        marker.setDraggable(!isPlacementMode); // Only draggable when not in placement mode\n                        marker.setVisible(!isPlacementMode); // Hide during placement mode\n                    }\n                });\n            }\n        } else if (circleRef.current && (hasPlacedCenter || geofence) && resizeMarkersRef.current.length === 0) {\n            console.log('[GeofenceMapEditor] Resize markers missing, creating them');\n        createResizeMarkers();\n        }\n    }, [formData.center.latitude, formData.center.longitude, formData.radius, formData.type, isMapLoaded, hasPlacedCenter, isPlacementMode, geofence, createResizeMarkers]);\n\n    // Set alert recipients to all hub members when creating new geofence\n    useEffect(() => {\n        if (!geofence && currentHub?.members && formData.alertRecipients.length === 0) {\n            // In a real app, you'd get hub members here\n            // For now, we'll leave it empty and the backend can handle it\n            setFormData(prev => ({ ...prev, alertRecipients: [] }));\n        }\n    }, [geofence, currentHub]);\n\n    // Initialize map when opened and location is available\n    useEffect(() => {\n        console.log('[GeofenceMapEditor] Map initialization effect triggered', {\n            isOpen,\n            hasMapRef: !!mapRef.current,\n            hasGoogleMap: !!googleMapRef.current,\n            hasGeofence: !!geofence,\n            bestLocation: bestLocation ? { lat: bestLocation.latitude, lng: bestLocation.longitude } : null,\n        });\n\n        if (!isOpen) {\n            console.log('[GeofenceMapEditor] Modal is not open, skipping map initialization');\n            return;\n        }\n\n        if (!mapRef.current) {\n            console.warn('[GeofenceMapEditor] Map ref is not available');\n            return;\n        }\n\n        if (googleMapRef.current) {\n            console.log('[GeofenceMapEditor] Map already initialized, skipping');\n            return;\n        }\n\n        // Wait for location if creating new geofence\n        if (!geofence && (!bestLocation || bestLocation.latitude === 0 || bestLocation.longitude === 0)) {\n            console.log('[GeofenceMapEditor] Waiting for location to be available');\n            console.log('[GeofenceMapEditor] bestLocation:', bestLocation);\n            console.log('[GeofenceMapEditor] currentLocation:', currentLocation);\n            // Wait for location to be available\n            return;\n        }\n\n        console.log('[GeofenceMapEditor] Starting map initialization');\n        let isMounted = true;\n\n        googleMapsLoader.load().then((google) => {\n            console.log('[GeofenceMapEditor] Google Maps loaded');\n            if (!isMounted) {\n                console.log('[GeofenceMapEditor] Component unmounted, aborting map initialization');\n                return;\n            }\n            if (!mapRef.current) {\n                console.warn('[GeofenceMapEditor] Map ref is null after load');\n                return;\n            }\n\n            // Determine center coordinates\n            let centerCoords: { latitude: number; longitude: number };\n            \n            if (geofence) {\n                // Editing existing geofence - use its center\n                centerCoords = geofence.center;\n                console.log('[GeofenceMapEditor] Using geofence center:', centerCoords);\n            } else if (bestLocation && bestLocation.latitude !== 0 && bestLocation.longitude !== 0) {\n                // Creating new geofence - use current location\n                centerCoords = bestLocation;\n                console.log('[GeofenceMapEditor] Using bestLocation:', centerCoords);\n            } else {\n                // Fallback - shouldn't happen but just in case\n                console.warn('[GeofenceMapEditor] No location available, using default (San Francisco)');\n                centerCoords = { latitude: 37.7749, longitude: -122.4194 }; // San Francisco default\n            }\n\n            const center = new google.maps.LatLng(centerCoords.latitude, centerCoords.longitude);\n            console.log('[GeofenceMapEditor] Creating map with center:', centerCoords);\n\n            try {\n                // Create map\n                googleMapRef.current = new google.maps.Map(mapRef.current, {\n                    center,\n                    zoom: 15,\n                    mapTypeControl: true,\n                    streetViewControl: true,\n                    fullscreenControl: true,\n                    zoomControl: true,\n                    disableDefaultUI: false,\n                });\n\n                console.log('[GeofenceMapEditor] Map created successfully');\n                \n                // Update formData with location if creating new geofence\n                if (!geofence) {\n                    console.log('[GeofenceMapEditor] Updating formData with centerCoords');\n                    setFormData(prev => ({\n                        ...prev,\n                        center: centerCoords,\n                    }));\n                }\n                \n                // Set map loaded immediately - the map is ready for interaction\n                // The idle event can fire later, but we don't need to wait for it\n                setIsMapLoaded(true);\n                console.log('[GeofenceMapEditor] isMapLoaded set to true - map is ready');\n                \n                // Also listen for idle event as confirmation (but don't block on it)\n                google.maps.event.addListenerOnce(googleMapRef.current, 'idle', () => {\n                    console.log('[GeofenceMapEditor] Map is idle (fully loaded and ready)');\n                    // Just confirm - we already set isMapLoaded above\n                });\n            } catch (error) {\n                console.error('[GeofenceMapEditor] Error creating map:', error);\n            }\n        }).catch((error) => {\n            console.error('[GeofenceMapEditor] Error loading Google Maps:', error);\n        });\n\n        return () => {\n            console.log('[GeofenceMapEditor] Cleaning up map initialization effect');\n            isMounted = false;\n            // Don't clean up click listener here - it's managed by its own effect\n            // Just mark as unmounted to prevent state updates\n        };\n        // Only depend on isOpen, geofence, and bestLocation\n        // Don't include isPlacementMode - it shouldn't trigger map re-initialization\n    }, [isOpen, geofence, bestLocation]);\n\n    // Handle form submission\n    const handleSubmit = (e: React.FormEvent) => {\n        e.preventDefault();\n        console.log('[GeofenceMapEditor] Form submitted', {\n            name: formData.name,\n            center: formData.center,\n            radius: formData.radius,\n            hasPlacedCenter,\n            hasGeofence: !!geofence,\n        });\n\n        if (!formData.name.trim()) {\n            console.warn('[GeofenceMapEditor] Form validation failed - name is empty');\n            return;\n        }\n\n        if (!hasPlacedCenter && !geofence) {\n            console.warn('[GeofenceMapEditor] Form validation failed - center not placed');\n            return;\n        }\n\n        if (formData.center.latitude === 0 && formData.center.longitude === 0) {\n            console.warn('[GeofenceMapEditor] Form validation failed - center is at origin');\n            return;\n        }\n\n        console.log('[GeofenceMapEditor] Calling onSave with data:', formData);\n        onSave({\n            ...formData,\n            alertRecipients: formData.alertRecipients.length > 0 \n                ? formData.alertRecipients \n                : [], // Empty array means all hub members\n        });\n    };\n\n    // Geofence types\n    const geofenceTypes = [\n        { value: 'home', label: 'Home', icon: <FiHome size={20} /> },\n        { value: 'school', label: 'School', icon: <FiBookOpen size={20} /> },\n        { value: 'work', label: 'Work', icon: <FiBriefcase size={20} /> },\n        { value: 'custom', label: 'Custom', icon: <FiMapPin size={20} /> },\n    ] as const;\n\n    console.log('[GeofenceMapEditor] Render check', {\n        isOpen,\n        hasGeofence: !!geofence,\n        isMapLoaded,\n        hasPlacedCenter,\n        isPlacementMode,\n        formDataCenter: formData.center,\n    });\n\n    if (!isOpen) {\n        console.log('[GeofenceMapEditor] Modal is not open, returning null');\n        return null;\n    }\n\n    return (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n            <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden\">\n                {/* Header */}\n                <div className=\"flex items-center justify-between p-6 border-b border-gray-200\">\n                    <div className=\"flex items-center gap-3\">\n                        <FiMapPin size={24} className=\"text-purple-600\" />\n                        <h2 className=\"text-2xl font-bold text-gray-900\">\n                            {geofence ? 'Edit Geofence' : 'Create Geofence'}\n                        </h2>\n                    </div>\n                    <button\n                        onClick={onClose}\n                        className=\"p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors\"\n                    >\n                        <FiX size={20} />\n                    </button>\n                </div>\n\n                <div className=\"flex h-[600px]\">\n                    {/* Map */}\n                    <div className=\"flex-1 relative\">\n                        <div\n                            ref={mapRef}\n                            className=\"w-full h-full\"\n                            style={{ minHeight: '400px' }}\n                        />\n                        {(!isMapLoaded || (!geofence && (!bestLocation || bestLocation.latitude === 0))) && (\n                            <div className=\"absolute inset-0 flex items-center justify-center bg-gray-100\">\n                                <div className=\"text-center\">\n                                    <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-2\"></div>\n                                    <p className=\"text-gray-600\">\n                                        {!geofence && (!bestLocation || bestLocation.latitude === 0) \n                                            ? 'Waiting for your location...' \n                                            : 'Loading map...'}\n                                    </p>\n                                </div>\n                            </div>\n                        )}\n                        \n                        {/* Instructions overlay */}\n                        <div className=\"absolute top-4 left-4 bg-white bg-opacity-95 backdrop-blur-sm rounded-lg p-3 shadow-lg z-10\">\n                            {isPlacementMode ? (\n                                <>\n                                    <p className=\"text-sm font-medium text-purple-600 mb-1\">\n                                        📍 Placement Mode Active\n                                    </p>\n                                    <p className=\"text-xs text-gray-700\">\n                                        Click anywhere on the map to place the geofence center\n                                    </p>\n                                </>\n                            ) : hasPlacedCenter || geofence ? (\n                                <>\n                                    <p className=\"text-sm text-gray-700 font-medium\">\n                                        {geofence ? 'Editing geofence' : 'Geofence placed'}\n                                    </p>\n                                    <p className=\"text-xs text-gray-600 mt-1\">\n                                        • Drag center marker to move\n                                    </p>\n                                    <p className=\"text-xs text-gray-600\">\n                                        • Drag white dots to resize radius\n                                    </p>\n                                    {!geofence && (\n                                        <p className=\"text-xs text-gray-600\">\n                                            • Click \"Place Geofence\" to reposition\n                                        </p>\n                                    )}\n                                </>\n                            ) : (\n                                <>\n                                    <p className=\"text-sm text-gray-700 font-medium\">\n                                        Ready to create geofence\n                                    </p>\n                                    <p className=\"text-xs text-gray-600 mt-1\">\n                                        Click \"Place Geofence\" button to start\n                                    </p>\n                                </>\n                            )}\n                        </div>\n\n                        {/* Place Geofence Button */}\n                        {!geofence && (\n                            <div className=\"absolute top-4 right-4 flex flex-col gap-2 z-10\">\n                                {!hasPlacedCenter && !isPlacementMode && (\n                                    <button\n                                        type=\"button\"\n                                        onClick={() => {\n                                            console.log('[GeofenceMapEditor] Place Geofence button clicked');\n                                            console.log('[GeofenceMapEditor] Current state:', {\n                                                hasPlacedCenter,\n                                                isPlacementMode,\n                                                hasGoogleMap: !!googleMapRef.current,\n                                                formDataCenter: formData.center,\n                                            });\n                                            // CRITICAL: Set refs immediately BEFORE state update\n                                            // This prevents form data effect from resetting placement mode\n                                            userActivatedPlacementModeRef.current = true;\n                                            isPlacementModeRef.current = true;\n                                            console.log('[GeofenceMapEditor] Refs set to true immediately');\n                                            // Then update state\n                                            setIsPlacementMode(true);\n                                            console.log('[GeofenceMapEditor] isPlacementMode state set to true');\n                                            if (googleMapRef.current) {\n                                                console.log('[GeofenceMapEditor] Updating map options - disabling dragging');\n                                                googleMapRef.current.setOptions({\n                                                    draggable: false,\n                                                    draggableCursor: 'crosshair',\n                                                });\n                                                console.log('[GeofenceMapEditor] Map options updated');\n                                            } else {\n                                                console.warn('[GeofenceMapEditor] Google map ref is null, cannot update options');\n                                            }\n                                        }}\n                                        className=\"bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 transition-colors font-medium\"\n                                    >\n                                        <FiTarget size={16} />\n                                        <span className=\"text-sm\">Place Geofence</span>\n                                    </button>\n                                )}\n                                \n                                {isPlacementMode && (\n                                    <button\n                                        type=\"button\"\n                                        onClick={() => {\n                                            console.log('[GeofenceMapEditor] Cancel button clicked');\n                                            // Clear refs immediately\n                                            userActivatedPlacementModeRef.current = false;\n                                            isPlacementModeRef.current = false;\n                                            // Then update state\n                                            setIsPlacementMode(false);\n                                            console.log('[GeofenceMapEditor] Placement mode cancelled - refs and state updated');\n                                            if (googleMapRef.current) {\n                                                console.log('[GeofenceMapEditor] Re-enabling map dragging');\n                                                googleMapRef.current.setOptions({\n                                                    draggable: true,\n                                                    draggableCursor: 'default',\n                                                });\n                                                console.log('[GeofenceMapEditor] Map options updated');\n                                            }\n                                        }}\n                                        className=\"bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 transition-colors font-medium\"\n                                    >\n                                        <FiX size={16} />\n                                        <span className=\"text-sm\">Cancel</span>\n                                    </button>\n                                )}\n\n                                {/* Reposition button - show when center is placed */}\n                                {hasPlacedCenter && !isPlacementMode && (\n                                    <button\n                                        type=\"button\"\n                                        onClick={() => {\n                                            setIsPlacementMode(true);\n                                            if (googleMapRef.current) {\n                                                googleMapRef.current.setOptions({\n                                                    draggable: false,\n                                                    draggableCursor: 'crosshair',\n                                                });\n                                            }\n                                        }}\n                                        className=\"bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 transition-colors font-medium\"\n                                    >\n                                        <FiTarget size={16} />\n                                        <span className=\"text-sm\">Reposition</span>\n                                    </button>\n                                )}\n\n                                {/* Use My Location Button - only show when not in placement mode */}\n                                {!isPlacementMode && bestLocation && bestLocation.latitude !== 0 && (\n                                    <button\n                                        type=\"button\"\n                                        onClick={() => {\n                                            if (bestLocation && googleMapRef.current) {\n                                                const center = new google.maps.LatLng(\n                                                    bestLocation.latitude,\n                                                    bestLocation.longitude\n                                                );\n                                                googleMapRef.current.setCenter(center);\n                                                googleMapRef.current.setZoom(15);\n                                                \n                                                // Update center\n                                                setFormData(prev => ({\n                                                    ...prev,\n                                                    center: bestLocation,\n                                                }));\n                                                \n                                                // If center marker exists, update it\n                                                if (centerMarkerRef.current) {\n                                                    centerMarkerRef.current.setPosition(center);\n                                                }\n                                            }\n                                        }}\n                                        className=\"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 transition-colors font-medium\"\n                                    >\n                                        <FiNavigation size={16} />\n                                        <span className=\"text-sm\">My Location</span>\n                                    </button>\n                                )}\n                            </div>\n                        )}\n                    </div>\n\n                    {/* Form */}\n                    <div className=\"w-80 border-l border-gray-200 p-6 overflow-y-auto\">\n                        <form onSubmit={handleSubmit} className=\"space-y-6\">\n                            {/* Basic Info */}\n                            <div>\n                                <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">Geofence Details</h3>\n                                \n                                <div className=\"space-y-4\">\n                                    <div>\n                                        <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                                            Name *\n                                        </label>\n                                        <input\n                                            type=\"text\"\n                                            value={formData.name}\n                                            onChange={(e) => setFormData(prev => ({ ...prev, name: e.target.value }))}\n                                            className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent\"\n                                            placeholder=\"e.g., Home, School, Work\"\n                                            required\n                                        />\n                                    </div>\n\n                                    <div>\n                                        <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                                            Description\n                                        </label>\n                                        <textarea\n                                            value={formData.description}\n                                            onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}\n                                            className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent\"\n                                            placeholder=\"Optional description...\"\n                                            rows={3}\n                                        />\n                                    </div>\n\n                                    <div>\n                                        <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                                            Type\n                                        </label>\n                                        <div className=\"grid grid-cols-2 gap-2\">\n                                            {geofenceTypes.map((type) => (\n                                                <label\n                                                    key={type.value}\n                                                    className={`flex items-center gap-2 p-2 border-2 rounded-lg cursor-pointer transition-colors ${\n                                                        formData.type === type.value\n                                                            ? 'border-purple-500 bg-purple-50'\n                                                            : 'border-gray-200 hover:border-gray-300'\n                                                    }`}\n                                                >\n                                                    <input\n                                                        type=\"radio\"\n                                                        name=\"type\"\n                                                        value={type.value}\n                                                        checked={formData.type === type.value}\n                                                        onChange={(e) => setFormData(prev => ({ \n                                                            ...prev, \n                                                            type: e.target.value as GeofenceType \n                                                        }))}\n                                                        className=\"sr-only\"\n                                                    />\n                                                    {type.icon}\n                                                    <span className=\"text-sm font-medium\">{type.label}</span>\n                                                </label>\n                                            ))}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n\n                            {/* Location Info */}\n                            <div>\n                                <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">Location</h3>\n                                <div className=\"space-y-4\">\n                                    <div className=\"space-y-2 text-sm\">\n                                        <div className=\"flex justify-between\">\n                                            <span className=\"text-gray-600\">Latitude:</span>\n                                            <span className=\"font-mono text-xs\">{formData.center.latitude.toFixed(6)}</span>\n                                        </div>\n                                        <div className=\"flex justify-between\">\n                                            <span className=\"text-gray-600\">Longitude:</span>\n                                            <span className=\"font-mono text-xs\">{formData.center.longitude.toFixed(6)}</span>\n                                        </div>\n                                    </div>\n                                    \n                                    {/* Radius Slider */}\n                                    <div>\n                                        <div className=\"flex items-center justify-between mb-2\">\n                                            <label className=\"text-sm font-medium text-gray-700\">\n                                                Radius\n                                            </label>\n                                            <span className=\"text-sm font-bold text-purple-600\">\n                                                {formData.radius < 1000 \n                                                    ? `${Math.round(formData.radius)}m` \n                                                    : `${(formData.radius / 1000).toFixed(1)}km`}\n                                            </span>\n                                        </div>\n                                        <input\n                                            type=\"range\"\n                                            min=\"10\"\n                                            max=\"5000\"\n                                            step=\"10\"\n                                            value={formData.radius}\n                                            onChange={(e) => {\n                                                const newRadius = parseInt(e.target.value, 10);\n                                                setFormData(prev => ({ ...prev, radius: newRadius }));\n                                            }}\n                                            className=\"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider\"\n                                            style={{\n                                                background: `linear-gradient(to right, #9333ea 0%, #9333ea ${(formData.radius / 5000) * 100}%, #e5e7eb ${(formData.radius / 5000) * 100}%, #e5e7eb 100%)`\n                                            }}\n                                        />\n                                        <div className=\"flex justify-between text-xs text-gray-500 mt-1\">\n                                            <span>10m</span>\n                                            <span>5km</span>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n\n                            {/* Alert Settings */}\n                            <div>\n                                <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">Alert Settings</h3>\n                                <div className=\"space-y-3\">\n                                    <label className=\"flex items-center gap-3\">\n                                        <input\n                                            type=\"checkbox\"\n                                            checked={formData.alertOnEntry}\n                                            onChange={(e) => setFormData(prev => ({ ...prev, alertOnEntry: e.target.checked }))}\n                                            className=\"w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500\"\n                                        />\n                                        <span className=\"text-sm font-medium text-gray-700\">\n                                            Alert when entering this area\n                                        </span>\n                                    </label>\n                                    \n                                    <label className=\"flex items-center gap-3\">\n                                        <input\n                                            type=\"checkbox\"\n                                            checked={formData.alertOnExit}\n                                            onChange={(e) => setFormData(prev => ({ ...prev, alertOnExit: e.target.checked }))}\n                                            className=\"w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500\"\n                                        />\n                                        <span className=\"text-sm font-medium text-gray-700\">\n                                            Alert when leaving this area\n                                        </span>\n                                    </label>\n                                </div>\n                                <p className=\"text-xs text-gray-500 mt-2\">\n                                    Alerts will be sent to all hub members\n                                </p>\n                            </div>\n\n                            {/* Actions */}\n                            <div className=\"flex gap-3 pt-6 border-t border-gray-200\">\n                                <button\n                                    type=\"button\"\n                                    onClick={onClose}\n                                    className=\"flex-1 px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors\"\n                                >\n                                    Cancel\n                                </button>\n                                <button\n                                    type=\"submit\"\n                                    className=\"flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors\"\n                                >\n                                    {geofence ? 'Update' : 'Create'}\n                                </button>\n                            </div>\n                        </form>\n                    </div>\n                </div>\n            </div>\n        </div>\n    );\n};\n","/**\n * GeofenceDetailsModal Component\n * \n * Modal for viewing geofence details\n * - Shows geofence information\n * - Edit and delete actions\n */\n\nimport { FiX, FiEdit2, FiTrash2, FiHome, FiBriefcase, FiBookOpen, FiMapPin, FiAlertCircle } from 'react-icons/fi';\nimport type { GeofenceZone, GeofenceType } from '../types';\n\ninterface GeofenceDetailsModalProps {\n    geofence: GeofenceZone | null;\n    isOpen: boolean;\n    onClose: () => void;\n    onEdit: (geofence: GeofenceZone) => void;\n    onDelete: (geofenceId: string) => void;\n}\n\nexport const GeofenceDetailsModal = ({\n    geofence,\n    isOpen,\n    onClose,\n    onEdit,\n    onDelete,\n}: GeofenceDetailsModalProps) => {\n    if (!isOpen || !geofence) return null;\n\n    const getGeofenceIcon = (type: GeofenceType) => {\n        switch (type) {\n            case 'home':\n                return <FiHome className=\"text-blue-500\" size={24} />;\n            case 'school':\n                return <FiBookOpen className=\"text-green-500\" size={24} />;\n            case 'work':\n                return <FiBriefcase className=\"text-purple-500\" size={24} />;\n            default:\n                return <FiMapPin className=\"text-gray-500\" size={24} />;\n        }\n    };\n\n    const formatRadius = (radius: number) => {\n        if (radius < 1000) {\n            return `${Math.round(radius)}m`;\n        }\n        return `${(radius / 1000).toFixed(1)}km`;\n    };\n\n    const formatDate = (date: Date) => {\n        return new Intl.DateTimeFormat('en-US', {\n            year: 'numeric',\n            month: 'short',\n            day: 'numeric',\n            hour: '2-digit',\n            minute: '2-digit',\n        }).format(date);\n    };\n\n    return (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n            <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto\">\n                {/* Header */}\n                <div className=\"flex items-center justify-between p-6 border-b border-gray-200\">\n                    <div className=\"flex items-center gap-3\">\n                        {getGeofenceIcon(geofence.type)}\n                        <h2 className=\"text-2xl font-bold text-gray-900\">{geofence.name}</h2>\n                    </div>\n                    <button\n                        onClick={onClose}\n                        className=\"p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors\"\n                        aria-label=\"Close\"\n                    >\n                        <FiX size={20} />\n                    </button>\n                </div>\n\n                {/* Content */}\n                <div className=\"p-6 space-y-6\">\n                    {/* Description */}\n                    {geofence.description && (\n                        <div>\n                            <h3 className=\"text-sm font-semibold text-gray-700 mb-2\">Description</h3>\n                            <p className=\"text-gray-600\">{geofence.description}</p>\n                        </div>\n                    )}\n\n                    {/* Location Info */}\n                    <div>\n                        <h3 className=\"text-sm font-semibold text-gray-700 mb-3\">Location</h3>\n                        <div className=\"space-y-2 text-sm\">\n                            <div className=\"flex justify-between\">\n                                <span className=\"text-gray-600\">Latitude:</span>\n                                <span className=\"font-mono text-gray-900\">{geofence.center.latitude.toFixed(6)}</span>\n                            </div>\n                            <div className=\"flex justify-between\">\n                                <span className=\"text-gray-600\">Longitude:</span>\n                                <span className=\"font-mono text-gray-900\">{geofence.center.longitude.toFixed(6)}</span>\n                            </div>\n                            <div className=\"flex justify-between\">\n                                <span className=\"text-gray-600\">Radius:</span>\n                                <span className=\"font-medium text-gray-900\">{formatRadius(geofence.radius)}</span>\n                            </div>\n                        </div>\n                    </div>\n\n                    {/* Alert Settings */}\n                    <div>\n                        <h3 className=\"text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2\">\n                            <FiAlertCircle size={16} />\n                            Alert Settings\n                        </h3>\n                        <div className=\"space-y-2\">\n                            <div className=\"flex items-center justify-between p-3 bg-gray-50 rounded-lg\">\n                                <span className=\"text-sm text-gray-700\">Entry Alerts</span>\n                                <span className={`px-3 py-1 rounded-full text-xs font-medium ${\n                                    geofence.alertOnEntry\n                                        ? 'bg-green-100 text-green-700'\n                                        : 'bg-gray-100 text-gray-600'\n                                }`}>\n                                    {geofence.alertOnEntry ? 'Enabled' : 'Disabled'}\n                                </span>\n                            </div>\n                            <div className=\"flex items-center justify-between p-3 bg-gray-50 rounded-lg\">\n                                <span className=\"text-sm text-gray-700\">Exit Alerts</span>\n                                <span className={`px-3 py-1 rounded-full text-xs font-medium ${\n                                    geofence.alertOnExit\n                                        ? 'bg-green-100 text-green-700'\n                                        : 'bg-gray-100 text-gray-600'\n                                }`}>\n                                    {geofence.alertOnExit ? 'Enabled' : 'Disabled'}\n                                </span>\n                            </div>\n                        </div>\n                    </div>\n\n                    {/* Metadata */}\n                    <div className=\"pt-4 border-t border-gray-200\">\n                        <div className=\"space-y-2 text-xs text-gray-500\">\n                            <div className=\"flex justify-between\">\n                                <span>Created:</span>\n                                <span>{formatDate(geofence.createdAt)}</span>\n                            </div>\n                            <div className=\"flex justify-between\">\n                                <span>Updated:</span>\n                                <span>{formatDate(geofence.updatedAt)}</span>\n                            </div>\n                            <div className=\"flex justify-between\">\n                                <span>Status:</span>\n                                <span className={`font-medium ${\n                                    geofence.isActive ? 'text-green-600' : 'text-gray-500'\n                                }`}>\n                                    {geofence.isActive ? 'Active' : 'Inactive'}\n                                </span>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                {/* Actions */}\n                <div className=\"flex gap-3 p-6 border-t border-gray-200\">\n                    <button\n                        onClick={() => {\n                            onEdit(geofence);\n                            onClose();\n                        }}\n                        className=\"flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium\"\n                    >\n                        <FiEdit2 size={18} />\n                        Edit\n                    </button>\n                    <button\n                        onClick={() => {\n                            if (window.confirm(`Are you sure you want to delete \"${geofence.name}\"?`)) {\n                                onDelete(geofence.id);\n                                onClose();\n                            }\n                        }}\n                        className=\"flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors font-medium\"\n                    >\n                        <FiTrash2 size={18} />\n                        Delete\n                    </button>\n                </div>\n            </div>\n        </div>\n    );\n};\n\n","/**\n * GeofenceAlertToast Component\n * \n * Displays geofence alert notifications as toast messages\n */\n\nimport { useEffect, useState } from 'react';\nimport { FiMapPin, FiX, FiBell } from 'react-icons/fi';\nimport { alertService, type GeofenceAlert } from '../services/alert-service';\n\nexport const GeofenceAlertToast = () => {\n    const [alerts, setAlerts] = useState<GeofenceAlert[]>([]);\n    const [visibleAlerts, setVisibleAlerts] = useState<Set<string>>(new Set());\n\n    // Listen for new geofence alerts\n    useEffect(() => {\n        const handleGeofenceAlert = (event: CustomEvent<GeofenceAlert>) => {\n            const alert = event.detail;\n            setAlerts(prev => [alert, ...prev]);\n            setVisibleAlerts(prev => new Set([...prev, alert.id]));\n            \n            // Auto-hide after 5 seconds\n            setTimeout(() => {\n                setVisibleAlerts(prev => {\n                    const newSet = new Set(prev);\n                    newSet.delete(alert.id);\n                    return newSet;\n                });\n            }, 5000);\n        };\n\n        window.addEventListener('geofenceAlert', handleGeofenceAlert as EventListener);\n        \n        return () => {\n            window.removeEventListener('geofenceAlert', handleGeofenceAlert as EventListener);\n        };\n    }, []);\n\n    // Load existing alerts on mount\n    useEffect(() => {\n        const existingAlerts = alertService.getAlerts();\n        setAlerts(existingAlerts);\n    }, []);\n\n    const handleDismiss = (alertId: string) => {\n        setVisibleAlerts(prev => {\n            const newSet = new Set(prev);\n            newSet.delete(alertId);\n            return newSet;\n        });\n        alertService.markAsRead(alertId);\n    };\n\n    const getAlertIcon = (type: 'entry' | 'exit') => {\n        return type === 'entry' ? (\n            <FiMapPin className=\"text-green-600\" size={20} />\n        ) : (\n            <FiMapPin className=\"text-red-600\" size={20} />\n        );\n    };\n\n    const getAlertColor = (type: 'entry' | 'exit') => {\n        return type === 'entry' \n            ? 'bg-green-50 border-green-200 text-green-800'\n            : 'bg-red-50 border-red-200 text-red-800';\n    };\n\n    if (alerts.length === 0) return null;\n\n    return (\n        <div className=\"fixed top-4 right-4 z-50 space-y-2 max-w-sm\">\n            {alerts\n                .filter(alert => visibleAlerts.has(alert.id))\n                .map((alert) => (\n                    <div\n                        key={alert.id}\n                        className={`${getAlertColor(alert.type)} border rounded-lg p-4 shadow-lg animate-slide-in-right`}\n                    >\n                        <div className=\"flex items-start gap-3\">\n                            <div className=\"flex-shrink-0 mt-0.5\">\n                                {getAlertIcon(alert.type)}\n                            </div>\n                            \n                            <div className=\"flex-1 min-w-0\">\n                                <div className=\"flex items-center gap-2 mb-1\">\n                                    <FiBell size={14} className=\"text-gray-500\" />\n                                    <span className=\"text-sm font-medium\">\n                                        Geofence Alert\n                                    </span>\n                                </div>\n                                \n                                <p className=\"text-sm font-semibold mb-1\">\n                                    {alert.message}\n                                </p>\n                                \n                                <p className=\"text-xs text-gray-600\">\n                                    {alert.geofenceName} • {alert.timestamp.toLocaleTimeString()}\n                                </p>\n                            </div>\n                            \n                            <button\n                                onClick={() => handleDismiss(alert.id)}\n                                className=\"flex-shrink-0 p-1 text-gray-400 hover:text-gray-600 transition-colors\"\n                                aria-label=\"Dismiss alert\"\n                            >\n                                <FiX size={16} />\n                            </button>\n                        </div>\n                    </div>\n                ))}\n        </div>\n    );\n};\n","/**\n * NavigationPanel Component\n * \n * Slide-out navigation panel for map page\n * - Easy access to all features\n * - Mobile and desktop friendly\n */\n\nimport { NavLink } from 'react-router-dom';\nimport { useHubStore } from '@/lib/store/hub-store';\nimport { useAuth } from '@/features/auth/hooks/useAuth';\nimport {\n    FiX,\n    FiMapPin,\n    FiCheckSquare,\n    FiMessageCircle,\n    FiUsers,\n    FiSettings,\n    FiLock,\n    FiHome,\n    FiLogOut,\n} from 'react-icons/fi';\nimport { signOut } from 'firebase/auth';\nimport { auth } from '@/config/firebase';\nimport { useNavigate } from 'react-router-dom';\n\ninterface NavigationPanelProps {\n    isOpen: boolean;\n    onClose: () => void;\n}\n\nexport const NavigationPanel = ({ isOpen, onClose }: NavigationPanelProps) => {\n    const { currentHub, isFeatureEnabled } = useHubStore();\n    const { user } = useAuth();\n    const navigate = useNavigate();\n\n    const handleLogout = async () => {\n        try {\n            await signOut(auth);\n            navigate('/');\n        } catch (error) {\n            console.error('Logout error:', error);\n        }\n    };\n\n    const navItems = [\n        {\n            to: '/',\n            icon: <FiMapPin size={20} />,\n            label: 'Map',\n            feature: 'location' as const,\n        },\n        {\n            to: '/tasks',\n            icon: <FiCheckSquare size={20} />,\n            label: 'Tasks',\n            feature: 'tasks' as const,\n        },\n        {\n            to: '/messages',\n            icon: <FiMessageCircle size={20} />,\n            label: 'Messages',\n            feature: 'chat' as const,\n        },\n        {\n            to: '/vault',\n            icon: <FiLock size={20} />,\n            label: 'Vault',\n            feature: 'vault' as const,\n        },\n        {\n            to: '/dashboard',\n            icon: <FiHome size={20} />,\n            label: 'Dashboard',\n        },\n        {\n            to: '/settings',\n            icon: <FiSettings size={20} />,\n            label: 'Settings',\n        },\n    ].filter((item) => {\n        if (!item.feature) return true;\n        return isFeatureEnabled(item.feature);\n    });\n\n    return (\n        <>\n            {/* Backdrop */}\n            {isOpen && (\n                <div\n                    className=\"fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden\"\n                    onClick={onClose}\n                />\n            )}\n\n            {/* Panel */}\n            <div\n                className={`fixed top-0 left-0 h-full w-80 bg-white shadow-2xl z-50 transform transition-transform duration-300 ease-in-out ${\n                    isOpen ? 'translate-x-0' : '-translate-x-full'\n                }`}\n            >\n                <div className=\"flex flex-col h-full\">\n                    {/* Header */}\n                    <div className=\"flex items-center justify-between p-6 border-b border-gray-200\">\n                        <div>\n                            <h2 className=\"text-xl font-bold text-gray-900\">Menu</h2>\n                            {currentHub && (\n                                <p className=\"text-sm text-gray-500 mt-1\">{currentHub.name}</p>\n                            )}\n                        </div>\n                        <button\n                            onClick={onClose}\n                            className=\"p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors\"\n                            aria-label=\"Close menu\"\n                        >\n                            <FiX size={20} />\n                        </button>\n                    </div>\n\n                    {/* User Info */}\n                    {user && (\n                        <div className=\"p-4 border-b border-gray-200 bg-gray-50\">\n                            <div className=\"flex items-center gap-3\">\n                                <div className=\"w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center text-white font-semibold\">\n                                    {user.email?.charAt(0).toUpperCase() || 'U'}\n                                </div>\n                                <div className=\"flex-1 min-w-0\">\n                                    <p className=\"text-sm font-semibold text-gray-900 truncate\">\n                                        {user.email?.split('@')[0] || 'User'}\n                                    </p>\n                                    <p className=\"text-xs text-gray-500 truncate\">{user.email}</p>\n                                </div>\n                            </div>\n                        </div>\n                    )}\n\n                    {/* Navigation Items */}\n                    <nav className=\"flex-1 overflow-y-auto py-4\">\n                        <div className=\"space-y-1 px-2\">\n                            {navItems.map((item) => (\n                                <NavLink\n                                    key={item.to}\n                                    to={item.to}\n                                    onClick={onClose}\n                                    className={({ isActive }) =>\n                                        `flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${\n                                            isActive\n                                                ? 'bg-purple-100 text-purple-700 font-semibold'\n                                                : 'text-gray-700 hover:bg-gray-100'\n                                        }`\n                                    }\n                                >\n                                    {item.icon}\n                                    <span>{item.label}</span>\n                                </NavLink>\n                            ))}\n                        </div>\n\n                        {/* Divider */}\n                        <div className=\"my-4 border-t border-gray-200\" />\n\n                        {/* Hub Info */}\n                        {currentHub && (\n                            <div className=\"px-4 py-3\">\n                                <div className=\"flex items-center gap-2 text-sm text-gray-600 mb-2\">\n                                    <FiUsers size={16} />\n                                    <span className=\"font-medium\">Hub Members</span>\n                                </div>\n                                <p className=\"text-xs text-gray-500 pl-6\">\n                                    {currentHub.members?.length || 0} members\n                                </p>\n                            </div>\n                        )}\n                    </nav>\n\n                    {/* Footer */}\n                    <div className=\"border-t border-gray-200 p-4\">\n                        <button\n                            onClick={handleLogout}\n                            className=\"w-full flex items-center gap-3 px-4 py-3 text-red-600 hover:bg-red-50 rounded-lg transition-colors\"\n                        >\n                            <FiLogOut size={20} />\n                            <span className=\"font-medium\">Sign Out</span>\n                        </button>\n                    </div>\n                </div>\n            </div>\n        </>\n    );\n};\n","/**\n * Device Monitor Service\n * \n * Monitors device status:\n * - Battery level and charging state\n * - Online/offline status\n * - Last seen timestamp\n * - Platform information\n */\n\nexport interface DeviceStatus {\n    batteryLevel: number | null;\n    isCharging: boolean | null;\n    isOnline: boolean;\n    lastSeen: Date;\n    platform: string;\n    connectionType?: 'wifi' | 'cellular' | 'ethernet' | 'unknown';\n}\n\ntype DeviceStatusCallback = (status: DeviceStatus) => void;\n\nclass DeviceMonitorService {\n    private statusCallbacks: Set<DeviceStatusCallback> = new Set();\n    private currentStatus: DeviceStatus | null = null;\n    private batteryMonitor: any = null; // BatteryManager API\n    private onlineListener: (() => void) | null = null;\n    private updateInterval: number | null = null;\n    private lastUpdateTime: number = Date.now();\n\n    constructor() {\n        this.initializeBatteryMonitoring();\n        this.initializeOnlineMonitoring();\n        this.startPeriodicUpdates();\n    }\n\n    /**\n     * Initialize battery monitoring using Battery Manager API\n     * Falls back gracefully if not supported\n     */\n    private async initializeBatteryMonitoring() {\n        try {\n            // Check if Battery Manager API is available\n            if ('getBattery' in navigator && (navigator as any).getBattery) {\n                const battery = await (navigator as any).getBattery();\n                this.batteryMonitor = battery;\n\n                // Listen for battery changes\n                battery.addEventListener('chargingchange', () => {\n                    this.updateStatus();\n                });\n\n                battery.addEventListener('levelchange', () => {\n                    this.updateStatus();\n                });\n\n                // Initial update\n                this.updateStatus();\n            } else {\n                console.log('🔋 Battery Manager API not supported, battery monitoring disabled');\n            }\n        } catch (error) {\n            console.warn('Failed to initialize battery monitoring:', error);\n        }\n    }\n\n    /**\n     * Initialize online/offline status monitoring\n     */\n    private initializeOnlineMonitoring() {\n        this.onlineListener = () => {\n            this.updateStatus();\n        };\n\n        window.addEventListener('online', this.onlineListener);\n        window.addEventListener('offline', this.onlineListener);\n\n        // Initial update\n        this.updateStatus();\n    }\n\n    /**\n     * Start periodic status updates (every 30 seconds)\n     */\n    private startPeriodicUpdates() {\n        this.updateInterval = window.setInterval(() => {\n            this.updateStatus();\n        }, 30000); // Update every 30 seconds\n    }\n\n    /**\n     * Get current device status\n     */\n    private async updateStatus() {\n        const now = Date.now();\n        \n        // Throttle updates to prevent excessive calls\n        if (now - this.lastUpdateTime < 5000) {\n            return;\n        }\n        this.lastUpdateTime = now;\n\n        const status: DeviceStatus = {\n            batteryLevel: null,\n            isCharging: null,\n            isOnline: navigator.onLine,\n            lastSeen: new Date(),\n            platform: this.getPlatform(),\n            connectionType: await this.getConnectionType(),\n        };\n\n        // Get battery status if available\n        if (this.batteryMonitor) {\n            try {\n                status.batteryLevel = Math.round(this.batteryMonitor.level * 100);\n                status.isCharging = this.batteryMonitor.charging;\n            } catch (error) {\n                console.warn('Failed to read battery status:', error);\n            }\n        }\n\n        this.currentStatus = status;\n        this.notifyCallbacks(status);\n    }\n\n    /**\n     * Get platform information\n     */\n    private getPlatform(): string {\n        const ua = navigator.userAgent;\n        \n        if (/iPad|iPhone|iPod/.test(ua)) {\n            return 'iOS';\n        }\n        if (/Android/.test(ua)) {\n            return 'Android';\n        }\n        if (/Mac/.test(ua)) {\n            return 'macOS';\n        }\n        if (/Win/.test(ua)) {\n            return 'Windows';\n        }\n        if (/Linux/.test(ua)) {\n            return 'Linux';\n        }\n        \n        return 'Unknown';\n    }\n\n    /**\n     * Get connection type (if available)\n     */\n    private async getConnectionType(): Promise<'wifi' | 'cellular' | 'ethernet' | 'unknown'> {\n        try {\n            // Check if Network Information API is available\n            const connection = (navigator as any).connection || \n                             (navigator as any).mozConnection || \n                             (navigator as any).webkitConnection;\n\n            if (connection) {\n                const type = connection.effectiveType || connection.type;\n                \n                if (type.includes('wifi') || type === 'wifi') {\n                    return 'wifi';\n                }\n                if (type.includes('cellular') || type.includes('4g') || type.includes('3g') || type.includes('2g')) {\n                    return 'cellular';\n                }\n                if (type.includes('ethernet')) {\n                    return 'ethernet';\n                }\n            }\n        } catch (error) {\n            console.warn('Failed to get connection type:', error);\n        }\n\n        return 'unknown';\n    }\n\n    /**\n     * Subscribe to device status updates\n     */\n    subscribe(callback: DeviceStatusCallback): () => void {\n        this.statusCallbacks.add(callback);\n\n        // Immediately call with current status if available\n        if (this.currentStatus) {\n            callback(this.currentStatus);\n        } else {\n            // Otherwise trigger an update\n            this.updateStatus();\n        }\n\n        // Return unsubscribe function\n        return () => {\n            this.statusCallbacks.delete(callback);\n        };\n    }\n\n    /**\n     * Notify all subscribers of status changes\n     */\n    private notifyCallbacks(status: DeviceStatus) {\n        this.statusCallbacks.forEach(callback => {\n            try {\n                callback(status);\n            } catch (error) {\n                console.error('Error in device status callback:', error);\n            }\n        });\n    }\n\n    /**\n     * Get current device status synchronously\n     */\n    getCurrentStatus(): DeviceStatus | null {\n        return this.currentStatus;\n    }\n\n    /**\n     * Check if battery monitoring is supported\n     */\n    isBatteryMonitoringSupported(): boolean {\n        return this.batteryMonitor !== null;\n    }\n\n    /**\n     * Cleanup resources\n     */\n    destroy() {\n        if (this.onlineListener) {\n            window.removeEventListener('online', this.onlineListener);\n            window.removeEventListener('offline', this.onlineListener);\n        }\n\n        if (this.updateInterval !== null) {\n            clearInterval(this.updateInterval);\n        }\n\n        this.statusCallbacks.clear();\n    }\n}\n\n// Export singleton instance\nexport const deviceMonitor = new DeviceMonitorService();\n","/**\n * useDeviceStatus Hook\n * \n * React hook for monitoring and updating device status\n */\n\nimport { useEffect, useState, useCallback, useRef } from 'react';\nimport { useMutation } from '@tanstack/react-query';\nimport { deviceMonitor, type DeviceStatus } from '../services/device-monitor';\nimport { updateDeviceStatus } from '../api/device-status-api';\nimport { useAuth } from '@/features/auth/hooks/useAuth';\nimport { useHubStore } from '@/lib/store/hub-store';\n\nexport const useDeviceStatus = () => {\n    const { user } = useAuth();\n    const { currentHub } = useHubStore();\n    const [deviceStatus, setDeviceStatus] = useState<DeviceStatus | null>(null);\n    const [isMonitoring, setIsMonitoring] = useState(false);\n    const lastUpdateTimeRef = useRef<number>(0);\n    const userIdRef = useRef<string | null>(null);\n    const hubIdRef = useRef<string | null>(null);\n\n    // Update refs when user/hub changes\n    useEffect(() => {\n        userIdRef.current = user?.id || null;\n        hubIdRef.current = currentHub?.id || null;\n    }, [user?.id, currentHub?.id]);\n\n    // Mutation for updating device status in Firestore\n    const updateMutation = useMutation({\n        mutationFn: (status: DeviceStatus) => {\n            const userId = userIdRef.current;\n            const hubId = hubIdRef.current;\n            \n            if (!userId || !hubId) {\n                throw new Error('User or hub not available');\n            }\n            return updateDeviceStatus(userId, hubId, status);\n        },\n        onError: (error) => {\n            // Silently fail - don't spam console with permission errors\n            // Device status monitoring will work locally even if Firestore write fails\n            if (process.env.NODE_ENV === 'development') {\n                // Only log in development if it's not a permission error\n                const isPermissionError = error instanceof Error && error.message.includes('permission');\n                if (!isPermissionError) {\n                    console.warn('Device status update failed:', error);\n                }\n            }\n        },\n    });\n\n    // Subscribe to device status updates\n    useEffect(() => {\n        if (!user || !currentHub) {\n            return;\n        }\n\n        setIsMonitoring(true);\n\n        // Subscribe to device monitor updates\n        const unsubscribe = deviceMonitor.subscribe((status) => {\n            setDeviceStatus(status);\n\n            // Throttle Firestore updates (max once every 30 seconds)\n            const now = Date.now();\n            if (now - lastUpdateTimeRef.current > 30000) {\n                lastUpdateTimeRef.current = now;\n                // Only update if user and hub are still available\n                if (userIdRef.current && hubIdRef.current) {\n                    updateMutation.mutate(status);\n                }\n            }\n        });\n\n        return () => {\n            unsubscribe();\n            setIsMonitoring(false);\n        };\n        // eslint-disable-next-line react-hooks/exhaustive-deps\n    }, [user?.id, currentHub?.id]); // Only depend on IDs, not full objects\n\n    // Get current status synchronously\n    const getCurrentStatus = useCallback(() => {\n        return deviceMonitor.getCurrentStatus();\n    }, []);\n\n    // Check if battery monitoring is supported\n    const isBatterySupported = deviceMonitor.isBatteryMonitoringSupported();\n\n    return {\n        deviceStatus,\n        isMonitoring,\n        isBatterySupported,\n        getCurrentStatus,\n        isLoading: updateMutation.isPending,\n        error: updateMutation.error,\n    };\n};\n","/**\n * Check-in API\n * \n * Firestore operations for location check-ins\n * - Create check-in events at current location\n * - Get check-in history for users\n */\n\nimport {\n    collection,\n    addDoc,\n    getDocs,\n    query,\n    where,\n    orderBy,\n    limit,\n    serverTimestamp,\n    Timestamp,\n} from 'firebase/firestore';\nimport { db } from '@/config/firebase';\nimport type { ApiResponse } from '@/types';\nimport type { LocationCoordinates } from '../services/location-service';\n\nexport interface CheckIn {\n    id: string;\n    hubId: string;\n    userId: string;\n    userName?: string;\n    location: {\n        latitude: number;\n        longitude: number;\n    };\n    accuracy: number;\n    timestamp: Date;\n    note?: string;\n    address?: string;\n}\n\nexport interface CreateCheckInRequest {\n    hubId: string;\n    userId: string;\n    userName?: string;\n    coordinates: LocationCoordinates;\n    note?: string;\n    address?: string;\n}\n\n// Collection references\nconst getCheckInsRef = (hubId: string) =>\n    collection(db, 'hubs', hubId, 'checkIns');\n\n// Convert Firestore data to CheckIn\nconst convertCheckIn = (doc: any): CheckIn => ({\n    id: doc.id,\n    hubId: doc.hubId,\n    userId: doc.userId,\n    userName: doc.userName,\n    location: doc.location,\n    accuracy: doc.accuracy,\n    timestamp: doc.timestamp?.toDate() || new Date(),\n    note: doc.note,\n    address: doc.address,\n});\n\n/**\n * Create a check-in event\n */\nexport const createCheckIn = async (\n    data: CreateCheckInRequest\n): Promise<ApiResponse<CheckIn>> => {\n    try {\n        const { hubId, userId, userName, coordinates, note, address } = data;\n\n        const checkInData = {\n            hubId,\n            userId,\n            userName: userName || null,\n            location: {\n                latitude: coordinates.latitude,\n                longitude: coordinates.longitude,\n            },\n            accuracy: coordinates.accuracy || 0,\n            timestamp: serverTimestamp(),\n            note: note || null,\n            address: address || null,\n        };\n\n        const docRef = await addDoc(getCheckInsRef(hubId), checkInData);\n        const checkIn = convertCheckIn({\n            id: docRef.id,\n            ...checkInData,\n            timestamp: Timestamp.now(),\n        });\n\n        return { success: true, data: checkIn };\n    } catch (error) {\n        console.error('Error creating check-in:', error);\n        return {\n            success: false,\n            error: error instanceof Error ? error.message : 'Failed to create check-in',\n        };\n    }\n};\n\n/**\n * Get check-in history for a user\n */\nexport const getUserCheckIns = async (\n    hubId: string,\n    userId: string,\n    limitCount: number = 50\n): Promise<ApiResponse<CheckIn[]>> => {\n    try {\n        const q = query(\n            getCheckInsRef(hubId),\n            where('userId', '==', userId),\n            orderBy('timestamp', 'desc'),\n            limit(limitCount)\n        );\n\n        const snapshot = await getDocs(q);\n        const checkIns = snapshot.docs.map(convertCheckIn);\n\n        return { success: true, data: checkIns };\n    } catch (error) {\n        console.error('Error getting check-ins:', error);\n        return {\n            success: false,\n            error: error instanceof Error ? error.message : 'Failed to get check-ins',\n            data: [],\n        };\n    }\n};\n\n/**\n * Get all check-ins for a hub\n */\nexport const getHubCheckIns = async (\n    hubId: string,\n    limitCount: number = 100\n): Promise<ApiResponse<CheckIn[]>> => {\n    try {\n        const q = query(\n            getCheckInsRef(hubId),\n            orderBy('timestamp', 'desc'),\n            limit(limitCount)\n        );\n\n        const snapshot = await getDocs(q);\n        const checkIns = snapshot.docs.map(convertCheckIn);\n\n        return { success: true, data: checkIns };\n    } catch (error) {\n        console.error('Error getting hub check-ins:', error);\n        return {\n            success: false,\n            error: error instanceof Error ? error.message : 'Failed to get check-ins',\n            data: [],\n        };\n    }\n};\n\n","/**\n * Geocoding Service\n * \n * Reverse geocoding using Google Maps Geocoding API\n * - Get address from coordinates\n * - Handle errors gracefully\n */\n\nimport { googleMapsLoader } from './google-maps-loader';\n\nexport interface GeocodeResult {\n    address: string;\n    formattedAddress?: string;\n    components?: {\n        street?: string;\n        city?: string;\n        state?: string;\n        country?: string;\n        postalCode?: string;\n    };\n}\n\n/**\n * Reverse geocode coordinates to get address\n */\nexport const reverseGeocode = async (\n    latitude: number,\n    longitude: number\n): Promise<GeocodeResult | null> => {\n    try {\n        // Load Google Maps if not already loaded\n        const google = await googleMapsLoader.load();\n\n        // Create geocoder instance\n        const geocoder = new google.maps.Geocoder();\n\n        // Perform reverse geocoding\n        return new Promise((resolve, reject) => {\n            geocoder.geocode(\n                {\n                    location: { lat: latitude, lng: longitude },\n                },\n                (results, status) => {\n                    if (status === 'OK' && results && results.length > 0) {\n                        const result = results[0];\n                        const addressComponents = result.address_components || [];\n                        \n                        // Extract address components\n                        const components: GeocodeResult['components'] = {};\n                        \n                        addressComponents.forEach((component) => {\n                            const types = component.types;\n                            if (types.includes('street_number') || types.includes('route')) {\n                                components.street = component.long_name;\n                            } else if (types.includes('locality')) {\n                                components.city = component.long_name;\n                            } else if (types.includes('administrative_area_level_1')) {\n                                components.state = component.short_name;\n                            } else if (types.includes('country')) {\n                                components.country = component.short_name;\n                            } else if (types.includes('postal_code')) {\n                                components.postalCode = component.short_name;\n                            }\n                        });\n\n                        // Build formatted address\n                        const formattedAddress = result.formatted_address;\n\n                        // Build simple address string\n                        const addressParts: string[] = [];\n                        if (components.street) addressParts.push(components.street);\n                        if (components.city) addressParts.push(components.city);\n                        if (components.state) addressParts.push(components.state);\n                        const address = addressParts.length > 0 \n                            ? addressParts.join(', ') \n                            : result.formatted_address || `${latitude}, ${longitude}`;\n\n                        resolve({\n                            address,\n                            formattedAddress,\n                            components,\n                        });\n                    } else {\n                        // Geocoding failed - return null (not an error)\n                        console.warn('Reverse geocoding failed:', status);\n                        resolve(null);\n                    }\n                }\n            );\n        });\n    } catch (error) {\n        // Geocoding service not available - return null (not an error)\n        console.warn('Geocoding service not available:', error);\n        return null;\n    }\n};\n\n/**\n * Get a simple address string from coordinates\n * Returns coordinates if geocoding fails\n */\nexport const getAddressFromCoordinates = async (\n    latitude: number,\n    longitude: number\n): Promise<string> => {\n    const result = await reverseGeocode(latitude, longitude);\n    return result?.address || `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;\n};\n\n","/**\n * useCheckIn Hook\n * \n * React hook for location check-ins\n */\n\nimport { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';\nimport { createCheckIn, getUserCheckIns, getHubCheckIns, type CreateCheckInRequest } from '../api/checkin-api';\nimport { useAuth } from '@/features/auth/hooks/useAuth';\nimport { useHubStore } from '@/lib/store/hub-store';\nimport { getAddressFromCoordinates } from '@/lib/services/geocoding-service';\nimport toast from 'react-hot-toast';\n\n/**\n * Hook for creating check-ins\n */\nexport const useCreateCheckIn = () => {\n    const { user } = useAuth();\n    const { currentHub } = useHubStore();\n    const queryClient = useQueryClient();\n\n    const mutation = useMutation({\n        mutationFn: async (data: Omit<CreateCheckInRequest, 'hubId' | 'userId' | 'userName' | 'address'>) => {\n            if (!currentHub?.id || !user?.id) {\n                throw new Error('No hub or user selected');\n            }\n\n            // Try to get address from coordinates (optional, won't fail if it doesn't work)\n            let address: string | undefined;\n            try {\n                address = await getAddressFromCoordinates(\n                    data.coordinates.latitude,\n                    data.coordinates.longitude\n                );\n            } catch (error) {\n                // Address lookup failed - continue without it\n                console.warn('Failed to get address:', error);\n            }\n\n            return createCheckIn({\n                ...data,\n                address,\n                hubId: currentHub.id,\n                userId: user.id,\n                userName: user.email?.split('@')[0] || user.displayName || 'User',\n            });\n        },\n        onSuccess: (result) => {\n            if (result.success) {\n                // Invalidate check-in queries\n                queryClient.invalidateQueries({ queryKey: ['checkIns', currentHub?.id] });\n                queryClient.invalidateQueries({ queryKey: ['checkIns', currentHub?.id, user?.id] });\n                toast.success('Checked in successfully!');\n            } else {\n                toast.error(result.error || 'Failed to check in');\n            }\n        },\n        onError: (error) => {\n            console.error('Error creating check-in:', error);\n            toast.error('Failed to check in');\n        },\n    });\n\n    return {\n        createCheckIn: mutation.mutate,\n        createCheckInAsync: mutation.mutateAsync,\n        isCheckingIn: mutation.isPending,\n        error: mutation.error,\n    };\n};\n\n/**\n * Hook for getting user check-ins\n */\nexport const useUserCheckIns = (userId?: string, limitCount: number = 50) => {\n    const { currentHub } = useHubStore();\n    const { user } = useAuth();\n\n    const targetUserId = userId || user?.id;\n\n    return useQuery({\n        queryKey: ['checkIns', currentHub?.id, targetUserId],\n        queryFn: async () => {\n            if (!currentHub?.id || !targetUserId) {\n                return { success: false, data: [], error: 'No hub or user selected' };\n            }\n            return getUserCheckIns(currentHub.id, targetUserId, limitCount);\n        },\n        enabled: !!currentHub?.id && !!targetUserId,\n        select: (data) => data.success ? data.data : [],\n    });\n};\n\n/**\n * Hook for getting hub check-ins\n */\nexport const useHubCheckIns = (limitCount: number = 100) => {\n    const { currentHub } = useHubStore();\n\n    return useQuery({\n        queryKey: ['checkIns', currentHub?.id],\n        queryFn: async () => {\n            if (!currentHub?.id) {\n                return { success: false, data: [], error: 'No hub selected' };\n            }\n            return getHubCheckIns(currentHub.id, limitCount);\n        },\n        enabled: !!currentHub?.id,\n        select: (data) => data.success ? data.data : [],\n    });\n};\n\n","/**\n * LocationPage (Life360 Style)\n * \n * Map-first interface with overlays\n * - Full-screen map\n * - Member cards overlaid on bottom\n * - Floating action buttons\n * - Hub selector in top bar\n * - Quick access to all features\n */\n\nimport { useState, useEffect } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport { Helmet } from 'react-helmet-async';\nimport { MapView } from '../components/MapView';\nimport { MemberLocationCard } from '../components/MemberLocationCard';\nimport { GeofenceManager } from '../../geofencing/components/GeofenceManager';\nimport { GeofenceMapEditor } from '../../geofencing/components/GeofenceMapEditor';\nimport { GeofenceDetailsModal } from '../../geofencing/components/GeofenceDetailsModal';\nimport { GeofenceAlertToast } from '../../geofencing/components/GeofenceAlertToast';\nimport { NavigationPanel } from '../components/NavigationPanel';\nimport { HubSelector } from '../components/HubSelector';\nimport { useUserLocation, useHubLocations, useHubDeviceStatus } from '../hooks/useLocation';\nimport { useDeviceStatus } from '../hooks/useDeviceStatus';\nimport { useCreateCheckIn } from '../hooks/useCheckIn';\nimport { useGeofences } from '../../geofencing/hooks/useGeofences';\nimport { useHubStore } from '@/lib/store/hub-store';\nimport { useAuth, useUserProfile } from '@/features/auth/hooks/useAuth';\nimport { useHubMembers } from '@/features/tasks/hooks/useHubMembers';\nimport {\n    FiNavigation,\n    FiMapPin,\n    FiCheckCircle,\n    FiSettings,\n    FiShield,\n    FiX,\n    FiMenu,\n    FiUsers,\n} from 'react-icons/fi';\nimport type { GeofenceZone, CreateGeofenceRequest, UpdateGeofenceRequest } from '../../geofencing/types';\nimport toast from 'react-hot-toast';\n\nconst LocationPage = () => {\n    const navigate = useNavigate();\n    const { user } = useAuth();\n    const { currentHub } = useHubStore();\n    const { locations } = useHubLocations(currentHub?.id);\n    const { data: members = [] } = useHubMembers();\n    const { data: currentUserProfile } = useUserProfile(user?.id);\n    const {\n        currentLocation,\n        isSharing,\n        isWatching,\n        error,\n        startTracking,\n        toggleSharing,\n    } = useUserLocation();\n    \n    // Device status monitoring\n    const { deviceStatus: currentUserDeviceStatus } = useDeviceStatus();\n    const { getDeviceStatus } = useHubDeviceStatus(currentHub?.id);\n\n    // Check-in functionality\n    const { createCheckIn, isCheckingIn } = useCreateCheckIn();\n\n    // Geofence management\n    const { createGeofence, updateGeofence, deleteGeofence } = useGeofences();\n\n    // Include current user in locations list if they're sharing\n    // Filter out current user from Firestore locations to avoid duplicates\n    const otherLocations = locations.filter(loc => loc.userId !== user?.id);\n    const allLocations = user && currentLocation && isSharing\n        ? [\n              ...otherLocations,\n              {\n                  userId: user.id,\n                  hubId: currentHub?.id || '',\n                  latitude: currentLocation.latitude,\n                  longitude: currentLocation.longitude,\n                  accuracy: currentLocation.accuracy,\n                  timestamp: new Date(currentLocation.timestamp),\n                  isSharing: true,\n                  lastUpdated: Date.now(), // Use timestamp instead of Date object\n              },\n          ]\n        : otherLocations;\n\n    const [showMemberList, setShowMemberList] = useState(true);\n    const [hasRequestedPermission, setHasRequestedPermission] = useState(false);\n    const [showNavigationPanel, setShowNavigationPanel] = useState(false);\n    \n    // Geofence management state\n    const [showGeofenceManager, setShowGeofenceManager] = useState(false);\n    const [showGeofenceEditor, setShowGeofenceEditor] = useState(false);\n    const [showGeofenceDetails, setShowGeofenceDetails] = useState(false);\n    const [editingGeofence, setEditingGeofence] = useState<GeofenceZone | null>(null);\n    const [selectedGeofence, setSelectedGeofence] = useState<GeofenceZone | null>(null);\n    const { geofences } = useGeofences();\n\n    // Debug: Log state changes\n    useEffect(() => {\n        console.log('[Geofence] State changed:', {\n            showGeofenceManager,\n            showGeofenceEditor,\n            showGeofenceDetails,\n            editingGeofence: editingGeofence?.id,\n            selectedGeofence: selectedGeofence?.id,\n            currentLocation: currentLocation ? { lat: currentLocation.latitude, lng: currentLocation.longitude } : null,\n            currentHub: currentHub?.id,\n        });\n    }, [showGeofenceManager, showGeofenceEditor, showGeofenceDetails, editingGeofence, selectedGeofence, currentLocation, currentHub]);\n\n    // Auto-request location permission when app loads (Life360 style)\n    // This ensures we get location BEFORE showing the map\n    useEffect(() => {\n        if (!hasRequestedPermission && user && currentHub && !isWatching) {\n            setHasRequestedPermission(true);\n            // Request permission and start tracking immediately\n            startTracking();\n        }\n        // eslint-disable-next-line react-hooks/exhaustive-deps\n    }, [user?.id, currentHub?.id]); // Only depend on IDs to prevent re-runs\n\n    return (\n        <>\n            <Helmet>\n                <title>Map - Family Safety App</title>\n                <meta name=\"description\" content=\"Real-time family location map\" />\n            </Helmet>\n\n            {/* Full screen container */}\n            <div className=\"fixed inset-0 flex flex-col bg-gray-50\">\n                {/* Top Header Bar */}\n                <div className=\"absolute top-0 left-0 right-0 z-20 bg-white/95 backdrop-blur-md shadow-sm border-b border-gray-200\">\n                    <div className=\"flex items-center justify-between p-4 safe-top\">\n                        {/* Left: Menu & Hub Selector */}\n                        <div className=\"flex items-center gap-3\">\n                            {/* Hamburger Menu Button */}\n                            <button\n                                onClick={() => setShowNavigationPanel(true)}\n                                className=\"w-10 h-10 bg-white rounded-full shadow-md hover:shadow-lg transition-all duration-200 hover:scale-105 active:scale-95 flex items-center justify-center\"\n                                aria-label=\"Open menu\"\n                            >\n                                <FiMenu size={20} className=\"text-gray-700\" />\n                            </button>\n\n                            {/* Hub Selector */}\n                            <HubSelector />\n                        </div>\n\n                        {/* Right: Action Buttons */}\n                        <div className=\"flex items-center gap-2\">\n                            {/* Settings Button */}\n                            <button\n                                onClick={() => navigate('/settings')}\n                                className=\"w-10 h-10 bg-white rounded-full shadow-md hover:shadow-lg transition-all duration-200 hover:scale-105 active:scale-95 flex items-center justify-center\"\n                                aria-label=\"Settings\"\n                            >\n                                <FiSettings size={20} className=\"text-gray-700\" />\n                            </button>\n                        </div>\n                    </div>\n                </div>\n\n                {/* Map - Always render, even without location */}\n                <div className=\"flex-1 relative\">\n                    {/* Always render map - it will show default location if user location not available */}\n                    <MapView \n                        height=\"100%\" \n                        zoom={13} \n                        showControls={false}\n                        onGeofenceClick={(geofenceId) => {\n                            const geofence = geofences.find(g => g.id === geofenceId);\n                            if (geofence) {\n                                setSelectedGeofence(geofence);\n                                setShowGeofenceDetails(true);\n                            }\n                        }}\n                    />\n\n                    {/* Location loading overlay - only show if no location and no error */}\n                    {!currentLocation && !error && (\n                        <div className=\"absolute top-24 left-1/2 transform -translate-x-1/2 bg-white/95 backdrop-blur-md rounded-xl shadow-lg px-6 py-4 z-20\">\n                            <div className=\"flex items-center gap-3\">\n                                <div className=\"w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center animate-pulse\">\n                                    <FiMapPin size={16} className=\"text-white\" />\n                                </div>\n                                <div>\n                                    <p className=\"text-sm font-semibold text-gray-900\">Finding your location...</p>\n                                    <p className=\"text-xs text-gray-600\">Please allow location access</p>\n                                </div>\n                            </div>\n                        </div>\n                    )}\n\n                    {/* Error message overlay */}\n                    {error && (\n                        <div className=\"absolute top-24 left-1/2 transform -translate-x-1/2 bg-red-50 border border-red-200 rounded-xl shadow-lg px-6 py-4 z-20 max-w-md\">\n                            <p className=\"text-sm text-red-700 font-semibold mb-2\">Location Error</p>\n                            <p className=\"text-xs text-red-600 mb-3\">{error}</p>\n                            <button\n                                onClick={startTracking}\n                                className=\"text-xs font-semibold text-red-700 underline hover:no-underline\"\n                            >\n                                Try Again\n                            </button>\n                        </div>\n                    )}\n\n                    {/* Floating Action Buttons - Always show */}\n                    <div className=\"absolute top-24 right-4 flex flex-col gap-3 z-10\">\n                            {/* Location Sharing Toggle */}\n                            <div className=\"group relative\">\n                                <button\n                                    onClick={toggleSharing}\n                                    className={`w-14 h-14 rounded-full shadow-lg flex items-center justify-center transition-all duration-200 hover:scale-110 active:scale-95 ${isSharing\n                                        ? 'bg-green-500 hover:bg-green-600 text-white shadow-green-200'\n                                        : 'bg-white hover:bg-gray-50 text-gray-700'\n                                        }`}\n                                    aria-label={isSharing ? 'Stop sharing location' : 'Start sharing location'}\n                                >\n                                    <FiMapPin size={24} />\n                                </button>\n                                <div className=\"absolute right-full mr-2 top-1/2 -translate-y-1/2 px-3 py-1.5 bg-gray-900 text-white text-xs font-medium rounded-lg whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none\">\n                                    {isSharing ? 'Sharing Location' : 'Share Location'}\n                                    <div className=\"absolute left-full top-1/2 -translate-y-1/2 border-4 border-transparent border-l-gray-900\"></div>\n                                </div>\n                            </div>\n\n                            {/* Center on My Location */}\n                            <div className=\"group relative\">\n                                <button\n                                    onClick={() => {\n                                        if (!isWatching) {\n                                            startTracking();\n                                        }\n                                    }}\n                                    className=\"w-14 h-14 bg-purple-600 hover:bg-purple-700 rounded-full shadow-lg flex items-center justify-center text-white transition-all duration-200 hover:scale-110 active:scale-95 shadow-purple-200\"\n                                    aria-label=\"Center map on my current location\"\n                                >\n                                    <FiNavigation size={24} />\n                                </button>\n                                <div className=\"absolute right-full mr-2 top-1/2 -translate-y-1/2 px-3 py-1.5 bg-gray-900 text-white text-xs font-medium rounded-lg whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none\">\n                                    Center on Me\n                                    <div className=\"absolute left-full top-1/2 -translate-y-1/2 border-4 border-transparent border-l-gray-900\"></div>\n                                </div>\n                            </div>\n\n                            {/* Geofence Management Button */}\n                            <div className=\"group relative\">\n                                <button\n                                    onClick={() => {\n                                        console.log('[Geofence] Button clicked - Opening geofence manager');\n                                        console.log('[Geofence] Current state:', { showGeofenceManager, showGeofenceEditor, editingGeofence: editingGeofence?.id });\n                                        setShowGeofenceManager(true);\n                                        console.log('[Geofence] State updated - showGeofenceManager set to true');\n                                    }}\n                                    className=\"w-14 h-14 bg-white hover:bg-gray-50 rounded-full shadow-lg flex items-center justify-center text-gray-700 transition-all duration-200 hover:scale-110 active:scale-95\"\n                                    aria-label=\"Open geofence management\"\n                                >\n                                    <FiShield size={24} />\n                                </button>\n                                <div className=\"absolute right-full mr-2 top-1/2 -translate-y-1/2 px-3 py-1.5 bg-gray-900 text-white text-xs font-medium rounded-lg whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none\">\n                                    Geofences\n                                    <div className=\"absolute left-full top-1/2 -translate-y-1/2 border-4 border-transparent border-l-gray-900\"></div>\n                                </div>\n                            </div>\n\n                            {/* Check-In Button */}\n                            <div className=\"group relative\">\n                                <button\n                                    onClick={() => {\n                                        if (!currentLocation || !user || !currentHub) {\n                                            toast.error('Location not available');\n                                            return;\n                                        }\n\n                                        // Create check-in with coordinates\n                                        // Address will be automatically fetched via reverse geocoding in the hook\n                                        createCheckIn({\n                                            coordinates: {\n                                                latitude: currentLocation.latitude,\n                                                longitude: currentLocation.longitude,\n                                                accuracy: currentLocation.accuracy,\n                                                timestamp: currentLocation.timestamp,\n                                                speed: null,\n                                                heading: null,\n                                                altitude: null,\n                                                altitudeAccuracy: null,\n                                            },\n                                            note: `Checked in at ${new Date().toLocaleTimeString()}`,\n                                        });\n                                    }}\n                                    disabled={!currentLocation || isCheckingIn}\n                                    className={`w-14 h-14 rounded-full shadow-lg flex items-center justify-center transition-all duration-200 hover:scale-110 active:scale-95 ${\n                                        !currentLocation || isCheckingIn\n                                            ? 'bg-gray-100 text-gray-400 cursor-not-allowed'\n                                            : 'bg-blue-500 hover:bg-blue-600 text-white shadow-blue-200'\n                                    }`}\n                                    aria-label=\"Check in at current location\"\n                                    title={!currentLocation ? 'Waiting for location...' : 'Check in at current location'}\n                                >\n                                    {isCheckingIn ? (\n                                        <div className=\"w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin\" />\n                                    ) : (\n                                        <FiCheckCircle size={24} />\n                                    )}\n                                </button>\n                                <div className=\"absolute right-full mr-2 top-1/2 -translate-y-1/2 px-3 py-1.5 bg-gray-900 text-white text-xs font-medium rounded-lg whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none\">\n                                    {isCheckingIn ? 'Checking in...' : 'Check In'}\n                                    <div className=\"absolute left-full top-1/2 -translate-y-1/2 border-4 border-transparent border-l-gray-900\"></div>\n                                </div>\n                            </div>\n                        </div>\n\n                </div>\n\n                {/* Bottom Member List Panel - Always show */}\n                <div\n                        className={`absolute left-0 right-0 bg-gradient-to-t from-white via-white to-white/95 backdrop-blur-sm shadow-2xl rounded-t-3xl transition-all duration-300 z-10 bottom-0 ${\n                            showMemberList ? 'translate-y-0' : 'translate-y-full'\n                        }`}\n                    >\n                        {/* Drag Handle */}\n                        <button\n                            onClick={() => setShowMemberList(!showMemberList)}\n                            className=\"w-full py-4 flex justify-center hover:bg-gray-50/50 transition-colors rounded-t-3xl\"\n                            aria-label={showMemberList ? 'Hide member list' : 'Show member list'}\n                        >\n                            <div className=\"w-12 h-1.5 bg-gray-300 rounded-full\"></div>\n                        </button>\n\n                        {/* Header */}\n                        <div className=\"px-6 pb-4\">\n                            <div className=\"flex items-center justify-between\">\n                                <h2 className=\"text-2xl font-bold text-gray-900\">\n                                    Family Members\n                                </h2>\n                                <div className=\"px-4 py-1.5 bg-purple-100 rounded-full\">\n                                    <span className=\"text-sm font-bold text-purple-700\">\n                                        {allLocations.length} online\n                                    </span>\n                                </div>\n                            </div>\n                        </div>\n\n                        {/* Member Cards - Horizontal Scroll */}\n                        <div className=\"px-6 pb-safe\">\n                            {allLocations.length > 0 ? (\n                                <div className=\"flex gap-4 overflow-x-auto pb-6 hide-scrollbar\">\n                                    {allLocations\n                                        .filter((location) => location && location.userId) // Filter out invalid entries\n                                        .map((location) => {\n                                            // Get device status for this user\n                                            const isCurrentUser = location.userId === user?.id;\n                                            const deviceStatus = isCurrentUser\n                                                ? currentUserDeviceStatus\n                                                : getDeviceStatus(location.userId);\n                                            \n                                            // Get member info and photo\n                                            const member = members.find(m => m.userId === location.userId);\n                                            const userPhoto = isCurrentUser \n                                                ? (currentUserProfile?.photoURL || user?.photoURL)\n                                                : member?.photoURL;\n                                            const userName = isCurrentUser\n                                                ? (currentUserProfile?.displayName || user?.displayName || `${user?.email?.split('@')[0] || 'You'} (You)`)\n                                                : (member?.displayName || `User ${location.userId.slice(0, 8)}`);\n                                            \n                                            return (\n                                                <div key={location.userId} className=\"flex-shrink-0 w-80\">\n                                                    <MemberLocationCard\n                                                        location={location}\n                                                        userName={userName}\n                                                        userPhoto={userPhoto}\n                                                        batteryLevel={deviceStatus?.batteryLevel ?? undefined}\n                                                        isOnline={deviceStatus?.isOnline ?? true}\n                                                    />\n                                                </div>\n                                            );\n                                        })}\n                                </div>\n                            ) : (\n                                <div className=\"text-center py-12 pb-safe\">\n                                    <div className=\"w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4\">\n                                        <FiUsers size={36} className=\"text-gray-400\" />\n                                    </div>\n                                    <p className=\"text-gray-700 font-semibold text-lg\">No members sharing location</p>\n                                    <p className=\"text-sm text-gray-500 mt-2\">\n                                        Invite family members to start tracking\n                                    </p>\n                                </div>\n                            )}\n                        </div>\n                    </div>\n            </div>\n\n            {/* Geofence Manager Modal */}\n            {showGeofenceManager && (\n                <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n                    <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto\">\n                        <div className=\"flex items-center justify-between p-6 border-b border-gray-200\">\n                            <h2 className=\"text-2xl font-bold text-gray-900\">Geofence Management</h2>\n                            <button\n                                onClick={() => setShowGeofenceManager(false)}\n                                className=\"p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors\"\n                            >\n                                <FiX size={20} />\n                            </button>\n                        </div>\n                <GeofenceManager\n                    onCreateGeofence={() => {\n                        console.log('[Geofence] onCreateGeofence called - Creating new geofence');\n                        console.log('[Geofence] Current state before update:', { \n                            showGeofenceEditor, \n                            editingGeofence: editingGeofence?.id,\n                            currentLocation,\n                            currentHub: currentHub?.id \n                        });\n                        setEditingGeofence(null);\n                        setShowGeofenceEditor(true);\n                        console.log('[Geofence] State updated - showGeofenceEditor set to true, editingGeofence set to null');\n                    }}\n                    onEditGeofence={(geofence) => {\n                        console.log('[Geofence] onEditGeofence called - Editing geofence:', geofence.id);\n                        console.log('[Geofence] Geofence data:', geofence);\n                        setEditingGeofence(geofence);\n                        setShowGeofenceEditor(true);\n                        console.log('[Geofence] State updated - showGeofenceEditor set to true, editingGeofence set');\n                    }}\n                    onDeleteGeofence={(geofenceId) => {\n                        console.log('[Geofence] onDeleteGeofence called - Deleting geofence:', geofenceId);\n                        deleteGeofence(geofenceId);\n                    }}\n                />\n                    </div>\n                </div>\n            )}\n\n            {/* Geofence Map Editor */}\n            <GeofenceMapEditor\n                isOpen={showGeofenceEditor}\n                onClose={() => {\n                    console.log('[Geofence] Editor onClose called');\n                    setShowGeofenceEditor(false);\n                    setEditingGeofence(null);\n                    console.log('[Geofence] Editor closed - state reset');\n                }}\n                onSave={async (data) => {\n                    console.log('[Geofence] Editor onSave called');\n                    console.log('[Geofence] Save data:', data);\n                    console.log('[Geofence] Editing geofence:', editingGeofence?.id);\n                    try {\n                        if (editingGeofence) {\n                            console.log('[Geofence] Updating existing geofence');\n                            // Update existing geofence\n                            const updateData: UpdateGeofenceRequest = {\n                                id: editingGeofence.id,\n                                name: data.name,\n                                description: data.description,\n                                type: data.type,\n                                center: data.center,\n                                radius: data.radius,\n                                alertOnEntry: data.alertOnEntry,\n                                alertOnExit: data.alertOnExit,\n                                alertRecipients: data.alertRecipients,\n                            };\n                            console.log('[Geofence] Update data:', updateData);\n                            await updateGeofence(updateData);\n                            console.log('[Geofence] Geofence updated successfully');\n                        } else {\n                            console.log('[Geofence] Creating new geofence');\n                            // Create new geofence\n                            const createData: CreateGeofenceRequest = {\n                                name: data.name,\n                                description: data.description,\n                                type: data.type,\n                                center: data.center,\n                                radius: data.radius,\n                                alertOnEntry: data.alertOnEntry,\n                                alertOnExit: data.alertOnExit,\n                                alertRecipients: data.alertRecipients,\n                            };\n                            console.log('[Geofence] Create data:', createData);\n                            await createGeofence(createData);\n                            console.log('[Geofence] Geofence created successfully');\n                        }\n                        setShowGeofenceEditor(false);\n                        setEditingGeofence(null);\n                        console.log('[Geofence] Editor closed after save');\n                    } catch (error) {\n                        console.error('[Geofence] Error saving geofence:', error);\n                        toast.error('Failed to save geofence');\n                    }\n                }}\n                geofence={editingGeofence ? {\n                    name: editingGeofence.name,\n                    description: editingGeofence.description,\n                    type: editingGeofence.type,\n                    center: editingGeofence.center,\n                    radius: editingGeofence.radius,\n                    alertOnEntry: editingGeofence.alertOnEntry,\n                    alertOnExit: editingGeofence.alertOnExit,\n                } : null}\n                initialLocation={currentLocation ? {\n                    latitude: currentLocation.latitude,\n                    longitude: currentLocation.longitude,\n                } : undefined}\n            />\n\n            {/* Geofence Details Modal */}\n            <GeofenceDetailsModal\n                geofence={selectedGeofence}\n                isOpen={showGeofenceDetails}\n                onClose={() => {\n                    setShowGeofenceDetails(false);\n                    setSelectedGeofence(null);\n                }}\n                onEdit={(geofence) => {\n                    setEditingGeofence(geofence);\n                    setShowGeofenceDetails(false);\n                    setShowGeofenceEditor(true);\n                }}\n                onDelete={(geofenceId) => {\n                    deleteGeofence(geofenceId);\n                    setShowGeofenceDetails(false);\n                    setSelectedGeofence(null);\n                }}\n            />\n\n            {/* Geofence Alert Toast */}\n            <GeofenceAlertToast />\n\n            {/* Navigation Panel */}\n            <NavigationPanel\n                isOpen={showNavigationPanel}\n                onClose={() => setShowNavigationPanel(false)}\n            />\n\n            {/* Custom Styles */}\n            <style>{`\n                .hide-scrollbar::-webkit-scrollbar {\n                    display: none;\n                }\n                .hide-scrollbar {\n                    -ms-overflow-style: none;\n                    scrollbar-width: none;\n                }\n                .pb-safe {\n                    padding-bottom: max(env(safe-area-inset-bottom), 1.5rem);\n                }\n                .safe-top {\n                    padding-top: max(env(safe-area-inset-top), 1rem);\n                }\n                @keyframes slide-down {\n                    from {\n                        opacity: 0;\n                        transform: translateY(-10px);\n                    }\n                    to {\n                        opacity: 1;\n                        transform: translateY(0);\n                    }\n                }\n                .animate-slide-down {\n                    animation: slide-down 0.3s ease-out;\n                }\n                @keyframes slide-in-right {\n                    from { transform: translateX(100%); opacity: 0; }\n                    to { transform: translateX(0); opacity: 1; }\n                }\n                .animate-slide-in-right {\n                    animation: slide-in-right 0.3s ease-out;\n                }\n            `}</style>\n        </>\n    );\n};\n\nexport default LocationPage;\n\n"],"names":["async","getGoogleMapsApiKey","secretName","fallbackEnvVar","response","fetch","method","headers","ok","json","value","error","console","warn","envValue","__vite_import_meta_env__","toLowerCase","replace","getSecret","GoogleMapsLoaderService","static","loader","isLoaded","loadPromise","apiKey","constructor","getInstance","instance","getApiKey","this","secretKey","envKey","load","_libraries","Loader","version","libraries","google","isGoogleMapsLoaded","getLoader","googleMapsLoader","locationService","watchId","isWatching","lastKnownPosition","isSupported","navigator","requestPermission","Error","getCurrentPosition","Promise","resolve","reject","geolocation","position","mapPosition","mapError","enableHighAccuracy","timeout","maximumAge","startWatching","onLocation","onError","watchPosition","mappedPosition","code","message","stopWatching","clearWatch","getWatchingStatus","getLastKnownPosition","calculateDistance","coord1","coord2","latitude","Math","PI","longitude","a","sin","cos","atan2","sqrt","coords","accuracy","altitude","altitudeAccuracy","heading","speed","timestamp","updateUserPreferences","userId","preferences","prefsRef","doc","db","setDoc","lastUpdated","Date","merge","success","updateLocationPermission","granted","locationPermissionGranted","useUserLocation","user","useAuth","currentHub","useHubStore","currentLocation","setCurrentLocation","useState","isSharing","setIsSharing","setError","setIsWatching","useEffect","lastPosition","prefsSnap","getDoc","exists","data","locationSharingEnabled","notificationsEnabled","toDate","getUserPreferences","id","then","result","updateMutation","useMutation","mutationFn","coordinates","update","hubId","locationRef","Timestamp","fromMillis","updatedAt","now","historyRef","collection","updateUserLocation","startTracking","useCallback","toast","location","mutate","stopTracking","toggleSharing","newValue","updateLocationSharing","enabled","updateLocationSharingPreference","useHubLocations","locations","setLocations","isLoading","useQuery","queryKey","queryFn","locationsQuery","query","where","snapshot","getDocs","forEach","push","getHubLocations","staleTime","unsubscribe","onUpdate","onSnapshot","subscribeToHubLocations","updatedLocations","length","useHubDeviceStatus","deviceStatuses","setDeviceStatuses","Map","statusCollection","statusQuery","statusMap","set","lastSeen","includes","subscribeToHubDeviceStatus","statuses","getDeviceStatus","get","getGeofencesRef","convertGeofenceZone","isActive","name","description","type","center","radius","createdBy","createdAt","alertOnEntry","alertOnExit","alertRecipients","useGeofences","queryClient","useQueryClient","geofences","refetch","log","q","docs","map","converted","filter","geofence","willInclude","sort","b","getTime","getGeofences","select","selected","createMutation","geofenceData","serverTimestamp","docRef","addDoc","createGeofence","onSuccess","invalidateQueries","refetchQueries","catch","geofenceId","geofenceRef","updateData","updateDoc","geofenceDoc","updateGeofence","deleteMutation","deleteGeofence","mutateAsync","window","confirm","isCreating","isPending","isUpdating","isDeleting","geofenceDetectionService","userStates","detectionCallbacks","isLocationInsideGeofence","lat1","lon1","lat2","lon2","checkGeofenceState","results","isInside","currentState","wasInside","lastEvent","geofenceName","eventType","distance","notifyCallbacks","onDetection","callback","index","indexOf","splice","getUserState","clearUserState","delete","clearAllStates","clear","alertService","notifications","audioContext","isNotificationPermissionGranted","initializeAudioContext","checkNotificationPermission","AudioContext","webkitAudioContext","Notification","permission","requestNotificationPermission","createAlert","alert","random","toString","substr","generateAlertMessage","isRead","unshift","showAlert","body","icon","tag","requireInteraction","playAlertSound","dispatchAlertEvent","oscillator","createOscillator","gainNode","createGain","connect","destination","frequency","setValueAtTime","currentTime","gain","linearRampToValueAtTime","exponentialRampToValueAtTime","start","stop","event","CustomEvent","detail","dispatchEvent","getAlerts","getUnreadAlerts","markAsRead","alertId","find","markAllAsRead","clearOldAlerts","oneDayAgo","getNotificationPermissionStatus","isNotificationSupported","getGeofenceColor","MapView","height","zoom","showControls","onGeofenceClick","members","useHubMembers","mapRef","useRef","googleMapRef","markersRef","infoWindowsRef","currentUserMarkerRef","geofenceCirclesRef","isMapLoaded","setIsMapLoaded","loadError","setLoadError","setTimeout","clearTimeout","current","defaultCenter","lat","lng","maps","mapTypeControl","streetViewControl","fullscreenControl","zoomControl","styles","featureType","elementType","stylers","visibility","errorMessage","LatLng","setCenter","setZoom","g","currentUserPhoto","photoURL","currentUserMember","m","createMarkerIcon","setPosition","setIcon","Marker","title","path","SymbolPath","CIRCLE","scale","fillColor","fillOpacity","strokeColor","strokeWeight","zIndex","imageCache","has","failedImages","loadImage","newIcon","getMap","Circle","strokeOpacity","currentCircles","circle","setMap","existingCircle","setRadius","clickable","addListener","getInitials","split","n","join","toUpperCase","slice","drawInitials","ctx","member","size","fillStyle","fill","font","textAlign","textBaseline","text","displayName","fillText","Set","url","img","Image","crossOrigin","onload","onerror","add","img2","src","isCurrentUser","borderWidth","borderColor","canvas","document","createElement","width","getContext","beginPath","arc","save","clip","imgSize","drawImage","restore","toDataURL","scaledSize","Size","anchor","Point","updateMarker","deviceStatus","existingMarker","timeAgo","floor","timeAgoText","batteryLevel","isOnline","memberPhotoURL","infoContent","role","charAt","round","infoWindow","setContent","marker","animation","Animation","DROP","InfoWindow","content","iw","close","open","validLocations","loc","currentMarkers","currentLocationIds","jsx","className","style","children","jsxs","ref","minHeight","LoadingSpinner","MemberLocationCard","userName","userPhoto","isExpanded","setIsExpanded","onClick","alt","FiMapPin","toFixed","FiClock","date","toMillis","diff","toLocaleDateString","formatTime","level","FiBattery","FiNavigation","GeofenceManager","onEditGeofence","onDeleteGeofence","onCreateGeofence","expandedGeofence","setExpandedGeofence","count","getGeofenceIcon","FiHome","FiBookOpen","FiBriefcase","FiPlus","FiCheckCircle","FiAlertCircle","Fragment","FiToggleRight","FiToggleLeft","FiEdit2","FiTrash2","GeofenceMapEditor","isOpen","onClose","onSave","initialLocation","hasGeofence","circleRef","centerMarkerRef","resizeMarkersRef","clickListenerRef","bestLocation","isPlacementMode","setIsPlacementMode","hasPlacedCenter","setHasPlacedCenter","formData","setFormData","isPlacementModeRef","hasPlacedCenterRef","formDataRef","hasInitializedRef","userActivatedPlacementModeRef","hasInitialized","currentPlacementMode","userActivated","refValue","stateValue","prev","userActivatedPlacementMode","refPlacementMode","createResizeMarkers","hasGoogleMap","hasCircle","clearInstanceListeners","getCenter","getRadius","color","angle","point","geometry","spherical","computeOffset","draggable","optimized","visible","newPosition","getPosition","currentCenter","newRadius","computeDistanceBetween","clampedRadius","max","min","abs","hasClickListener","mapReady","removeListener","e","currentHasPlacedCenter","currentGeofence","currentFormData","hasLatLng","latLng","old","new","setOptions","draggableCursor","centerPos","markerColor","angles","circleColor","shouldBeDraggable","cursor","formDataCenter","hasCenterMarker","setDraggable","circleCenter","setVisible","hasMapRef","isMounted","centerCoords","disableDefaultUI","addListenerOnce","geofenceTypes","label","FiX","FiTarget","onSubmit","preventDefault","trim","onChange","target","placeholder","required","rows","checked","step","parseInt","background","GeofenceDetailsModal","onEdit","onDelete","formatDate","Intl","DateTimeFormat","year","month","day","hour","minute","format","GeofenceAlertToast","alerts","setAlerts","visibleAlerts","setVisibleAlerts","handleGeofenceAlert","newSet","addEventListener","removeEventListener","existingAlerts","getAlertIcon","FiBell","toLocaleTimeString","handleDismiss","NavigationPanel","isFeatureEnabled","navigate","useNavigate","navItems","to","feature","FiCheckSquare","FiMessageCircle","FiLock","FiSettings","item","email","NavLink","FiUsers","signOut","auth","FiLogOut","deviceMonitor","statusCallbacks","currentStatus","batteryMonitor","onlineListener","updateInterval","lastUpdateTime","initializeBatteryMonitoring","initializeOnlineMonitoring","startPeriodicUpdates","getBattery","battery","updateStatus","setInterval","status","isCharging","onLine","platform","getPlatform","connectionType","getConnectionType","charging","ua","userAgent","test","connection","mozConnection","webkitConnection","effectiveType","subscribe","getCurrentStatus","isBatteryMonitoringSupported","destroy","clearInterval","useDeviceStatus","setDeviceStatus","isMonitoring","setIsMonitoring","lastUpdateTimeRef","userIdRef","hubIdRef","statusRef","statusData","updateDeviceStatus","isBatterySupported","createCheckIn","note","address","checkInData","getCheckInsRef","checkIn","convertCheckIn","getAddressFromCoordinates","geocoder","Geocoder","geocode","addressComponents","address_components","components","component","types","street","long_name","city","state","short_name","country","postalCode","formattedAddress","formatted_address","addressParts","reverseGeocode","useCreateCheckIn","mutation","createCheckInAsync","isCheckingIn","LocationPage","currentUserProfile","useUserProfile","currentUserDeviceStatus","otherLocations","allLocations","showMemberList","setShowMemberList","hasRequestedPermission","setHasRequestedPermission","showNavigationPanel","setShowNavigationPanel","showGeofenceManager","setShowGeofenceManager","showGeofenceEditor","setShowGeofenceEditor","showGeofenceDetails","setShowGeofenceDetails","editingGeofence","setEditingGeofence","selectedGeofence","setSelectedGeofence","Helmet","FiMenu","HubSelector","FiShield","disabled","createData"],"mappings":"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"}